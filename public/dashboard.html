<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة المتابعة - ساند</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root{
      --tvtc-blue:#1e3c72;
      --tvtc-teal:#00a49a;
      --tvtc-navy:#0b1f3a;
      --bg-grad:linear-gradient(135deg,var(--tvtc-blue) 0%,var(--tvtc-teal) 100%);
      --card-bg:#fff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
    }
    .dark{
      --bg-grad:linear-gradient(135deg,#0f172a 0%,#0b1f3a 100%);
      --card-bg:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#374151;
    }

    body{
      font-family:'Cairo','Tajawal',sans-serif;
      background:var(--bg-grad);
      min-height:100vh;
      color:var(--text);
      padding:20px;
    }
    .container{ max-width:1400px; margin:0 auto; }

    /* شاشة تسجيل الدخول */
    .login-screen{ display:flex; align-items:center; justify-content:center; min-height:80vh; }
    .login-card{
      background:var(--card-bg);
      padding:40px; border-radius:16px;
      box-shadow:0 20px 40px rgba(0,0,0,0.15);
      width:100%; max-width:450px; text-align:center;
    }
    .login-card h1{ margin-bottom:10px; color:var(--tvtc-blue); font-size:1.8rem; }
    .login-card p{ margin-bottom:30px; color:var(--muted); }
    .form-group{ margin-bottom:20px; text-align:right; }
    .form-group label{ display:block; margin-bottom:8px; font-weight:700; color:var(--muted); }
    .form-control{
      width:100%; padding:12px; border:2px solid var(--border);
      border-radius:8px; font-size:1rem; background:var(--card-bg); color:var(--text);
      transition:border 0.2s;
    }
    .form-control:focus{ outline:none; border-color:var(--tvtc-blue); }
    .btn{
      width:100%; padding:14px; border:none; border-radius:8px;
      font-weight:800; font-size:1rem; cursor:pointer; transition:all 0.2s;
    }
    .btn-primary{ background:linear-gradient(135deg,var(--tvtc-blue),var(--tvtc-teal)); color:#fff; }
    .btn-primary:hover{ transform:translateY(-2px); box-shadow:0 8px 16px rgba(0,0,0,0.15); }
    .btn-primary:disabled{ opacity:0.6; cursor:not-allowed; transform:none; }

    .alert{ padding:12px; border-radius:8px; margin-bottom:20px; font-weight:700; }
    .alert-error{ background:#fee; color:#c00; border:1px solid #fcc; }

    /* الداشبورد */
    .dashboard{ display:none; }
    .dashboard.active{ display:block; }

    .header{
      background:var(--card-bg); padding:20px; border-radius:12px; margin-bottom:20px;
      display:flex; justify-content:space-between; align-items:center;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
    }
    .header-info h1{ font-size:1.5rem; margin-bottom:5px; }
    .header-info p{ color:var(--muted); font-size:0.9rem; }
    .header-actions{ display:flex; gap:10px; }
    .btn-secondary{
      background:#6b7280; color:#fff; padding:10px 16px; border:none; border-radius:8px;
      cursor:pointer; font-weight:700; width:auto;
    }
    .btn-danger{ background:var(--danger); color:#fff; }

    /* بطاقات الإحصائيات */
    .stats-grid{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:30px;
    }
    .stat-card{
      background:var(--card-bg); padding:24px; border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08); border-left:4px solid var(--tvtc-blue);
    }
    .stat-card.success{ border-left-color:var(--success); }
    .stat-card.warning{ border-left-color:var(--warning); }
    .stat-card.danger{ border-left-color:var(--danger); }
    .stat-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .stat-title{ color:var(--muted); font-size:0.9rem; font-weight:600; }
    .stat-icon{ font-size:1.8rem; opacity:0.8; }
    .stat-value{ font-size:2.2rem; font-weight:800; color:var(--text); line-height:1; }

    /* الجداول */
    .table-container{
      background:var(--card-bg); border-radius:12px; padding:20px; margin-bottom:20px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
    }
    .table-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .table-header h2{ font-size:1.3rem; }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:12px; text-align:right; border-bottom:1px solid var(--border); }
    th{ background:#f9fafb; font-weight:700; color:var(--muted); font-size:0.85rem; }
    .dark th{ background:#1f2937; }

    .badge{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:0.75rem; font-weight:700; }
    .badge-success{ background:#d1fae5; color:#065f46; }
    .badge-warning{ background:#fef3c7; color:#92400e; }
    .badge-danger{ background:#fee2e2; color:#991b1b; }

    /* التبويبات */
    .tabs-container{ background:var(--card-bg); border-radius:12px; overflow:hidden; margin-bottom:30px; }
    .tabs-header{
      display:flex; background:#f9fafb; border-bottom:2px solid var(--border);
      gap:0; align-items:center;
    }
    .tab-btn{
      flex:1; padding:16px; background:transparent; border:none; cursor:pointer;
      font-size:1rem; font-weight:700; color:var(--muted); transition:all 0.3s;
      border-bottom:3px solid transparent; margin-bottom:-2px;
    }
    .tab-btn:hover{ background:rgba(30,60,114,0.05); color:var(--tvtc-blue); }
    .tab-btn.active{
      color:var(--tvtc-blue); border-bottom-color:var(--tvtc-blue); background:rgba(30,60,114,0.03);
    }
    .tab-content{ padding:20px; display:none; animation:fadeIn 0.3s; }
    .tab-content.active{ display:block; }
    @keyframes fadeIn{ from{opacity:0.7} to{opacity:1} }

    .loading{ text-align:center; padding:40px; }
    .spinner{
      border:4px solid #f3f3f3; border-top:4px solid var(--tvtc-blue); border-radius:50%;
      width:50px; height:50px; animation:spin 1s linear infinite; margin:0 auto 20px;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    @media (max-width:768px){
      body{ padding:10px; }
      .header{ flex-direction:column; gap:15px; text-align:center; }
      .stats-grid{ grid-template-columns:1fr; }
      table{ font-size:0.85rem; }
      th,td{ padding:8px; }
    }
  </style>

  <!-- مكتبات التصدير -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

  <!-- شاشة تسجيل الدخول -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <h1>🔐 لوحة المتابعة</h1>
      <p>مخصصة للمدربين والإدارة فقط</p>

      <div id="loginError"></div>

      <form id="loginForm" onsubmit="return false;">
        <div class="form-group">
          <label for="staffId">رقم الموظف/المدرب</label>
          <input type="text" id="staffId" class="form-control" placeholder="مثال: T001" required>
        </div>

        <button type="submit" class="btn btn-primary" id="loginBtn" disabled>دخول إلى اللوحة</button>
      </form>

      <!-- روابط مفيدة -->
      <div style="margin-top:12px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
        <a href="index.html?start=1" class="btn-secondary" style="text-decoration:none; display:inline-flex; align-items:center; gap:6px">
          🏠 الرجوع الى مبادرة ساند للمتدربين
        </a>
      </div>
    </div>
  </div>

  <!-- الداشبورد (يظهر فقط بعد تسجيل الدخول) -->
  <div class="dashboard" id="dashboard">
    <div class="container" id="dashboardContainer">

      <!-- الهيدر -->
      <!-- الهيدر -->
      <!-- عبارة ترحيب متلألئة -->
      <div style="background: linear-gradient(135deg, var(--tvtc-blue) 0%, var(--tvtc-teal) 100%); 
                  padding: 24px; border-radius: 12px; margin-bottom: 30px; 
                  box-shadow: 0 4px 15px rgba(0,0,0,0.15); text-align: center;">
        <h2 style="color: white; font-size: 1.8rem; margin: 0; font-weight: 800;
                   animation: shimmer 2s infinite; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
          ✨ مبادرة ساند ✨
        </h2>
        <p style="color: rgba(255,255,255,0.9); margin: 8px 0 0 0; font-size: 1rem;">
          لوحة المتابعة
        </p>
      </div>

      <style>
        @keyframes shimmer {
          0%, 100% {
            opacity: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 0 20px rgba(255,255,255,0.3);
          }
          50% {
            opacity: 0.85;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 0 30px rgba(255,255,255,0.6);
          }
        }
      </style>

      <div class="header">
        <div class="header-info">
          <p>مرحباً، <strong id="instructorName">...</strong> (<span id="instructorRole">...</span>)</p>
        </div>
        <div class="header-actions">
          <a href="./" class="btn-secondary" style="text-decoration:none;display:flex;align-items:center;gap:5px">🏠 الرئيسية</a>
          <a href="index.html?start=1" class="btn-secondary" style="text-decoration:none;display:flex;align-items:center;gap:6px">🏠 ساند</a>
          <button class="btn-secondary" onclick="toggleTheme(this)">🌙</button>
          <button class="btn-secondary" id="exportBtn" onclick="exportToPDF()">📥 تصدير PDF</button>
          <button type="button" class="btn-secondary" onclick="refreshData()">🔄 تحديث</button>
          <button class="btn-secondary btn-danger" onclick="logout()">تسجيل خروج</button>
        </div>
      </div>

      <!-- تبويبات البيانات -->
      <div class="tabs-container">
        <div class="tabs-header">
          <button class="tab-btn active" data-tab="stats" onclick="switchTab('stats')">📊 الإحصائيات</button>
          <button class="tab-btn" data-tab="pending" onclick="switchTab('pending')">⏳ الطلبات المعلقة</button>
          <button class="tab-btn" data-tab="drivers" onclick="switchTab('drivers')">🚗 السائقين</button>
          <button class="tab-btn" data-tab="passengers" onclick="switchTab('passengers')">👨‍🎓 المتدربين المحتاجين</button>
          <button class="tab-btn" data-tab="driverPassengers" onclick="switchTab('driverPassengers')">🔗 السائقين مع المتدربين</button>
        </div>

        <!-- تبويب الإحصائيات -->
        <div class="tab-content active" id="stats" style="display:block;">
          <div style="padding: 30px;">
            <h2 style="text-align: center; margin-bottom: 30px; color: var(--tvtc-blue);">📊 الإحصائيات الشاملة</h2>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-header">
                  <span class="stat-title">إجمالي المستخدمين</span>
                  <span class="stat-icon">👥</span>
                </div>
                <div class="stat-value" id="totalUsers">-</div>
              </div>

              <div class="stat-card success">
                <div class="stat-header">
                  <span class="stat-title">السائقين النشطين</span>
                  <span class="stat-icon">🚗</span>
                </div>
                <div class="stat-value" id="totalDrivers">-</div>
              </div>

              <div class="stat-card warning">
                <div class="stat-header">
                  <span class="stat-title">طلبات معلقة</span>
                  <span class="stat-icon">⏳</span>
                </div>
                <div class="stat-value" id="pendingRequests">-</div>
              </div>

              <div class="stat-card success">
                <div class="stat-header">
                  <span class="stat-title">طلبات مقبولة</span>
                  <span class="stat-icon">✅</span>
                </div>
                <div class="stat-value" id="acceptedRequests">-</div>
              </div>

              <div class="stat-card danger">
                <div class="stat-header">
                  <span class="stat-title">طلبات مرفوضة</span>
                  <span class="stat-icon">❌</span>
                </div>
                <div class="stat-value" id="rejectedRequests">-</div>
              </div>

              <div class="stat-card" style="border-left-color:#8b5cf6;">
                <div class="stat-header">
                  <span class="stat-title">السائقين مع المتدربين</span>
                  <span class="stat-icon">🔗</span>
                </div>
                <div class="stat-value" id="driversWithPassengers">-</div>
              </div>

              <div class="stat-card" style="border-left-color:#f59e0b;">
                <div class="stat-header">
                  <span class="stat-title">متوسط التقييم</span>
                  <span class="stat-icon">⭐</span>
                </div>
                <div class="stat-value" id="avgRating">-</div>
              </div>
            </div>
          </div>
        </div>

        <!-- تبويب الطلبات المعلقة -->
        <div class="tab-content" id="pending" style="display:none;">
          <div class="table-container">
            <div class="table-header">
              <h2>📋 الطلبات المعلقة</h2>
            </div>
            <div id="pendingTable">
              <div class="loading">
                <div class="spinner"></div>
                <p>جاري التحميل...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- تبويب السائقين -->
        <div class="tab-content" id="drivers" style="display:none;">
          <div class="table-container">
            <div class="table-header">
              <h2>🚗 السائقين المسجلين</h2>
            </div>
            <div id="driversTable">
              <div class="loading">
                <div class="spinner"></div>
                <p>جاري التحميل...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- تبويب المتدربين المحتاجين -->
        <div class="tab-content" id="passengers" style="display:none;">
          <div class="table-container">
            <div class="table-header">
              <h2>👨‍🎓 المتدربون المحتاجون إلى توصيل</h2>
            </div>
            <div id="passengersTable">
              <div class="loading">
                <div class="spinner"></div>
                <p>جاري التحميل...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- تبويب السائقين مع المتدربين -->
        <div class="tab-content" id="driverPassengers" style="display:none;">
          <div class="table-container">
            <div class="table-header">
              <h2>🔗 السائقين مع المتدربين</h2>
              <div style="display:flex; gap:10px; align-items:center;">
                <label for="statusFilter" style="font-weight:700; color:var(--muted);">تصفية حسب الحالة:</label>
                <select id="statusFilter" style="padding:8px 12px; border:1px solid var(--border); border-radius:6px; background:var(--card-bg); color:var(--text); cursor:pointer;" onchange="handleFilterChange()">
                  <option value="الكل">الكل</option>
                  <option value="معلق">⏳ معلق</option>
                  <option value="مقبول">✅ مقبول</option>
                  <option value="مرفوض">❌ مرفوض</option>
                </select>
              </div>
            </div>
            <div id="driverPassengersTable">
              <div class="loading">
                <div class="spinner"></div>
                <p>جاري التحميل...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  // ===== متغيرات عامة =====
  let GOOGLE_SCRIPT_URL = '';
  let API_KEY = '';
  let currentInstructor = null;
  let CONFIG_READY = false;

  // ===== مظهر داكن/فاتح =====
  function toggleTheme(btn){
    document.documentElement.classList.toggle('dark');
    if (btn) {
      btn.textContent = document.documentElement.classList.contains('dark') ? '☀️' : '🌙';
    }
  }

  // ===== تصدير PDF =====
  async function exportToPDF(){
    const btn = document.getElementById('exportBtn');
    if (!btn) return;
    btn.disabled = true; btn.textContent = '⏳ جاري التصدير...';
    try{
      if (document.fonts && document.fonts.ready) await document.fonts.ready;
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p','mm','a4');
      const target = document.getElementById('dashboardContainer');
      if (!target) throw new Error('لم يتم العثور على محتوى اللوحة');
      const canvas = await html2canvas(target, { scale: 2, useCORS: true, backgroundColor: null });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const pxToMm = (px) => px * 25.4 / 96;
      const imgWmm = pxToMm(canvas.width);
      const imgHmm = pxToMm(canvas.height);
      const ratio = Math.min(pageW / imgWmm, pageH / imgHmm);
      const renderW = imgWmm * ratio;
      const renderH = imgHmm * ratio;

      let remainingH = renderH, srcYmm = 0;
      while (remainingH > 0) {
        const sliceHmm = Math.min(remainingH, pageH);
        const sliceCanvas = document.createElement('canvas');
        const sliceHpixels = Math.round(sliceHmm / 25.4 * 96 / ratio);
        sliceCanvas.width = canvas.width; sliceCanvas.height = sliceHpixels;
        const sctx = sliceCanvas.getContext('2d');
        const srcYpx = Math.round(srcYmm / 25.4 * 96 / ratio);
        sctx.drawImage(canvas, 0, srcYpx, canvas.width, sliceHpixels, 0, 0, sliceCanvas.width, sliceCanvas.height);
        const sliceImg = sliceCanvas.toDataURL('image/png');
        if (srcYmm > 0) doc.addPage();
        const x = (pageW - renderW) / 2;
        doc.addImage(sliceImg, 'PNG', x, 0, renderW, Math.min(pageH, sliceHmm));
        remainingH -= pageH; srcYmm += pageH;
      }
      const now = new Date();
      doc.save(`sand-report-${now.toISOString().split('T')[0]}.pdf`);
      showToast('تم تصدير التقرير بنجاح','success');
    }catch(err){
      console.error('Export error:', err);
      showToast('فشل التصدير','error');
    }finally{
      btn.disabled = false; btn.textContent = '📥 تصدير PDF';
    }
  }



  // ===== Toast =====
  function showToast(msg, type='info'){
    const toast = document.createElement('div');
    toast.style.cssText = `
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      background:${type==='success' ? '#10b981' : type==='error' ? '#ef4444' : '#6b7280'};
      color:white; padding:12px 24px; border-radius:8px; font-weight:700; z-index:10000;
    `;
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(()=>{ toast.style.opacity='0'; setTimeout(()=>toast.remove(),300); },3000);
  }

  // ===== تحميل الإعدادات =====
  async function loadConfig(){
    try{
      const res = await fetch('config.json?ts=' + Date.now(), { cache:'no-store' });
      if (!res.ok) throw new Error('CONFIG_NOT_FOUND');
      const raw = await res.text();
      if (raw.trim().startsWith('<')) throw new Error('CONFIG_INVALID_FORMAT');
      const cfg = JSON.parse(raw);
      GOOGLE_SCRIPT_URL = cfg.GOOGLE_SCRIPT_URL || cfg.SCRIPT_URL || '';
      API_KEY = cfg.API_KEY || cfg.apiKey || '';
      if (!GOOGLE_SCRIPT_URL) throw new Error('MISSING_GOOGLE_SCRIPT_URL');
      CONFIG_READY = true;
    }catch(e){
      console.error('Config error:', e);
      document.getElementById('loginError').innerHTML =
        '<div class="alert alert-error">⚠️ تعذّر تحميل الإعدادات (config.json). تأكّد من المسار/الاستضافة.</div>';
    }finally{
      document.getElementById('loginBtn')?.removeAttribute('disabled');
    }
  }

  // ===== إرسال طلب للخلفية =====
  async function sendRequest(action, data = {}){
    if (!GOOGLE_SCRIPT_URL) throw new Error('MISSING_CONFIG');
    const resp = await fetch(GOOGLE_SCRIPT_URL, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain' },
      body: JSON.stringify({ action, data, ...(API_KEY ? { key: API_KEY } : {}) })
    });
    if (!resp.ok) throw new Error('HTTP_'+resp.status);
    const text = await resp.text();
    if (text.trim().startsWith('<')) throw new Error('INVALID_JSON');
    try{ return JSON.parse(text); }catch{ throw new Error('INVALID_JSON'); }
  }

  // تشغيل تحميل الإعدادات عند فتح الصفحة
  document.addEventListener('DOMContentLoaded', loadConfig);

  // ===== تبديل التبويبات =====
  function switchTab(tabName){
    const tabs = document.querySelectorAll('.tab-content');
    const btns = document.querySelectorAll('.tab-btn');
    
    tabs.forEach(tab => {
      tab.classList.remove('active');
      tab.style.display = 'none';
    });
    btns.forEach(btn => btn.classList.remove('active'));
    
    const activeTab = document.getElementById(tabName);
    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    
    if(activeTab) {
      activeTab.classList.add('active');
      activeTab.style.display = 'block';
    }
    if(activeBtn) activeBtn.classList.add('active');
  }

  // ===== تسجيل الدخول =====
  document.getElementById('loginForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const errorDiv = document.getElementById('loginError');
    errorDiv.innerHTML = '';

    if (!CONFIG_READY){
      errorDiv.innerHTML = '<div class="alert alert-error">⚠️ الإعدادات غير جاهزة. تأكّد من <strong>config.json</strong> وأنك تشغّل عبر سيرفر (مو file://).</div>';
      return;
    }

    const staffId = document.getElementById('staffId').value.trim();
    const btn = document.getElementById('loginBtn');
    if (!staffId){
      errorDiv.innerHTML = '<div class="alert alert-error">أدخل رقم الموظف</div>';
      return;
    }

    btn.disabled = true; btn.textContent = 'جاري التحقق...';

    try{
      const resp = await sendRequest('verifyInstructor', { staffId });
      console.log('verifyInstructor →', resp);
      if (resp?.success && resp?.data?.authorized){
        currentInstructor = resp.data;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
        document.getElementById('instructorName').textContent = resp.data.name || 'مستخدم';
        document.getElementById('instructorRole').textContent = (resp.data.role === 'admin' ? 'مدير' : 'مراقب');
        loadDashboardData().catch(()=>{});
      }else{
        errorDiv.innerHTML = '<div class="alert alert-error">⛔ غير مصرح لك بالدخول</div>';
      }
    }catch(e){
      console.error(e);
      const msg =
        e.message === 'MISSING_CONFIG' ? 'إعدادات الاتصال غير متوفّرة' :
        e.message?.startsWith('HTTP_') ? 'خطأ في الخادم' :
        e.message === 'INVALID_JSON' ? 'الاستجابة ليست JSON (تحقق من رابط السكربت/CORS)' :
        'خطأ في الاتصال';
      errorDiv.innerHTML = `<div class="alert alert-error">❌ ${msg}</div>`;
    }finally{
      btn.disabled = false; btn.textContent = 'دخول إلى اللوحة';
    }
  });

  // ===== تحميل بيانات الداشبورد =====
  async function loadDashboardData(){
    try{
      const resp = await sendRequest('getDashboardStats');
      if (resp.success){
        const data = resp.data || {};
        document.getElementById('totalUsers').textContent = data.totalUsers || 0;
        document.getElementById('totalDrivers').textContent = data.totalDrivers || 0;
        document.getElementById('pendingRequests').textContent = data.pendingRequests || 0;
        document.getElementById('acceptedRequests').textContent = data.acceptedRequests || 0;
        document.getElementById('rejectedRequests').textContent = data.rejectedRequests || 0;
        document.getElementById('avgRating').textContent = data.avgRating || '-';
      }

      // حساب عدد السائقين مع المتدربين
      try{
        const allResp = await sendRequest('getAllRequests');
        if (allResp.success && allResp.data){
          const acceptedOnly = allResp.data.filter(r => r.status === 'مقبول');
          const uniquePairs = new Set(
            acceptedOnly.map(r => `${r.driverTraineeId}-${r.passengerTraineeId}`)
          );
          document.getElementById('driversWithPassengers').textContent = uniquePairs.size || 0;
        }
      }catch(e){
        console.error('Error calculating pairs:', e);
        document.getElementById('driversWithPassengers').textContent = 0;
      }

      loadPendingRequests();
      loadDriversList();
      loadPassengersList();
      loadDriverPassengers();
    }catch(e){
      console.error('Load error:', e);
    }
  }

  // ===== الطلبات المعلقة =====
  async function loadPendingRequests(){
    const container = document.getElementById('pendingTable');
    try{
      const resp = await sendRequest('getPendingRequests');
      if (resp.success && resp.data.length){
        let html = '<table><thead><tr><th>رقم الطلب</th><th>المتدرب</th><th>السائق</th><th>الأيام</th><th>الحالة</th></tr></thead><tbody>';
        resp.data.forEach(r=>{
          html += `<tr>
            <td>#${r.id}</td>
            <td>${r.passengerName}</td>
            <td>${r.driverName}</td>
            <td>${Array.isArray(r.selectedDays) ? r.selectedDays.join('، ') : '-'}</td>
            <td><span class="badge badge-warning">معلق</span></td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      }else{
        container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">لا توجد طلبات معلقة</p>';
      }
    }catch(e){
      container.innerHTML = '<p style="text-align:center;color:var(--danger)">خطأ في التحميل</p>';
    }
  }

  // ===== السائقون =====
  async function loadDriversList(){
    const container = document.getElementById('driversTable');
    try{
      const resp = await sendRequest('getDrivers');
      if (resp.success && resp.data.length){
        let html = '<table><thead><tr><th>الاسم</th><th>رقم المتدرب</th><th>الحي</th><th>التقييم</th><th>الحالة</th></tr></thead><tbody>';
        resp.data.forEach(d=>{
          const status = d.status === 'متاح' ? 'متاح' : 'محجوز';
          const badge  = d.status === 'متاح' ? 'badge-success' : 'badge-warning';
          html += `<tr>
            <td>${d.name}</td>
            <td>${d.traineeId}</td>
            <td>${d.neighborhood || '-'}</td>
            <td>${d.rating || 0} ⭐</td>
            <td><span class="badge ${badge}">${status}</span></td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      }else{
        container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">لا يوجد سائقين</p>';
      }
    }catch(e){
      container.innerHTML = '<p style="text-align:center;color:var(--danger)">خطأ في التحميل</p>';
    }
  }

  // ===== معالج تغيير الفلتر مع Loading =====
  function handleFilterChange(){
    const statusFilter = document.getElementById('statusFilter');
    const container = document.getElementById('driverPassengersTable');
    
    // عطل الفلتر مؤقتاً
    statusFilter.disabled = true;
    statusFilter.style.opacity = '0.6';
    statusFilter.style.cursor = 'not-allowed';
    
    // أظهر رسالة جاري التحديث
    container.innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        <p>جاري تحديث البيانات...</p>
      </div>
    `;
    
    // استدعِ الدالة الرئيسية
    loadDriverPassengers().then(() => {
      // أعد تفعيل الفلتر بعد الانتهاء
      statusFilter.disabled = false;
      statusFilter.style.opacity = '1';
      statusFilter.style.cursor = 'pointer';
    }).catch(err => {
      console.error('Error:', err);
      statusFilter.disabled = false;
      statusFilter.style.opacity = '1';
      statusFilter.style.cursor = 'pointer';
    });
  }

  // ===== السائقين مع المتدربين =====
  async function loadDriverPassengers(){
    const container = document.getElementById('driverPassengersTable');
    
    try{
      const resp = await sendRequest('getDriversWithPassengers');
      
      if (!resp.success) {
        container.innerHTML = '<p style="text-align:center;color:var(--danger)">خطأ في التحميل</p>';
        return;
      }

      const drivers = resp.data || [];
      
      // فلترة السائقين الذين لديهم متدربين فقط
      const driversWithPassengers = drivers.filter(d => d.passengers && d.passengers.length > 0);

      if (driversWithPassengers.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">لا يوجد سائقين مرتبطين بمتدربين حالياً</p>';
        return;
      }

      // بناء الـ HTML
      let html = '<div style="display:grid; gap:20px;">';
      
      // مصفوفة ألوان جميلة ومتنوعة
      const colors = [
        { bg: '#e8f4f8', border: '#00a49a', light: '#d1f4f0' },
        { bg: '#e3f2fd', border: '#1e3c72', light: '#bbdefb' },
        { bg: '#f3e5f5', border: '#8b5cf6', light: '#ede7f6' },
        { bg: '#fff3e0', border: '#f59e0b', light: '#ffe0b2' },
        { bg: '#f1f8e9', border: '#66bb6a', light: '#dcedc8' },
        { bg: '#fce4ec', border: '#ec407a', light: '#f8bbd0' },
        { bg: '#eceff1', border: '#78909c', light: '#cfd8dc' }
      ];
      
      driversWithPassengers.forEach((driver, driverIndex) => {
        const passengers = driver.passengers || [];
        const color = colors[driverIndex % colors.length];
        const driverNumber = driverIndex + 1;
        
        html += `<div style="
          border-left: 5px solid ${color.border};
          background-color: ${color.bg};
          border-radius: 8px;
          padding: 20px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          position: relative;
        ">
          <!-- رقم السائق -->
          <div style="
            position: absolute;
            top: 10px;
            right: 15px;
            background: ${color.border};
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.2rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
          ">
            ${driverNumber}
          </div>

          <h3 style="
            margin-top: 10px;
            margin-bottom: 12px;
            color: ${color.border};
            font-size: 1.3rem;
            font-weight: 800;
            padding-right: 50px;
          ">🚗 ${driver.name || '-'}</h3>

          <p style="
            margin: 8px 0;
            color: ${color.border};
            font-weight: 600;
            font-size: 0.95rem;
          "><strong>🆔 رقم السائق:</strong> ${driver.traineeId || '-'}</p>

          <p style="
            margin: 8px 0;
            color: ${color.border};
            font-weight: 600;
            font-size: 0.95rem;
          "><strong>📍 الحي:</strong> ${driver.neighborhood || '-'}</p>

          <p style="
            margin: 8px 0;
            color: ${color.border};
            font-weight: 600;
            font-size: 0.95rem;
          "><strong>👥 عدد المتدربين:</strong> ${passengers.length}</p>`;
        
        if(passengers.length > 0){
          html += `<div style="
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px solid ${color.border};
            opacity: 0.9;
          ">
            <strong style="color: ${color.border}; font-size: 1rem;">📋 المتدربين:</strong>
            <ul style="margin-top: 12px; list-style: none; padding: 0;">`;
          
          passengers.forEach((p, idx) => {
            const days = Array.isArray(p.selectedDays) ? p.selectedDays.join('، ') : p.selectedDays || '-';
            
            // حساب متوسط التقييم
            let avgRating = 0;
            let ratingDisplay = '';
            if (p.ratings && p.ratings.length > 0) {
              const totalStars = p.ratings.reduce((sum, r) => sum + (Number(r.stars) || 0), 0);
              avgRating = (totalStars / p.ratings.length).toFixed(1);
              const stars = '⭐'.repeat(Math.round(avgRating));
              ratingDisplay = `<div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.6); border-radius: 4px;">
                <strong style="color: ${color.border};">⭐ التقييم:</strong> ${stars} (${avgRating}/5)
                <div style="margin-top: 6px; font-size: 0.8rem;">`;
              
              p.ratings.forEach((rating, rIdx) => {
                const ratingStars = '⭐'.repeat(Number(rating.stars) || 0);
                const notes = rating.notes ? `<br><em style="color: #666;">"${rating.notes}"</em>` : '';
                ratingDisplay += `<div style="padding: 4px 0; border-bottom: 1px solid ${color.border}20;">
                  ${ratingStars} ${notes}
                </div>`;
              });
              
              ratingDisplay += '</div></div>';
            } else {
              ratingDisplay = `<div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.4); border-radius: 4px; font-size: 0.85rem; color: #666;">
                <em>لم يتم تقييم السائق بعد</em>
              </div>`;
            }
            
            html += `<li style="
              padding: 12px;
              margin: 8px 0;
              background: ${color.light};
              border-radius: 6px;
              color: var(--text);
              border-right: 3px solid ${color.border};
            ">
              <div style="display: flex; gap: 10px; align-items: start;">
                <span style="font-weight: 800; color: ${color.border}; font-size: 1.2rem;">${idx + 1}.</span>
                <div style="flex: 1;">
                  <strong style="color: ${color.border};">${p.name || p.passengerName}</strong> (${p.traineeId || p.studentId})
                  <br><span style="font-size: 0.85rem; color: ${color.border}; font-weight: 600;">📅 الأيام: ${days}</span>
                  ${ratingDisplay}
                </div>
              </div>
            </li>`;
          });
          
          html += '</ul></div>';
        }
        
        html += '</div>';
      });
      html += '</div>';
      container.innerHTML = html;

    }catch(e){
      console.error('Driver passengers error:', e);
      container.innerHTML = '<p style="text-align:center;color:var(--danger)">خطأ في التحميل</p>';
    }
  }

  // ===== المتدربون المحتاجون إلى توصيل =====
  async function loadPassengersList(){
    const container = document.getElementById('passengersTable');
    try{
      const resp = await sendRequest('getPassengersNeedingRide'); // وفّر الإجراء في السكربت الخلفي
      if (resp.success && Array.isArray(resp.data) && resp.data.length){
        let html = '<table><thead><tr>' +
                    '<th>الاسم</th><th>رقم المتدرب</th><th>الحي</th>' +
                    '<th>الأيام/الأوقات المفضلة</th><th>الحالة</th>' +
                   '</tr></thead><tbody>';
        resp.data.forEach(p=>{
          const name   = p.name || p.passengerName || 'بدون اسم';
          const id     = p.traineeId || p.studentId || '-';
          const hood   = p.neighborhood || p.district || '-';
          const days   = Array.isArray(p.preferredDays) ? p.preferredDays.join('، ')
                       : Array.isArray(p.selectedDays)  ? p.selectedDays.join('، ')
                       : (p.days || p.preferredTimes || '-');
          const status = p.status || 'بانتظار التوصيل';
          const badge  = status.includes('انتظار') || status.includes('بانتظار') ? 'badge-warning'
                       : status.includes('مؤكد') || status.includes('جاري')       ? 'badge-success'
                       : 'badge-danger';
          html += `<tr>
            <td>${name}</td>
            <td>${id}</td>
            <td>${hood}</td>
            <td>${days}</td>
            <td><span class="badge ${badge}">${status}</span></td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      }else{
        container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">لا يوجد متدربون بحاجة إلى توصيل حالياً</p>';
      }
    }catch(e){
      console.error('Passengers load error:', e);
      container.innerHTML = '<p style="text-align:center;color:var(--danger)">خطأ في التحميل</p>';
    }
  }

  // ===== تحديث البيانات =====
      async function refreshData(){
    try{
      console.log('🔄 refresh clicked');
      await loadDashboardData(); // انتظر اكتمال التحديث
      showToast('تم تحديث البيانات','success');
    }catch(err){
      console.error('Refresh error:', err);
      showToast('تعذّر التحديث','error');
    }
  }

  // ===== تسجيل الخروج =====
  function logout(){
    currentInstructor = null;
    document.getElementById('dashboard').classList.remove('active');
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('staffId').value = '';
  }
</script>
</body>
</html>
