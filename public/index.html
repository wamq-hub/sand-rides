<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø³Ø§Ù†Ø¯ - Ù†Ø¸Ø§Ù… ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
        :root{
      --bg-grad: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --card-bg: #fff;
      --text: #1f2937;
      --muted: #495057;
      --border: #e9ecef;
      --header-grad: linear-gradient(135deg,#2c5aa0 0%,#1e3c72 100%);
      --chip-ok-bg:#d4edda; --chip-ok-text:#155724;
      --chip-warn-bg:#fff3cd; --chip-warn-text:#856404;
      --chip-bad-bg:#f8d7da; --chip-bad-text:#721c24;
    }
    .dark{
      --bg-grad: linear-gradient(135deg,#0f172a 0%,#111827 100%);
      --card-bg: #111827;
      --text: #e5e7eb;
      --muted: #cbd5e1;
      --border: #374151;
      --header-grad: linear-gradient(135deg,#1f2937 0%,#111827 100%);
      --chip-ok-bg:#064e3b; --chip-ok-text:#a7f3d0;
      --chip-warn-bg:#92400e; --chip-warn-text:#fde68a;
      --chip-bad-bg:#7f1d1d; --chip-bad-text:#fecaca;
    }
    body{font-family:'Segoe UI','Tahoma',sans-serif;background:var(--bg-grad);min-height:100vh;padding:20px;color:var(--text)}
        .field-hint{font-size:.85rem;margin-top:6px}
    .field-hint.neutral{color:#6b7280}     /* Ø±Ù…Ø§Ø¯ÙŠ */
    .field-hint.good{color:#16a34a}        /* Ø£Ø®Ø¶Ø± */
    .field-hint.warn{color:#b45309}        /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
    .container{background:var(--card-bg)}
    .header{background:var(--header-grad);color:#fff}
    .form-group label{color:var(--muted)}
    .form-control{border-color:var(--border);background:var(--card-bg);color:var(--text)}
    .driver-card,.request-card{background:linear-gradient(135deg,rgba(248,249,250,.25) 0%, var(--card-bg) 100%);border:2px solid var(--border)}
    .status-available,.status-accepted{background:var(--chip-ok-bg);color:var(--chip-ok-text)}
    .status-pending{background:var(--chip-warn-bg);color:var(--chip-warn-text)}
    .status-booked,.status-rejected{background:var(--chip-bad-bg);color:var(--chip-bad-text)}
    .container{max-width:1200px;margin:0 auto;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}
    .header-bar{display:flex;align-items:center;gap:12px;justify-content:space-between}
    .logo-wrap{display:flex;align-items:center;gap:12px}
    .logo{font-size:1.9rem;font-weight:800}
    .tagline{opacity:.9;font-size:.95rem}
    .user-info{display:flex;align-items:center;gap:10px}
    .user-name{font-weight:700}
    .role-badge{background:#0ea5e9;color:#fff;padding:4px 10px;border-radius:999px;font-size:.85rem}
    .logout-btn{background:#ef4444;color:#fff;border:none;border-radius:8px;padding:8px 14px;font-weight:700;cursor:pointer;transition:all 0.2s}
    .logout-btn:hover{background:#dc2626}
    .stats-bar{display:flex;justify-content:center;gap:28px;margin-top:10px}
    .stat-item{text-align:center}
    .stat-number{font-size:1.2rem;font-weight:700}
    .stat-label{font-size:.85rem;opacity:.95}
    .login-section{padding:35px;background:linear-gradient(135deg,#f8f9fa 0%,#ffffff 100%);border-bottom:1px solid #e9ecef}
    .login-container{max-width:520px;margin:0 auto;text-align:center}
    .welcome-message{font-size:1.15rem;color:#2c5aa0;margin-bottom:18px;font-weight:700}
    .login-form{display:none;animation:fade .45s}
    .login-form.active{display:block}
    .tabs{display:none;background:#f8f9fa;border-bottom:1px solid #dee2e6}
    .tabs.active{display:flex;flex-wrap:wrap}
    .tab{flex:1;padding:14px 10px;text-align:center;cursor:pointer;transition:.2s;background:#fff;border:0;font-size:1.02rem;font-weight:700;color:#495057}
    .tab:hover{background:#e9ecef}
    .tab.active{background:#2c5aa0;color:#fff}
    .content{padding:22px;min-height:440px;display:none}
    .content.active{display:block}
    @keyframes fade{from{opacity:.3;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .form-group{margin-bottom:16px}
    .form-control{width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-size:1rem;transition:border-color 0.2s;background:var(--card-bg);color:var(--text)}
    .form-control:focus{outline:none;border-color:#2c5aa0;box-shadow:0 0 0 3px rgba(44,90,160,.12)}
    .btn{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);color:#fff;padding:12px 20px;border:none;border-radius:8px;font-weight:800;cursor:pointer;transition:.2s;text-decoration:none;display:inline-block}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,.15)}
    .btn:disabled{background:#6c757d;cursor:not-allowed;transform:none;opacity:0.6}
    .btn-primary{background:linear-gradient(135deg,#2c5aa0 0%,#1e3c72 100%)}
    .btn-whatsapp{background:linear-gradient(135deg,#25d366 0%,#128c7e 100%);margin-inline:6px;padding:10px 16px;font-size:.92rem}
    .btn-accept{background:linear-gradient(135deg,#4caf50 0%,#45a049 100%)}
    .btn-reject{background:linear-gradient(135deg,#f44336 0%,#d32f2f 100%)}
    .btn-contact{background:linear-gradient(135deg,#2196f3 0%,#1976d2 100%)}
    .driver-card,.request-card{background:linear-gradient(135deg,rgba(248,249,250,.25) 0%, var(--card-bg) 100%);border:2px solid var(--border);border-radius:12px;padding:18px;margin-bottom:14px;transition:.2s}
    .driver-card:hover,.request-card:hover{border-color:#2c5aa0;transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .request-card{border-color:#ffcc02;background:linear-gradient(135deg,#fff8e1 0%,#ffffff 100%)}
    .request-card.accepted{border-color:#4caf50;background:linear-gradient(135deg,#e8f5e8 0%,#ffffff 100%)}
    .request-card.rejected{border-color:#f44336;background:linear-gradient(135deg,#ffebee 0%,#ffffff 100%)}
    .driver-info,.request-header{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center;margin-bottom:10px}
    .driver-details h3,.request-title{color:#2c5aa0;margin-bottom:6px;font-size:1.06rem}
    .driver-details p,.request-details p{margin-bottom:4px;color:#555}
    .rating{color:#ffc107}
    .status-available,.status-accepted{background:#d4edda;color:#155724;padding:4px 10px;border-radius:18px;font-size:.85rem;font-weight:800}
    .status-booked,.status-rejected{background:#f8d7da;color:#721c24;padding:4px 10px;border-radius:18px;font-size:.85rem;font-weight:800}
    .status-pending{background:#fff3cd;color:#856404;padding:4px 10px;border-radius:18px;font-size:.85rem;font-weight:800}
    .dashboard-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin:16px 0}
    .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:16px;border-radius:12px;text-align:center}
    .stat-card .stat-number{font-size:1.7rem;margin-bottom:6px}
    .alert{padding:12px;border-radius:8px;margin-bottom:14px}
    .alert-success{background:#d4edda;border:1px solid #c3e6cb;color:#155724}
    .alert-info{background:#cce7ff;border:1px solid #99d6ff;color:#0c5460}
    .alert-warning{background:#fff3cd;border:1px solid #ffeaa7;color:#856404}
    .alert-error{background:#f8d7da;border:1px solid #f5c2c7;color:#721c24}
    .loading{text-align:center;padding:16px}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #2c5aa0;border-radius:50%;width:34px;height:34px;animation:spin 1s linear infinite;margin:0 auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .checkbox-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:6px}
    .checkbox-item{display:flex;align-items:center;gap:8px}
    .notification-badge{position:absolute;top:-6px;right:-6px;background:#dc3545;color:#fff;border-radius:50%;width:20px;height:20px;font-size:.8rem;display:flex;align-items:center;justify-content:center}
    .back-to-selection{margin-bottom:15px}
    .btn-secondary{background:linear-gradient(135deg,#6c757d 0%,#495057 100%);color:#fff}
    .connbar{display:flex;align-items:center;gap:10px;justify-content:center;background:#0b132b;color:#fff;padding:10px;margin-top:10px;border-radius:12px}
    .conn-dot{width:10px;height:10px;border-radius:50%}
    .conn-online{background:#22c55e}
    .conn-connecting{background:#f59e0b}
    .conn-offline{background:#ef4444}
    .conn-text{font-weight:700}
          .tab.badged{position:relative}
      .tab.badged .badge{
        position:absolute;top:6px;inset-inline-end:10px;
        background:#ef4444;color:#fff;min-width:20px;height:20px;
        padding:0 6px;border-radius:999px;font-size:.8rem;
        display:flex;align-items:center;justify-content:center;
        font-weight:800;
      }
    @media (max-width:768px){
      .tabs{flex-direction:column}
      .driver-info,.request-header{grid-template-columns:1fr}
      .header-bar{flex-direction:column;align-items:flex-start;gap:8px}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-bar">
        <div class="logo-wrap">
          <div>
            <div class="logo">ğŸš— Ø³Ø§Ù†Ø¯</div>
            <div class="tagline">Ù…Ù†ØµØ© ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø§Ù„ØªØ·ÙˆØ¹ÙŠØ©</div>
          </div>
        </div>
        <div class="user-info" id="topUserInfo" style="display:none">
          <span class="user-name" id="userName" aria-live="polite">...</span>
          <span class="role-badge" id="userRole">Ø±Ø§ÙƒØ¨</span>
          <button class="logout-btn" id="logoutBtn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
        <button class="logout-btn" id="themeToggleBtn" type="button" style="background:#111827">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</button>
      </div>
      <div class="stats-bar">
        <div class="stat-item"><div class="stat-number" id="totalUsersHeader">-</div><div class="stat-label">Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø´Ø·</div></div>
        <div class="stat-item"><div class="stat-number" id="totalTripsHeader">-</div><div class="stat-label">Ø±Ø­Ù„Ø© Ù…ÙƒØªÙ…Ù„Ø©</div></div>
        <div class="stat-item"><div class="stat-number" id="satisfactionHeader">-</div><div class="stat-label">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø©</div></div>
      </div>
    </div>

    <!-- Login -->
    <div class="login-section" id="loginSection">
      <div class="login-container">
        <div class="welcome-message">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø³Ø§Ù†Ø¯ ğŸ‘‹</div>

        <!-- Login Form (Visible by default) -->
        <div class="login-form active" id="loginForm" aria-hidden="false">
          <div class="form-group">
            <label for="loginTraineeId">Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨</label>
            <input type="text" id="loginTraineeId" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 4461XXXX" required>
            <small id="loginIdHint" class="field-hint neutral">
            ØªÙ†ÙˆÙŠÙ‡: Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ø¹Ø§Ø¯Ø©Ù‹ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 4451 Ø£Ùˆ 4461
            </small>

          </div>
              <div class="alert alert-info">
                <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù…Ùƒ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†. 
                Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ ÙÙ„Ù† ÙŠÙØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆÙŠÙØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©.
              </div>
          <button class="btn btn-primary" id="loginBtn" type="button">Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø³Ø§Ù†Ø¯</button>
        </div>
      </div>
    </div>



    <!-- Tabs -->
    <div class="tabs" id="tabsContainer">
      <button class="tab active" data-tab="home" type="button">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="tab badged" data-tab="requests" id="requestsTab" type="button">
  ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙŠ <span class="badge" id="requestsBadge" style="display:none">0</span>
</button>
      <button class="tab" data-tab="drivers" type="button">ğŸš— Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</button>
      <button class="tab" data-tab="book" type="button">â• Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯</button>
      <button class="tab" data-tab="rate" type="button">â­ ØªÙ‚ÙŠÙŠÙ…</button>
      <button class="tab" data-tab="register" type="button">ğŸ‘¥ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
    </div>

    <!-- Home -->
    <div class="content active" id="homeContent">
      <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="homeUserName">...</span> ğŸ‘‹</h2>
      <div class="dashboard-stats">
        <div class="stat-card"><div class="stat-number" id="myTripsCount">-</div><div class="stat-label">Ø±Ø­Ù„Ø§ØªÙŠ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div></div>
        <div class="stat-card"><div class="stat-number" id="myRating">-</div><div class="stat-label">ØªÙ‚ÙŠÙŠÙ…ÙŠ</div></div>
        <div class="stat-card"><div class="stat-number" id="myActiveRequests">-</div><div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©</div></div>
        <div class="stat-card"><div class="stat-number" id="communitySize">-</div><div class="stat-label">Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</div></div>
      </div>
    </div>

    <!-- Requests -->
    <div class="content" id="requestsContent">
      <h2 id="requestsTitle">Ø·Ù„Ø¨Ø§ØªÙŠ</h2><br>
      <button class="btn" id="refreshRequestsBtn" type="button">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
      <br><br>
      <div id="userRequestsList"><div class="loading"><div class="spinner"></div><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p></div></div>
    </div>

    <!-- Drivers -->
    <div class="content" id="driversContent">
      <h2>Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ† <span id="availableDriversCount" style="font-size:.9rem;opacity:.85"></span></h2>
          <div class="form-group">
      <label for="searchDriver">Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨</label>
      <input id="searchDriver" class="form-control" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ø£Ùˆ D001">
    </div>

      <div class="form-group">
        <label for="filterNeighborhood">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­ÙŠ</label>
        <select id="filterNeighborhood" class="form-control">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</option>
          <option value="Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ">Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ</option>
          <option value="Ø§Ù„Ø¸Ù‡Ø±Ø©">Ø§Ù„Ø¸Ù‡Ø±Ø©</option>
          <option value="Ø§Ù„Ø­Ù‚Ù„">Ø§Ù„Ø­Ù‚Ù„</option>
          <option value="Ø§Ù„Ø³ÙŠØ®Ø©">Ø§Ù„Ø³ÙŠØ®Ø©</option>
          <option value="Ø§Ù„Ø³Ø¨Ø®Ø©">Ø§Ù„Ø³Ø¨Ø®Ø©</option>
        </select>
      </div>
      <button class="btn" id="refreshDriversBtn" type="button">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</button>
      <br><br>
      <div id="driversList"><div class="loading"><div class="spinner"></div><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p></div></div>
    </div>

    <!-- Booking -->
    <div class="content" id="bookContent">
      <h2>Ø­Ø¬Ø² ØªÙˆØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2><br>
      <div class="alert alert-info"><strong>ØªØ¹Ù„ÙŠÙ…Ø§Øª:</strong> Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©ØŒ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨.</div>
      <form id="bookingForm">
        <div class="form-group">
          <label for="selectedDriver">Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø®ØªØ§Ø±</label>
          <select id="selectedDriver" class="form-control" required><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚</option></select>
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
          <div class="checkbox-group" id="daysGroup"></div>
        </div>
        <div class="form-group">
          <label for="duration">Ù…Ø¯Ø© Ø§Ù„Ø­Ø¬Ø² (Ø¨Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹)</label>
          <select id="duration" class="form-control" required>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø©</option>
            <option value="1">Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ø­Ø¯</option>
            <option value="2">Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†</option>
            <option value="3">3 Ø£Ø³Ø§Ø¨ÙŠØ¹</option>
            <option value="4">Ø´Ù‡Ø± ÙƒØ§Ù…Ù„</option>
          </select>
        </div>
        <div class="form-group">
          <label for="tripNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="tripNotes" class="form-control" rows="3" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­ØªØ§Ø¬ Ø§Ù„ØªÙˆØµÙŠÙ„ ØµØ¨Ø§Ø­Ø§Ù‹ 7:30"></textarea>
        </div>
        <button type="submit" class="btn" id="bookingBtn">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØµÙŠÙ„</button>
      </form>
    </div>

    <!-- Rating -->
    <div class="content" id="rateContent">
      <h2 id="rateTitle">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ø§Ø¦Ù‚</h2><br>
      <form id="ratingForm">
        <div class="form-group">
          <label for="ratedDriver" id="rateSelectLabel">Ø§Ù„Ø³Ø§Ø¦Ù‚</label>
          <select id="ratedDriver" class="form-control" required><option value="">Ø§Ø®ØªØ±</option></select>
        </div>
        <div class="form-group">
          <label for="ratingStars">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</label>
          <select id="ratingStars" class="form-control" required>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</option>
            <option value="5">â­â­â­â­â­ Ù…Ù…ØªØ§Ø²</option>
            <option value="4">â­â­â­â­ Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</option>
            <option value="3">â­â­â­ Ø¬ÙŠØ¯</option>
            <option value="2">â­â­ Ù…Ù‚Ø¨ÙˆÙ„</option>
            <option value="1">â­ ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†</option>
          </select>
        </div>
        <div class="form-group">
          <label for="ratingNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
          <textarea id="ratingNotes" class="form-control" rows="4" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>
        </div>
        <button type="submit" class="btn" id="ratingBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
      </form>
    </div>

    <!-- Register -->
    <div class="content" id="registerContent">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h2><br>
      <div class="alert alert-info"><strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† ØªØ³Ø¬ÙŠÙ„ Ø£Ù†ÙØ³Ù‡Ù… ÙƒØ³Ø§Ø¦Ù‚ÙŠÙ† Ù…ØªØ·ÙˆØ¹ÙŠÙ† Ø£Ùˆ ÙƒÙ…Ø­ØªØ§Ø¬ÙŠÙ† Ù„Ù„ØªÙˆØµÙŠÙ„.</div>
      <div id="backToLoginWrap" class="back-to-selection" style="display:none; margin-bottom:10px">
      <button type="button" class="btn btn-secondary" id="backToLoginBtn">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
      <form id="registrationForm">
        <div class="form-group"><label for="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="name" class="form-control" required></div>
        <div class="form-group"><label for="traineeId">Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨</label><input type="text" id="traineeId" class="form-control" required></div>
        <small id="regIdHint" class="field-hint neutral">
        </small>
        <div class="form-group"><label for="phone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ù…Ø¹ ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„Ø©)</label><input type="tel" id="phone" class="form-control" placeholder="9665XXXXXXXX" required></div>
        <div class="form-group">
          <label for="neighborhood">Ø§Ù„Ø­ÙŠ</label>
          <select id="neighborhood" class="form-control" required>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­ÙŠ</option>
            <option value="Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ">Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ</option>
            <option value="Ø§Ù„Ø¸Ù‡Ø±Ø©">Ø§Ù„Ø¸Ù‡Ø±Ø©</option>
            <option value="Ø§Ù„Ø­Ù‚Ù„">Ø§Ù„Ø­Ù‚Ù„</option>
            <option value="Ø§Ù„Ø³ÙŠØ®Ø©">Ø§Ù„Ø³ÙŠØ®Ø©</option>
            <option value="Ø§Ù„Ø³Ø¨Ø®Ø©">Ø§Ù„Ø³Ø¨Ø®Ø©</option>
          </select>
        </div>
        <div class="form-group">
          <label for="userType">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <select id="userType" class="form-control" required>
            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</option>
            <option value="Ø³Ø§Ø¦Ù‚">Ø³Ø§Ø¦Ù‚ Ù…ØªØ·ÙˆØ¹</option>
            <option value="Ù…ØªØ¯Ø±Ø¨">Ù…Ø­ØªØ§Ø¬ Ù„ØªÙˆØµÙŠÙ„</option>
          </select>
        </div>
        <button type="submit" class="btn" id="registerBtn">ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø³Ø§Ù†Ø¯</button>
      </form>
    </div>
  </div>

  <!-- Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
  <div class="connbar" id="connBar" aria-live="polite">
    <span class="conn-dot conn-connecting" id="connDot"></span>
    <span class="conn-text" id="connText">ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheetsâ€¦</span>
  </div>

  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© - Ø¶Ø¹ Ø±Ø§Ø¨Ø· Google Apps Script Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
    let GOOGLE_SCRIPT_URL = '';   // Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ù…Ù† config.json
    let API_KEY = '';
    let CFG = null;
    let requestsAutoTimer = null;

    let allowSelfRegister = false; // ÙŠÙØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¹Ø¯ Ø¥Ø«Ø¨Ø§Øª ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø±Ù‚Ù… ÙÙŠ ROSTER
    let lastVerifiedTrainee = null; // Ù†Ø­ØªÙØ¸ Ø¨Ø¢Ø®Ø± Ø±Ù‚Ù… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡ Ù„Ø¥Ù…Ø±Ø§Ø±ÙÙ‡ Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    let lastQuickDriverId = null; // ÙŠØ­ØªÙØ¸ Ø¨Ø¢Ø®Ø± Ø³Ø§Ø¦Ù‚ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡ Ø¹Ø¨Ø± "Ø­Ø¬Ø² Ø³Ø±ÙŠØ¹"



    let DAYS = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³']; // Ø§ÙØªØ±Ø§Ø¶ÙŠ

    // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    let drivers = [];
    let currentUser = null;
    let approvedPartners = [];


    // === [Ø¬Ø¯ÙŠØ¯] Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ===
    // Ø§Ù„Ù‚ÙŠÙ…: 'login' | 'register_only' | 'app'
    let appMode = 'login';

    function isValidUserType(t){ return t === 'Ø³Ø§Ø¦Ù‚' || t === 'Ù…ØªØ¯Ø±Ø¨'; }


    // Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ù‘Ø¯Ø© Ù„Ø¶Ø¨Ø· Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
    function setAppMode(mode){
      appMode = mode;

      const tabs = document.getElementById('tabsContainer');
      const topUserInfo = document.getElementById('topUserInfo');
      const loginSection = document.getElementById('loginSection');
      const allContents = Array.from(document.querySelectorAll('.content'));
      const reg = document.getElementById('registerContent');
      const backWrap = document.getElementById('backToLoginWrap');

      // Ø£Ø¯Ø§Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      function hideAllContents(){
        allContents.forEach(c => {
          c.classList.remove('active');
          c.setAttribute('hidden','');
          c.setAttribute('aria-hidden','true');
          c.setAttribute('inert','');
        });
      }
      function showOnly(el){
        el.classList.add('active');
        el.removeAttribute('hidden');
        el.setAttribute('aria-hidden','false');
        el.removeAttribute('inert');
      }

      if(mode === 'login'){
        loginSection.style.display = 'block';
        if(tabs) tabs.classList.remove('active');
        if(topUserInfo) topUserInfo.style.display = 'none';
        hideAllContents();
        showOnly(document.getElementById('homeContent'));
        // Ø¥Ø®ÙØ§Ø¡ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.querySelector('.tab[data-tab="register"]')?.style.setProperty('display','none');
        if(backWrap) backWrap.style.display = 'none';
      }

      if(mode === 'register_only'){
        loginSection.style.display = 'none';
        if(tabs) tabs.classList.remove('active');  // Ù„Ø§ ØªØ¨ÙˆÙŠØ¨Ø§Øª
        if(topUserInfo) topUserInfo.style.display = 'none';
        hideAllContents();
        showOnly(reg);
        // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø£ØµÙ„Ø§Ù‹
        document.querySelector('.tab[data-tab="register"]')?.style.setProperty('display','none');
        if(backWrap) backWrap.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± "Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¯Ø®ÙˆÙ„"
      }

      if(mode === 'app'){
        loginSection.style.display = 'none';
        if(tabs) tabs.classList.add('active');
        if(topUserInfo) topUserInfo.style.display = 'flex';
        allContents.forEach(c => { 
          c.removeAttribute('hidden'); 
          c.removeAttribute('inert'); 
          c.setAttribute('aria-hidden', c.classList.contains('active') ? 'false' : 'true'); 
        });
        // Ø¥Ø®ÙÙ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.querySelector('.tab[data-tab="register"]')?.style.setProperty('display','none');
        if(backWrap) backWrap.style.display = 'none';
      }
    }

    // Ø­Ø§Ø±Ø³ Ø¹Ø§Ù… Ù„Ù„ØªÙ†Ù‚Ù„ (ÙŠÙ…Ù†Ø¹ Ø£ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø®Ø§Ø±Ø¬ ÙˆØ¶Ø¹ app)
    function guardNavigation(ev){
      if(appMode !== 'app'){
        ev.preventDefault();
        showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.', 'warn');
        return true;
      }
      return false;
    }


    // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    
    // Ù…ÙØ§ØªÙŠØ­ ÙƒØ§Ø´ Ø«Ø§Ø¨ØªØ© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ action + data
    function stableStringify(obj){
      if (obj === null || typeof obj !== 'object') return String(obj);
      if (Array.isArray(obj)) return '[' + obj.map(stableStringify).join(',') + ']';
      const keys = Object.keys(obj).sort();
      return '{' + keys.map(k => JSON.stringify(k) + ':' + stableStringify(obj[k])).join(',') + '}';
    }
    function buildCacheKey(action, data){
      return String(action || '') + ':' + stableStringify(data || {});
    }


    function sanitizeStr(s){ return String(s||'').replace(/[\u200E\u200F\u202A-\u202E]/g,'').trim(); }
    function normalizeDigits(s=''){
      const map={'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9',
                'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'};
      return String(s).replace(/[Ù -Ù©Û°-Û¹]/g, ch => map[ch] || ch);
    }


    async function loadConfig() {
      const url = './config.json?ts=' + Date.now(); // Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ÙƒØ§Ø´
      const resp = await fetch(url, { cache: 'no-store' });

      if (!resp.ok) {
        throw new Error('[CONFIG] Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø§Ù„Ù…Ø³Ø§Ø± Ø®Ø·Ø£ (' + resp.status + ')');
      }

      const txt = await resp.text();

      // Ù„Ùˆ Ø±Ø¬Ø¹ HTML Ø¨Ø¯Ù„ JSON
      if (txt.trim().startsWith('<')) {
        throw new Error('[CONFIG] Ø±Ø¬Ø¹ HTML Ø¨Ø¯Ù„ JSON â€” Ø§Ù„Ù…Ù„Ù Ù…ÙÙ‚ÙˆØ¯ Ø£Ùˆ Ø§Ù„Ù…Ø³Ø§Ø± Ø®Ø·Ø£');
      }

      let json;
      try {
        json = JSON.parse(txt);
      } catch (e) {
        throw new Error('[CONFIG] ØµÙŠØ§ØºØ© JSON ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
      }

      // Ø®Ø²Ù‘Ù† Ø§Ù„Ù‚ÙŠÙ…
      CFG = json;
      GOOGLE_SCRIPT_URL = CFG.GOOGLE_SCRIPT_URL || '';
      API_KEY = CFG.API_KEY || '';

      console.log('CONFIG loaded:', CFG);
      if (CFG.includeWeekend) DAYS = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];

    }


    function isValidPhoneKSA(v){ return /^9665\d{8}$/.test((v||'').trim()); }
    function showError(msg){
      const existing = $('.alert-error');
      if(existing) existing.remove();
      const alert = document.createElement('div');
      alert.className = 'alert alert-error';
      alert.textContent = msg;
      $('.login-form').insertBefore(alert, $('.login-form').firstChild);
      setTimeout(() => alert.remove(), 5000);
    }

        function showToast(msg, type='info', timeout=3500){
      const wrap = document.getElementById('toastWrap');
      if(!wrap) return;
      const d = document.createElement('div');
      const palette = {
        info:   {bg:'#cce7ff', bd:'#99d6ff', tx:'#0c5460'},
        success:{bg:'#d4edda', bd:'#c3e6cb', tx:'#155724'},
        warn:   {bg:'#fff3cd', bd:'#ffeaa7', tx:'#856404'},
        error:  {bg:'#f8d7da', bd:'#f5c2c7', tx:'#721c24'}
      }[type] || {bg:'#cce7ff', bd:'#99d6ff', tx:'#0c5460'};
      d.style.cssText = `
        padding:12px 14px;border-radius:10px;border:1px solid ${palette.bd};
        background:${palette.bg};color:${palette.tx};min-width:220px;
        box-shadow:0 10px 20px rgba(0,0,0,.08);font-weight:700
      `;
      d.textContent = msg;
      wrap.appendChild(d);
      setTimeout(()=>{ d.style.opacity='0'; d.style.transform='translateY(6px)'; }, timeout);
      setTimeout(()=>{ d.remove(); }, timeout+300);
    }


    // Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    const connDot = () => document.getElementById('connDot');
    const connText = () => document.getElementById('connText');

    function setConnStatus(state){
      const dot = connDot(); 
      const txt = connText();
      if(!dot || !txt) return;
      dot.classList.remove('conn-online','conn-connecting','conn-offline');
      if(state==='online'){ 
        dot.classList.add('conn-online'); 
        txt.textContent='Ù…ØªØµÙ„ Ø¨Ù€ Google Sheets'; 
      } else if(state==='connecting'){ 
        dot.classList.add('conn-connecting'); 
        txt.textContent='ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheetsâ€¦'; 
      } else { 
        dot.classList.add('conn-offline'); 
        txt.textContent='Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets Ù…Ù†Ù‚Ø·Ø¹'; 
      }
    }

    // --- ÙƒØ§Ø´ Ø¨Ø³ÙŠØ· ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© + localStorage ---
    const CACHE_TTL = {
      getTopStats:          60_000, // 1 Ø¯Ù‚ÙŠÙ‚Ø©
      getDrivers:           60_000,
      getUserStats:         45_000,
      getPassengerRequests: 30_000,
      getDriverRequests:    30_000
    };

    const memCache = new Map();      // action -> {ts,data}
    const inflight = new Map();      // action -> Promise

    function lcGet(key){
      try{ return JSON.parse(localStorage.getItem(key) || 'null'); }catch{ return null;}
    }
    function lcSet(key, val){
      try{ localStorage.setItem(key, JSON.stringify(val)); }catch{}
    }

    function isFresh(ts, ttl){ return (Date.now() - ts) < ttl; }

    async function fetchWithCache(action, data = {}, { ttl = 30_000, staleOK = true } = {}){
      const cacheKey = buildCacheKey(action, data);
      const memKey   = cacheKey;                // Ù†ÙØ³ Ø§Ù„Ù…ÙØªØ§Ø­ Ù„Ù„Ø°Ø§ÙƒØ±Ø©
      const lsKey    = 'sand_cache_' + cacheKey;

      // 1) Ø°Ø§ÙƒØ±Ø© ÙÙˆØ±ÙŠØ©
      const m = memCache.get(memKey);
      if (m && isFresh(m.ts, ttl)) return { from: 'mem', data: m.data };

      // 2) localStorage (Ø¹Ø±Ø¶ ÙÙˆØ±ÙŠ Ù„Ùˆ staleOK)
      const lc = lcGet(lsKey);
      if (lc && staleOK) {
        // Ø­Ø¯Ù‘Ø« ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„ÙƒÙ† Ø§Ø±Ø¬Ø¹ ÙÙˆØ±Ù‹Ø§ Ø¨Ø§Ù„ÙƒØ§Ø´
        backgroundRefresh(action, data, ttl);
        return { from: 'local', data: lc.data, stale: !isFresh(lc.ts, ttl) };
      }

      // 3) Ù„Ø§ ØªÙƒØ±Ù‘Ø± Ù†ÙØ³ Ø§Ù„Ø·Ù„Ø¨ Ù„Ùˆ Ø¬Ø§Ø±Ù
      if (inflight.has(memKey)) return inflight.get(memKey);

      // 4) Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
      const p = (async () => {
        const res = await sendToGoogleSheets(action, data);
        const payload = res?.data ?? null;
        const entry = { ts: Date.now(), data: payload };
        memCache.set(memKey, entry);
        lcSet(lsKey, entry);
        return { from: 'net', data: payload };
      })().finally(() => inflight.delete(memKey));

      inflight.set(memKey, p);
      return p;
    }


    function backgroundRefresh(action, data, ttl){
      // ØªØ­Ø¯ÙŠØ« Ù‡Ø§Ø¯Ø¦: Ù„Ø§ ÙŠØºÙŠØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ ÙˆØµÙˆÙ„ Ù†ØªÙŠØ¬Ø© Ø¬Ø¯ÙŠØ¯Ø©
      fetchWithCache(action, data, { ttl, staleOK:false }).catch(()=>{});
    }


    async function sendToGoogleSheets(action, data){
      let connectingTimer = setTimeout(()=> setConnStatus('connecting'), 600);

      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), 20_000);

      try{
        if (!GOOGLE_SCRIPT_URL) { clearTimeout(connectingTimer); setConnStatus('offline'); throw new Error('GOOGLE_SCRIPT_URL is empty'); }

        const resp = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action, data, ...(API_KEY? {key:API_KEY}:{}) }),
          signal: controller.signal,
          mode: 'cors',
          credentials: 'omit',
          cache: 'no-store',
          redirect: 'follow',
          referrerPolicy: 'no-referrer'
        });

        clearTimeout(connectingTimer);
        clearTimeout(t);
        if (!resp.ok) { setConnStatus('offline'); throw new Error('HTTP ' + resp.status); }
        const json = await resp.json().catch(()=>{ throw new Error('INVALID_JSON'); });

        setConnStatus('online');
        return json;
      } catch (err) {
        clearTimeout(connectingTimer);
        clearTimeout(t);
        setConnStatus('offline');
        console.error('[GS Error]', err);
        throw new Error(
          err.name === 'AbortError' ? 'TIMEOUT_20S' :
          err.message === 'INVALID_JSON' ? 'INVALID_JSON' : ('NET_' + (err.message||'ERR'))
        );
      }
    }

    // Ù†Ø¨Ø¶Ø§Øª Ø§ØªØµØ§Ù„
    async function heartbeat(){
      try{
        const r = await fetchWithCache('getTopStats', {}, { ttl: CACHE_TTL.getTopStats });
        updateTopStats(r?.data);
      }catch{}
    }


    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await loadConfig();        // â† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆÙ†ÙÙØ¬
        resolveConfigKeys();       // â† Ø­Ù„Ù‘ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©

        if (!GOOGLE_SCRIPT_URL) {  // Ø­Ø§Ø±Ø³ Ù…ÙÙŠØ¯
          setConnStatus('offline');
          throw new Error('GOOGLE_SCRIPT_URL Ù…ÙÙ‚ÙˆØ¯ â€” Ø­Ø¯Ù‘Ø« config.json');
        }

        await heartbeat();         // â† Ø£ÙˆÙ„ Ù†Ø¨Ø¶Ø© Ø§ØªØµØ§Ù„
        // ØªØ­Ù…ÙŠÙ„ ØµØ§Ù…Øª Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        fetchWithCache('getTopStats', {}, { ttl: CACHE_TTL.getTopStats });
        fetchWithCache('getDrivers',   {}, { ttl: CACHE_TTL.getDrivers });
        // Ù„Ùˆ ÙÙŠÙ‡ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø±ÙˆÙØŒ Ø¬Ù‡Ù‘Ø² Ø¨ÙŠØ§Ù†Ø§ØªÙ‡
        if (currentUser) {
          const role = currentUser.userType === 'Ø³Ø§Ø¦Ù‚' ? 'getDriverRequests' : 'getPassengerRequests';
          fetchWithCache(role, { 
            driverTraineeId: currentUser.traineeId,
            passengerTraineeId: currentUser.traineeId
          }, { ttl: CACHE_TTL[role] || 30_000 });
          fetchWithCache('getUserStats', { traineeId: currentUser.traineeId, userType: currentUser.userType }, { ttl: CACHE_TTL.getUserStats });
        }

        await updateUserStats();   // â† Ø¹Ø¨Ù‘ÙŠ "Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹" Ø­ØªÙ‰ Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        setInterval(heartbeat, 30000);

        initializeApp();
              // ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø¥Ù† ÙˆØ¬Ø¯
      if(localStorage.getItem('sand_theme') === 'dark'){
        document.documentElement.classList.add('dark');
        const tBtn = document.getElementById('themeToggleBtn');
        if(tBtn) tBtn.textContent = 'ÙˆØ¶Ø¹ Ù†Ù‡Ø§Ø±ÙŠ';
      }
      // Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
      document.getElementById('themeToggleBtn')?.addEventListener('click', ()=>{
        const html = document.documentElement;
        const on = html.classList.toggle('dark');
        localStorage.setItem('sand_theme', on ? 'dark' : 'light');
        document.getElementById('themeToggleBtn').textContent = on ? 'ÙˆØ¶Ø¹ Ù†Ù‡Ø§Ø±ÙŠ' : 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†';
      });

        document.getElementById('loginTraineeId')?.focus();
      } catch (e) {
        console.error(e);
        alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ config.json: ' + e.message);
        setConnStatus('offline');
      }
    });


        function resolveConfigKeys() {
      // Ø§Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† CFG Ø¨Ø£ÙŠ Ø§Ø³Ù… Ù…ØªØ§Ø­
      const apiKey   = CFG.API_KEY || CFG.defaultApiKey || CFG.apiKey || '';
      const sheetId  = CFG.sheetId || CFG.defaultSheetId || '';
      const apiBase  = CFG.apiBase || '';

      // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø£ÙƒÙˆØ§Ø¯ Ø«Ø§Ù†ÙŠØ© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ØŒ Ø®Ø²Ù‘Ù†Ù‡Ø§ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¹Ø§Ù…Ø©
      window.SAND_CFG = { apiKey, sheetId, apiBase };

      console.log('%c[Diag]', 'color:#7047eb;font-weight:bold',
        'Resolved keys', { apiKey: apiKey ? '(set)' : 'undefined', sheetId, apiBase }
      );
    }

    function hintTraineeIdState(value){
      const v = String(value||'').trim();
      if(!v){
        return {cls:'neutral', msg:'ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ¯Ù‘ÙŠ: Ø¹Ø§Ø¯Ø©Ù‹ ÙŠØ¨Ø¯Ø£ Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø¨Ù€ 4451 Ø£Ùˆ 4461'};
      }
      if(/^(4451|4461)\d*$/.test(v)){
        return {cls:'good', msg:'âœ… Ø§Ù„Ø´ÙƒÙ„ ÙŠØ¨Ø¯Ùˆ Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹ (ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 4451 Ø£Ùˆ 4461)'};
      }
      return {cls:'warn', msg:'âš ï¸ ØªÙ†ÙˆÙŠÙ‡: Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ø¹Ø§Ø¯Ø©Ù‹ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 4451 Ø£Ùˆ 4461'};
    }


    function initializeApp() {
      setupLoginForm();
      setupNavigation();
      setupForms();
      setupKeyboardShortcuts();
      setupTraineeIdHints();
    }
    // Ø£Ø®ÙÙ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
    document.querySelector('.tab[data-tab="register"]')?.style.setProperty('display','none');
    document.getElementById('backToLoginBtn')?.addEventListener('click', ()=>{
      allowSelfRegister = false;
      lastVerifiedTrainee = null;
      setAppMode('login');
      // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù„Ù‰ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
      document.getElementById('loginTraineeId')?.focus();
    });


    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù† ÙƒØ§Ù† Ù…Ø­ÙÙˆØ¸Ø§Ù‹
    const saved = localStorage.getItem('sand_currentUser');
    if (saved) {
      try {
        currentUser = JSON.parse(saved);
        // Ø£Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ DOM
        document.addEventListener('DOMContentLoaded', () => {
          const tabRegister = document.querySelector('.tab[data-tab="register"]');
          if (tabRegister) tabRegister.style.display = 'none';
          allowSelfRegister = false;
          lastVerifiedTrainee = null;

          showMainInterface();
        });
      } catch {}
    }

    function updateRequestsBadge(n){
      const badge = document.getElementById('requestsBadge');
      if(!badge) return;
      if(n>0){
        badge.textContent = n>99 ? '99+' : String(n);
        badge.style.display = 'inline-flex';
      }else{
        badge.style.display = 'none';
      }
    }

    function setupLoginForm() {
      const loginBtn = $('#loginBtn');
      if (loginBtn) loginBtn.addEventListener('click', handleLogin);
    }

    function setupNavigation() {
      $('#logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('sand_currentUser');
        drivers = [];
        approvedPartners = [];
        currentUser = null;
        allowSelfRegister = false;
        lastVerifiedTrainee = null;

        $('#tabsContainer').classList.remove('active');
        $$('.content').forEach(c => c.classList.remove('active'));
        $('#homeContent').classList.add('active');

        $('#loginSection').style.display = 'block';
        $('#loginForm').classList.add('active');
        $('#loginForm').setAttribute('aria-hidden', 'false');

        $('#loginTraineeId').value = '';
 
        $('.tab[data-tab="book"]')?.style && ($('.tab[data-tab="book"]').style.display = 'block');
        $('#topUserInfo')?.style && ($('#topUserInfo').style.display = 'none');
        $$('#tabsContainer .tab').forEach((b,i) => b.classList.toggle('active', i===0));
        document.querySelector('.tab[data-tab="register"]')?.style.setProperty('display','none');

        if(requestsAutoTimer) { clearInterval(requestsAutoTimer); requestsAutoTimer = null; }
          setAppMode('login'); 
      });
      

      $$('#tabsContainer .tab').forEach(btn => {
        btn.addEventListener('click', async (ev) => {     // âœ… Ø®Ù„ÙŠÙ‡Ø§ async
          if (guardNavigation(ev)) return;

          const tab = btn.dataset.tab;

          if (currentUser?.userType === 'Ø³Ø§Ø¦Ù‚' && tab === 'drivers') {
            ev.preventDefault();
            showToast('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ØºÙŠØ± Ù…Ø®ØµØµØ© Ù„Ø¯ÙˆØ±Ùƒ. Ø§Ø³ØªØ®Ø¯Ù… "Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„".','info');
            return;
          }

          if (tab === 'register' && !allowSelfRegister) {
            ev.preventDefault();
            showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©. ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø±Ù‚Ù…Ùƒ Ø£ÙˆÙ„Ù‹Ø§ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„.','warn');
            return;
          }

          $$('#tabsContainer .tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          if (tab === 'home') { updateUserStats(); }
          $$('.content').forEach(c => c.classList.remove('active'));
          const map = { home:'homeContent', requests:'requestsContent', drivers:'driversContent', book:'bookContent', rate:'rateContent', register:'registerContent' };
          const targetId = map[tab];
          if (targetId) document.getElementById(targetId).classList.add('active');

          if (tab === 'drivers') {
            loadDriversFromSheets().then(()=>{
              loadFilters();
              filterDriversByNeighborhood();
              document.getElementById('searchDriver').dispatchEvent(new Event('input'));
            });
          }

          if (tab === 'requests') {
            loadUserRequests();
            if (requestsAutoTimer) clearInterval(requestsAutoTimer);
            requestsAutoTimer = setInterval(()=>{
              if (document.getElementById('requestsContent').classList.contains('active')) {
                loadUserRequests();
              }
            }, 60000);
          } else {
            if (requestsAutoTimer) { clearInterval(requestsAutoTimer); requestsAutoTimer = null; }
          }

          if (tab === 'book') updateDriverSelects(lastQuickDriverId);

          if (tab === 'rate') {                // âœ… Ø£Ù‚ÙˆØ§Ø³ ØµØ­ÙŠØ­Ø©
            await loadUserRequests();          // ÙŠØ¨Ù†ÙŠ approvedPartners Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©
            populateRatingOptions();           // ÙŠÙ…Ù„Ø£ Ù‚Ø§Ø¦Ù…Ø© "Ø§Ù„Ø³Ø§Ø¦Ù‚/Ø§Ù„Ø±Ø§ÙƒØ¨" Ø¨Ø§Ù„ØªÙˆØ§ÙÙ‚Ø§Øª
          }
        });
      });



      if($('#requestsContent').classList.contains('active')){
        loadUserRequests();
        if(requestsAutoTimer) clearInterval(requestsAutoTimer);
        requestsAutoTimer = setInterval(()=>{
          if(document.getElementById('requestsContent').classList.contains('active')){
            loadUserRequests();
          }
        }, 60000);
      }
    }


    function saveFilters(){
      const f = {
        q: document.getElementById('searchDriver')?.value || '',
        n: document.getElementById('filterNeighborhood')?.value || ''
      };
      localStorage.setItem('sand_filters', JSON.stringify(f));
    }
    function loadFilters(){
      try{
        const f = JSON.parse(localStorage.getItem('sand_filters') || '{}');
        if(f.q != null) document.getElementById('searchDriver').value = f.q;
        if(f.n != null) document.getElementById('filterNeighborhood').value = f.n;
      }catch{}
    }


    function setupForms() {
      $('#registrationForm').addEventListener('submit', handleRegistration);
      $('#bookingForm').addEventListener('submit', handleBooking);
      $('#ratingForm').addEventListener('submit', handleRating);

      $('#refreshDriversBtn').addEventListener('click', loadDriversFromSheets);
      $('#refreshRequestsBtn').addEventListener('click', loadUserRequests);


      // ÙÙ„ØªØ±Ø© Ø§Ù„Ø­ÙŠ
      document.getElementById('filterNeighborhood').addEventListener('change', ()=>{
        filterDriversByNeighborhood();
        saveFilters();
      });

          // ğŸ”½ Ø¨Ø¯Ù‘Ù„ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù€ debounce
          (function(){
            let t = null;
            const input = document.getElementById('searchDriver');
            if(!input) return;
            input.addEventListener('input', ()=>{
              if(t) clearTimeout(t);
              t = setTimeout(()=>{
                const q = normalizeDigits(input.value).trim().toLowerCase().replace(/\s+/g,' ');
                const neighborhood = document.getElementById('filterNeighborhood').value;
                const base = neighborhood ? drivers.filter(d=>d.neighborhood===neighborhood) : drivers;

                if(!q){
                  displayDrivers(base);
                  saveFilters();
                  return;
                }
                const filtered = base.filter(d =>
                  String(d.name||'').toLowerCase().includes(q) ||
                  String(d.traineeId||'').toLowerCase().includes(q)
                );
                displayDrivers(filtered);
                saveFilters();
              }, 220);
            });
          })();
        }

    function setupKeyboardShortcuts() {
      ['loginTraineeId'].forEach(id => {
        const el = document.getElementById(id);
        if(!el) return;
        el.addEventListener('keydown', e => {
          if(e.key === 'Enter'){
            e.preventDefault();
            handleLogin();
          }
        });
      });
    }


        function setupTraineeIdHints(){
      // ØªÙ„Ù…ÙŠØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯Ø®ÙˆÙ„
      const loginId = document.getElementById('loginTraineeId');
      const loginHint = document.getElementById('loginIdHint');
      if(loginId && loginHint){
        loginId.addEventListener('input', (e)=>{
          const s = hintTraineeIdState(e.target.value);
          loginHint.className = 'field-hint ' + s.cls;
          loginHint.textContent = s.msg;
          // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªÙ†Ø¸ÙŠÙ Ù„Ø£ÙŠ Ø£Ø­Ø±Ù ØºÙŠØ± Ø£Ø±Ù‚Ø§Ù…
          e.target.value = normalizeDigits(e.target.value).replace(/[^\d]/g,'');
        });
      }

      // ØªÙ„Ù…ÙŠØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      const regId = document.getElementById('traineeId');
      const regHint = document.getElementById('regIdHint');
      if(regId && regHint){
        regId.addEventListener('input', (e)=>{
          const s = hintTraineeIdState(e.target.value);
          regHint.className = 'field-hint ' + s.cls;
          regHint.textContent = s.msg;
          // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªÙ†Ø¸ÙŠÙ Ù„Ø£ÙŠ Ø£Ø­Ø±Ù ØºÙŠØ± Ø£Ø±Ù‚Ø§Ù…
          e.target.value = normalizeDigits(e.target.value).replace(/[^\d]/g,'');
        });
      }
    }

      function isValidTraineeIdFormat(id){
        const v = String(id || '').trim();
        const patternTD = /^[TD]\d{3,}$/i;        // T001 / D1234 ...
        const patternROSTER = /^44\d+$/; // Ø£ÙˆØ³Ø¹ ÙˆÙŠØ´Ù…Ù„ 4431 Ùˆ 4461 Ùˆ 4451
        return patternTD.test(v) || patternROSTER.test(v);
      }


    async function handleLogin() {
      const traineeId = normalizeDigits($('#loginTraineeId').value).toUpperCase().trim();
      if (!traineeId) { showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨'); $('#loginTraineeId').focus(); return; }

      const loginBtn = $('#loginBtn');
      loginBtn.disabled = true; loginBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';

      try {
        const result = await sendToGoogleSheets('verifyUser', { traineeId });

        // âœ… Ù…Ø³Ø¬Ù‘Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§ â†’ Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±
        if (result?.success && result?.data?.isRegistered === true) {
          const d = result.data;
          currentUser = {
            name: d.name || 'Ù…Ø³ØªØ®Ø¯Ù…',
            traineeId: d.traineeId,
            userType: d.userType || 'Ù…ØªØ¯Ø±Ø¨',
            phone: d.phone || '',
            neighborhood: d.neighborhood || ''
          };
          localStorage.setItem('sand_currentUser', JSON.stringify(currentUser));
          setAppMode('app');          // [Ø¬Ø¯ÙŠØ¯]
          showMainInterface();
          return;
        }

        // ğŸŸ¦ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ROSTER ÙˆØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„ â†’ Ø§ÙØªØ­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø²ÙˆÙ„
        if (result?.success && result?.data?.inRoster === true && result?.data?.isRegistered !== true) {
          allowSelfRegister = true;
          lastVerifiedTrainee = normalizeDigits(traineeId).toUpperCase();

          const nameFromRoster = result?.data?.rosterName || '';
          setAppMode('register_only');        // [Ø¬Ø¯ÙŠØ¯]
          showRegistrationForm(traineeId, nameFromRoster);
          return;
        }


        if (result?.error === 'TRAINEE_NOT_AUTHORIZED') {
          showError('Ø¹Ø°Ø±Ù‹Ø§ØŒ Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ ØºÙŠØ± Ù…ÙÙØ¹Ù‘Ù„ ÙÙŠ Ø§Ù„ÙƒÙ„ÙŠØ©.');
          return;
        }

        // ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø±ÙˆØ³ØªØ±
        showError('Ø¹Ø°Ø±Ù‹Ø§ØŒ Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†.');
      } catch (err) {
        showError('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.');
      } finally {
        loginBtn.disabled = false; loginBtn.textContent = 'Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø³Ø§Ù†Ø¯';
      }
    }

function showRegistrationForm(traineeId, name) {
  if (!allowSelfRegister) {
    showToast('ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø±Ù‚Ù…Ùƒ Ø£ÙˆÙ„Ù‹Ø§ Ø¹Ø¨Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„.','warn');
    return;
  }
  setAppMode('register_only'); // Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù…Ø®ÙÙŠØ©

      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙ‚Ø·
    const tid = normalizeDigits(traineeId || lastVerifiedTrainee || '').toUpperCase();
    const idInput = document.getElementById('traineeId');
    idInput.value = tid;
    idInput.readOnly = true;                    // ğŸ”’ Ù…Ù…Ù†ÙˆØ¹ ØªØºÙŠÙŠØ±Ù‡ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚
    const regHint = document.getElementById('regIdHint');
    if (regHint){ regHint.className='field-hint good'; regHint.textContent='ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ âœ…'; }

  document.getElementById('name').value = name || '';
  document.getElementById('phone')?.focus();
}




    function showMainInterface() {
      // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø§Ù‚Øµ Ø¨ÙŠØ§Ù†Ø§Øª (Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)ØŒ Ù†ÙØ¯Ø®Ù„Ù‡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø²ÙˆÙ„
      if(!currentUser || !isValidUserType(currentUser.userType)){
        allowSelfRegister = true;
        lastVerifiedTrainee = currentUser?.traineeId || null;
        setAppMode('register_only');

        // ØªØ¹Ø¨Ø¦Ø© Ù…Ø§ ØªÙˆÙØ± Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª
        document.getElementById('traineeId').value    = currentUser?.traineeId || '';
        document.getElementById('name').value         = currentUser?.name || '';
        document.getElementById('phone').value        = currentUser?.phone || '';
        document.getElementById('neighborhood').value = currentUser?.neighborhood || '';
        showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø³Ø§Ø¦Ù‚/Ù…ØªØ¯Ø±Ø¨).','warn');
        return;
      }

      // Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙƒØªÙ…Ù„ â†’ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
      setAppMode('app');

      document.getElementById('userName').textContent      = currentUser.name;
      document.getElementById('homeUserName').textContent  = currentUser.name;
      document.getElementById('userRole').textContent      = currentUser.userType;

      const role = currentUser.userType;

      if (role === 'Ø³Ø§Ø¦Ù‚') {
        document.getElementById('requestsTab').innerHTML = 'ğŸš— Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„';
        document.querySelector('.tab[data-tab="book"]').style.display = 'none';
        document.getElementById('rateTitle').textContent = 'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø±Ø§ÙƒØ¨';
        document.getElementById('rateSelectLabel').textContent = 'Ø§Ù„Ø±Ø§ÙƒØ¨';

        const tabDrivers = document.querySelector('.tab[data-tab="drivers"]');
        if (tabDrivers) tabDrivers.style.display = 'none';
        if (document.querySelector('.tab.active')?.dataset.tab === 'drivers') {
          document.querySelector('.tab[data-tab="home"]')?.click();
        }
      } else { // Ù…ØªØ¯Ø±Ø¨ ÙÙ‚Ø·
        document.getElementById('requestsTab').innerHTML = 'ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙŠ';
        document.querySelector('.tab[data-tab="book"]').style.display = 'block';
        document.getElementById('rateTitle').textContent = 'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ø§Ø¦Ù‚';
        document.getElementById('rateSelectLabel').textContent = 'Ø§Ù„Ø³Ø§Ø¦Ù‚';
      }

      // Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†" Ù„ØºÙŠØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙ‚Ø·
      const tabDrivers2 = document.querySelector('.tab[data-tab="drivers"]');
      if (tabDrivers2) {
        if (role === 'Ø³Ø§Ø¦Ù‚') {
          tabDrivers2.style.display = 'none';
          if (document.querySelector('.tab.active')?.dataset.tab === 'drivers') {
            document.querySelector('.tab[data-tab="home"]')?.click();
          }
        } else {
          tabDrivers2.style.display = 'block';
        }
      }




      // Ø¨Ù†Ø§Ø¡ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¬Ø²
      const daysWrap = document.getElementById('daysGroup');
      daysWrap.innerHTML = '';
      DAYS.forEach((d, i) => {
        const id = 'day_' + i;
        const div = document.createElement('div');
        div.className = 'checkbox-item';
        div.innerHTML = `<input type="checkbox" id="${id}" value="${d}"><label for="${id}">${d}</label>`;
        daysWrap.appendChild(div);
      });

      // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      loadDriversFromSheets();
      loadUserRequests();
      updateTopStats();
      updateUserStats();
    }



    async function handleRegistration(e) {
      e.preventDefault();
      const btn = $('#registerBtn');
      if (btn.disabled) return;
      btn.disabled = true;
      btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';

      const name        = $('#name').value.trim();
      const traineeId   = normalizeDigits($('#traineeId').value).toUpperCase().trim();
      const phone       = $('#phone').value.trim();
      const neighborhood= $('#neighborhood').value;
      const userType    = $('#userType').value;

      const alreadyVerified = allowSelfRegister && lastVerifiedTrainee &&
      traineeId === normalizeDigits(lastVerifiedTrainee).toUpperCase();

      function resetBtn(){ btn.disabled=false; btn.textContent='ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø³Ø§Ù†Ø¯'; }

      // âœ… ØªØ­Ù‚Ù‘Ù‚Ø§Øª ØµØ±ÙŠØ­Ø© (Ù„Ø£Ù† e.preventDefault ÙŠÙ…Ù†Ø¹ ØªØ­Ù‚Ù‚ required Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
      if (name.length < 2){ showToast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„','warn'); return resetBtn(); }
      if (!alreadyVerified && !isValidTraineeIdFormat(traineeId)){ showToast('ØµÙŠØºØ© Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­Ø©','warn'); return resetBtn(); }
      if (!isValidPhoneKSA(phone)){ showToast('ØµÙŠØºØ© Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø§Ø³ØªØ®Ø¯Ù… 9665XXXXXXXX','warn'); return resetBtn(); }
      if (!neighborhood){ showToast('Ø§Ø®ØªØ± Ø§Ù„Ø­ÙŠ','warn'); return resetBtn(); }
      if (!isValidUserType(userType)){ showToast('Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ø³Ø§Ø¦Ù‚ / Ù…ØªØ¯Ø±Ø¨','warn'); return resetBtn(); }


      const data = { name, traineeId: alreadyVerified ? lastVerifiedTrainee : traineeId,phone, neighborhood, userType };

      try {
        const res = await sendToGoogleSheets('registerUser', data);

        if (res?.success) {
          const info = res.data || {};
          showToast(`ØªÙ… ${info.updated ? 'ØªØ­Ø¯ÙŠØ«' : 'Ø§Ù„ØªØ³Ø¬ÙŠÙ„'} âœ… - Ø±Ù‚Ù…Ùƒ: ${info.traineeId || data.traineeId}`,'success');

          currentUser = { ...data };
          localStorage.setItem('sand_currentUser', JSON.stringify(currentUser));

          e.target.reset();
          allowSelfRegister = false;
          lastVerifiedTrainee = null;

          showMainInterface(); // â† Ø³ÙŠØ¹Ø§Ù„Ø¬ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
          document.querySelector('.tab[data-tab="home"]')?.click();
        } else if (res?.error === 'TRAINEE_ID_EXISTS') {
          if (confirm('Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§.\nØ³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ')) {
            $('#loginSection').style.display = 'block';
            $('#tabsContainer').classList.remove('active');
            $('#loginForm').classList.add('active');
            $('#loginTraineeId').value = data.traineeId;
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        } else {
          showToast(res?.error || 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„','error');
        }
      } catch (err) {
        showToast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.','error');
      } finally {
        resetBtn();
      }
    }


    async function loadDriversFromSheets() {
      // Ù„Ø§ ØªØ­Ù…Ù‘Ù„ ÙˆÙ„Ø§ ØªØ¹Ø±Ø¶ Ù„Ù„Ø³Ø§Ø¦Ù‚
      if (currentUser?.userType === 'Ø³Ø§Ø¦Ù‚') {
        const list = $('#driversList');
        if (list) {
          list.innerHTML = `<div class="alert alert-info">Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…Ø®ØµØµØ© Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†.</div>`;
        }
        return;
      }

      // âœ… Ø¹Ø±Ù‘Ù list Ù‡Ù†Ø§ Ù‚Ø¨Ù„ Ø£ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù…
      const list = $('#driversList');

      // Ø¬Ø±Ù‘Ø¨ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹
      const cached = lcGet('sand_cache_' + buildCacheKey('getDrivers', {}));
      if (cached && Array.isArray(cached.data)) {
        drivers = cached.data;
        displayDrivers(drivers);
      } else {
        list.innerHTML = `<div class="loading"><div class="spinner"></div><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p></div>`;
      }

      try {
        const r = await fetchWithCache('getDrivers', {}, { ttl: CACHE_TTL.getDrivers });
        drivers = Array.isArray(r?.data) ? r.data : [];
        displayDrivers();
        updateDriverSelects();

        const avNow = drivers.filter(d => (d.status || d.availability) === 'Ù…ØªØ§Ø­').length;
        const avEl = document.getElementById('availableDriversCount');
        if (avEl) avEl.textContent = avNow ? `(${avNow})` : '';
      } catch(e) {
        if (!cached) list.innerHTML = `<div class="alert alert-warning">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.</div>`;
        drivers = [];
        updateDriverSelects();
        const avEl = document.getElementById('availableDriversCount');
        if (avEl) avEl.textContent = '';
      }
    }

    function displayDrivers(arr = drivers) {
      const list = $('#driversList');
      if (!arr || arr.length === 0) {
        list.innerHTML = `<div class="alert alert-info">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
        return;
      }

      const isDriverUser = currentUser?.userType === 'Ø³Ø§Ø¦Ù‚';
      list.innerHTML = '';

      arr.forEach(d => {
        const phone = d.phone || d.whatsapp || d.mobile || '';     // âœ… ØªØ¹Ø±ÙŠÙ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
        const hasPhone = /^9665\d{8}$/.test(phone);                // âœ… ØªØ­Ù‚Ù‚ Ù…ÙˆØ­Ù‘Ø¯
        const status    = d.status || d.availability || 'Ù…ØªØ§Ø­';    // ÙÙˆÙ„-Ø¨Ø§Ùƒ Ù„Ù„Ø­Ø§Ù„Ø©
        const ratingValue = Number(d.rating ?? d.avgRating ?? 0);

        const statusClass = (status === 'Ù…ØªØ§Ø­') ? 'status-available' : 'status-booked';
        const ratingStars = 'â­'.repeat(Math.max(0, Math.min(5, Math.floor(ratingValue))));
        const waText = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ ' + (d.name || '') + 'ØŒ Ø£Ù†Ø§ ' + (currentUser ? currentUser.name : 'Ù…ØªØ¯Ø±Ø¨') + ' Ù…Ù† Ù…Ù†ØµØ© Ø³Ø§Ù†Ø¯. Ø£ÙˆØ¯ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¨Ø®ØµÙˆØµ Ø§Ù„ØªÙˆØµÙŠÙ„.';
        const waUrl  = hasPhone ? `https://wa.me/${encodeURIComponent(phone)}?text=${encodeURIComponent(waText)}` : '#';
        const waBtnHTML    = hasPhone ? `<a class="btn btn-whatsapp" target="_blank" rel="noopener" href="${waUrl}">ğŸ“± ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</a>`
                                      : `<button class="btn btn-whatsapp" type="button" disabled title="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨">ğŸ“± ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</button>`;

        const normId       = String(d.traineeId || '').trim().toUpperCase();
        const quickBtnHTML = (!isDriverUser && status === 'Ù…ØªØ§Ø­')
          ? `<button class="btn btn-primary" data-quick="${normId}" type="button">âš¡ Ø­Ø¬Ø² Ø³Ø±ÙŠØ¹</button>`
          : (status !== 'Ù…ØªØ§Ø­' ? `<p style="color:#dc3545;font-weight:700">ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹</p>` : ``);


        const card = document.createElement('div');
        card.className = 'driver-card';
        card.innerHTML = `
          <div class="driver-info">
            <div class="driver-details">
              <h3>${d.name || '-'}</h3>
              <p><strong>ğŸ˜ï¸ Ø§Ù„Ø­ÙŠ:</strong> ${d.neighborhood || '-'}</p>
              <p><strong>ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨:</strong> ${d.traineeId || '-'}</p>
              <p><strong>â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</strong> <span class="rating">${ratingStars}</span> (${isNaN(ratingValue) ? '-' : ratingValue})</p>
              <p><strong>ğŸš— Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø­Ù„Ø§Øª:</strong> ${d.trips || 0}</p>
              <span class="${statusClass}">${status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
            </div>
            <div>
              ${waBtnHTML}
              ${quickBtnHTML}
            </div>
          </div>`;
        list.appendChild(card);
      });

      // Ù…Ø³ØªÙ…Ø¹ Ø²Ø± "Ø­Ø¬Ø² Ø³Ø±ÙŠØ¹"
      $$('#driversList [data-quick]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = String(btn.getAttribute('data-quick') || '').trim().toUpperCase();
          const driver = drivers.find(x => String(x.traineeId || '').trim().toUpperCase() === id);
          if (!driver) { showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø®ØªØ§Ø±','warn'); return; }

          lastQuickDriverId = id;
          document.querySelector('.tab[data-tab="book"]')?.click();
          updateDriverSelects(id); // ÙŠÙ…Ù„Ø£ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆÙŠØ®ØªØ§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ø¨Ø§Ø´Ø±Ø©
          showToast(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${driver.name} ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ âœ…`,'success');
        });
      });
    }



    function filterDriversByNeighborhood() {
      const val = $('#filterNeighborhood').value;
      if(!val) return displayDrivers();
      displayDrivers(drivers.filter(d => d.neighborhood === val));
    }

    function updateDriverSelects(preselectId = null) {
      const available = drivers.filter(d => (d.status || d.availability) === 'Ù…ØªØ§Ø­');
      const selBook = $('#selectedDriver');
      if (!selBook) return;

      const prev = String(selBook.value || '').trim().toUpperCase();
      selBook.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚</option>`;

      available.forEach(d => {
        const rv = Number(d.rating ?? d.avgRating ?? 0);
        const val = String(d.traineeId || '').trim().toUpperCase();
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = `${d.name} - ${d.neighborhood || '-'} (â­${isNaN(rv)?'-':rv})`;
        selBook.appendChild(opt);
      });

      const target = String(preselectId || lastQuickDriverId || prev || '').trim().toUpperCase();
      if (target) {
        const found = Array.from(selBook.options).some(o => String(o.value).toUpperCase() === target);
        if (found) selBook.value = target;
      }
    }
    function fmtDateTime(v){
      if (v == null || v === '') return '-';

      let d;
      if (typeof v === 'number') {
        d = (v > 1e10) ? new Date(v)               // Unix ms
                      : new Date(Date.UTC(1899,11,30) + v*86400000); // Google Sheets serial
      } else {
        d = new Date(String(v).trim());            // ISO/Text
      }
      if (isNaN(d)) return '-';

      // Ù…ÙŠÙ„Ø§Ø¯ÙŠ Ø¹Ø±Ø¨ÙŠ + ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø±ÙŠØ§Ø¶
      return new Intl.DateTimeFormat('ar-SA-u-ca-gregory', {
        dateStyle: 'medium',
        timeStyle: 'short',
        hour12: false,
        timeZone: 'Asia/Riyadh',
        numberingSystem: 'arab' // Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ©Ø› Ø§Ø­Ø°ÙÙ‡Ø§ Ù„Ùˆ ØªØ¨ØºÙ‰ 123
      }).format(d);
    }




    async function loadUserRequests() {
      if (!currentUser) return;

      const list = $('#userRequestsList');
      list.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
        </div>`;
      approvedPartners = [];

      try {
        const role = currentUser.userType;

        // ===== Ø³Ø§Ø¦Ù‚ =====
        if (role === 'Ø³Ø§Ø¦Ù‚') {
          const res = await sendToGoogleSheets('getDriverRequests', {
            driverTraineeId: currentUser.traineeId
          });

          if (res && res.success) {
            const reqs = (res && res.data && Array.isArray(res.data.requests))
              ? res.data.requests
              : [];

            const pendingCount = reqs.filter(r => r.status === 'Ù…Ø¹Ù„Ù‚').length;
            updateRequestsBadge(pendingCount);

            if (!reqs.length) {
              list.innerHTML = `<div class="alert alert-info">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
              return;
            }

            // Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            displayDriverRequests(reqs);

            // Ø¬Ù‡Ù‘Ø² Ø£Ø·Ø±Ø§Ù Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ù…
            reqs
              .filter(r => r.status === 'Ù…Ù‚Ø¨ÙˆÙ„')
              .forEach(r => {
                approvedPartners.push({
                  id: String(r.passengerTraineeId || '').trim().toUpperCase(),
                  name: r.passengerName,
                  phone: r.passengerPhone,
                  type: 'Ø±Ø§ÙƒØ¨'
                });
              });

            return;
          }

          // ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ØªÙƒÙ† success
          list.innerHTML = `<div class="alert alert-info">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
          updateRequestsBadge(0);
          return;
        }

        // ===== Ù…ØªØ¯Ø±Ø¨ (Ø±Ø§ÙƒØ¨) Ø£Ùˆ ÙƒÙ„Ø§Ù‡Ù…Ø§ (Ù†ÙØ¹Ø§Ù…Ù„Ù‡Ø§ ÙƒØ±Ø§ÙƒØ¨ Ù‡Ù†Ø§) =====
        const res = await sendToGoogleSheets('getPassengerRequests', {
          passengerTraineeId: currentUser.traineeId
        });

        if (res && res.success) {
          const reqs = Array.isArray(res.data) ? res.data : [];

          const pendingCount = reqs.filter(r => r.status === 'Ù…Ø¹Ù„Ù‚').length;
          updateRequestsBadge(pendingCount);

          if (!reqs.length) {
            list.innerHTML = `<div class="alert alert-info">Ù„Ù… ØªØ±Ø³Ù„ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯</div>`;
            return;
          }

          // Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
          displayPassengerRequests(reqs);

          // Ø¬Ù‡Ù‘Ø² Ø£Ø·Ø±Ø§Ù Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ù…
          reqs
            .filter(r => r.status === 'Ù…Ù‚Ø¨ÙˆÙ„')
            .forEach(r => {
              approvedPartners.push({
                id: String(r.driverTraineeId || '').trim().toUpperCase(),
                name: r.driverName,
                phone: r.driverPhone,
                type: 'Ø³Ø§Ø¦Ù‚'
              });
            });

          return;
        }

        // ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ØªÙƒÙ† success
        list.innerHTML = `<div class="alert alert-info">Ù„Ù… ØªØ±Ø³Ù„ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯</div>`;
        updateRequestsBadge(0);

      } catch (e) {
        list.innerHTML = `<div class="alert alert-warning">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.</div>`;
        updateRequestsBadge(0);
      }
    }

    function displayDriverRequests(requests) {
      const list = $('#userRequestsList');
      if(!requests.length) {
        list.innerHTML = `<div class="alert alert-info">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
        return;
      }
      
      list.innerHTML = '';
      requests.forEach(r => {
        const statusClass = r.status === 'Ù…Ø¹Ù„Ù‚' ? 'status-pending' : 
                           (r.status === 'Ù…Ù‚Ø¨ÙˆÙ„' ? 'status-accepted' : 'status-rejected');
        const wrap = document.createElement('div');
        wrap.className = `request-card ${r.status === 'Ù…Ù‚Ø¨ÙˆÙ„' ? 'accepted' : r.status === 'Ù…Ø±ÙÙˆØ¶' ? 'rejected' : ''}`;
        const waText = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ ' + (r.passengerName || '') + 'ØŒ Ø¨Ø®ØµÙˆØµ Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…Ù† Ù…Ù†ØµØ© Ø³Ø§Ù†Ø¯...';
        const waUrl = r.passengerPhone ? `https://wa.me/${encodeURIComponent(r.passengerPhone)}?text=${encodeURIComponent(waText)}` : '#';


        wrap.innerHTML = `
          <div class="request-header">
            <div class="request-title">Ø·Ù„Ø¨ Ù…Ù† ${r.passengerName || '-'}</div>
            <span class="request-status ${statusClass}">${r.status || '-'}</span>
          </div>
          <div class="request-details">
            <p><strong>ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨:</strong> ${r.passengerTraineeId || '-'}</p>
            <p><strong>ğŸ˜ï¸ Ø§Ù„Ø­ÙŠ:</strong> ${r.passengerNeighborhood || '-'}</p>
            <p><strong>ğŸ“… Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</strong> ${(r.selectedDays || []).join(', ')}</p>
            <p><strong>â° Ù…Ø¯Ø© Ø§Ù„Ø­Ø¬Ø²:</strong> ${r.duration || '-'}</p>
            <p><strong>ğŸ“‹ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</strong> ${fmtDateTime(r.requestDate)}</p>
            ${r.notes ? `<p><strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${r.notes}</p>` : ''}
          </div>
          <div class="request-actions">
            ${r.status === 'Ù…Ø¹Ù„Ù‚' ? `
              <button class="btn btn-accept" data-rsp='{"id":"${r.id}","resp":"Ù…Ù‚Ø¨ÙˆÙ„"}' type="button">âœ… Ù…ÙˆØ§ÙÙ‚</button>
              <button class="btn btn-reject" data-rsp='{"id":"${r.id}","resp":"Ù…Ø±ÙÙˆØ¶"}' type="button">âŒ Ø±ÙØ¶</button>
            ` : ''}
            <a class="btn btn-contact btn-whatsapp" target="_blank" rel="noopener" href="${waUrl}">ğŸ“± ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡</a>
          </div>`;
        list.appendChild(wrap);
      });

      $$('#userRequestsList [data-rsp]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const data = JSON.parse(btn.getAttribute('data-rsp'));
          const ok = confirm(data.resp === 'Ù…Ù‚Ø¨ÙˆÙ„' ? 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©ØŸ' : 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±ÙØ¶ØŸ');
          if(!ok) return;
          
          try {
            const res = await sendToGoogleSheets('respondToRequest', {
              requestId: data.id, 
              response: data.resp, 
              driverTraineeId: currentUser.traineeId
            });
            if(res && res.success) { 
              showToast('ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…','success');
            } else { 
              showToast(res?.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹','error');
            }
          } catch(e) { 
            showToast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.','error');
          }
          loadUserRequests();
        });
      });
    }

    function displayPassengerRequests(requests) {
      const list = $('#userRequestsList');
      if(!requests.length) {
        list.innerHTML = `<div class="alert alert-info">Ù„Ù… ØªØ±Ø³Ù„ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯</div>`;
        return;
      }
      
      list.innerHTML = '';
      requests.forEach(r => {
        const state = r.status;
        const statusClass = state === 'Ù…Ø¹Ù„Ù‚' ? 'status-pending' : 
                           (state === 'Ù…Ù‚Ø¨ÙˆÙ„' ? 'status-accepted' : 'status-rejected');
        const icon = state === 'Ù…Ø¹Ù„Ù‚' ? 'â³' : (state === 'Ù…Ù‚Ø¨ÙˆÙ„' ? 'âœ…' : 'âŒ');
        const msg = state === 'Ù…Ù‚Ø¨ÙˆÙ„' ? 'ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ! Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø³ÙŠØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ' : 
                   (state === 'Ù…Ø±ÙÙˆØ¶' ? 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±' : 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚');
        const waText = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ ' + (r.driverName || '') + 'ØŒ Ø¨Ø®ØµÙˆØµ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡ Ù…Ù† Ù…Ù†ØµØ© Ø³Ø§Ù†Ø¯...';
        const waUrl = r.driverPhone ? `https://wa.me/${encodeURIComponent(r.driverPhone)}?text=${encodeURIComponent(waText)}` : '#';


        const wrap = document.createElement('div');
        wrap.className = `request-card ${state === 'Ù…Ù‚Ø¨ÙˆÙ„' ? 'accepted' : state === 'Ù…Ø±ÙÙˆØ¶' ? 'rejected' : ''}`;
        
        wrap.innerHTML = `
          <div class="request-header">
            <div class="request-title">${icon} Ø·Ù„Ø¨ Ù„Ù„Ø³Ø§Ø¦Ù‚ ${r.driverName || '-'}</div>
            <span class="request-status ${statusClass}">${state || '-'}</span>
          </div>
          <div class="request-details">
            <p><strong>ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚:</strong> ${r.driverTraineeId || '-'}</p>
            <p><strong>ğŸ“… Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</strong> ${(r.selectedDays || []).join(', ')}</p>
            <p><strong>â° Ù…Ø¯Ø© Ø§Ù„Ø­Ø¬Ø²:</strong> ${r.duration || '-'}</p>
            <p><strong>ğŸ“‹ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</strong> ${fmtDateTime(r.requestDate)}</p>
            <div class="alert ${state === 'Ù…Ù‚Ø¨ÙˆÙ„' ? 'alert-success' : state === 'Ù…Ø±ÙÙˆØ¶' ? 'alert-warning' : 'alert-info'}">${msg}</div>
          </div>
          <div class="request-actions">
            ${state === 'Ù…Ù‚Ø¨ÙˆÙ„' ? `
              <a class="btn btn-contact btn-whatsapp" target="_blank" rel="noopener" href="${waUrl}">ğŸ“± ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚</a>
            ` : state === 'Ù…Ø±ÙÙˆØ¶' ? `
              <button class="btn" type="button" onclick="document.querySelector('.tab[data-tab=\\'drivers\\']').click()">ğŸ” Ø§Ø®ØªØ± Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±</button>
            ` : `<p style="color:#666;font-style:italic">Ø³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ Ø¹Ù†Ø¯ Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚</p>`}
          </div>`;
        list.appendChild(wrap);
      });
    }

    function populateRatingOptions() {
      const sel = $('#ratedDriver');
      sel.innerHTML = `<option value="">Ø§Ø®ØªØ±</option>`;
      if(!approvedPartners.length) return;
      approvedPartners.forEach(p => {
        const opt = document.createElement('option');
        opt.value = String(p.id).trim().toUpperCase();
        opt.textContent = `${p.name}`;
        opt.dataset.phone = p.phone || '';
        opt.dataset.type = p.type;
        sel.appendChild(opt);
      });
    }

    async function handleBooking(e) {
      if(appMode !== 'app'){ showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹','warn'); return; }

      e.preventDefault();
      if(!currentUser) {
        showToast('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }

      const bookingBtn = $('#bookingBtn');
      bookingBtn.disabled = true;
      bookingBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

      const selectedDays = $$('#daysGroup input[type="checkbox"]:checked').map(x => x.value);
      if(selectedDays.length === 0) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©','warn');
        bookingBtn.disabled = false;
        bookingBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØµÙŠÙ„';
        return;
      }

      const driverId = String($('#selectedDriver').value || '').trim().toUpperCase();
      const driver   = drivers.find(d => String(d.traineeId || '').trim().toUpperCase() === driverId);
      if(!driver) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚','warn');
        bookingBtn.disabled = false;
        bookingBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØµÙŠÙ„';
        return;
      }

      function getLocalISO() {
        const now = new Date();
        const tz = -now.getTimezoneOffset(); // ÙØ±Ù‚ Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
        const sign = tz >= 0 ? '+' : '-';
        const hh = String(Math.floor(Math.abs(tz)/60)).padStart(2,'0');
        const mm = String(Math.abs(tz)%60).padStart(2,'0');
        return now.toISOString().replace('Z', `${sign}${hh}:${mm}`);
      }

      const durationValue = Number($('#duration').value);
      if(!durationValue) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯Ø© Ø§Ù„Ø­Ø¬Ø²','warn');
        bookingBtn.disabled = false;
        bookingBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØµÙŠÙ„';
        return;
      }
      const driverPhone = driver.phone || driver.whatsapp || driver.mobile || '';

      const durationLabel = {1:'Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ø­Ø¯',2:'Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†',3:'3 Ø£Ø³Ø§Ø¨ÙŠØ¹',4:'Ø´Ù‡Ø± ÙƒØ§Ù…Ù„'}[durationValue] || (durationValue + ' Ø£Ø³Ø§Ø¨ÙŠØ¹');

      const bookingData = {
        passengerName: currentUser.name,
        passengerTraineeId: currentUser.traineeId,
        passengerPhone: currentUser.phone,
        passengerNeighborhood: currentUser.neighborhood,
        driverName: driver.name,
        driverTraineeId: driver.traineeId,
        driverPhone: driverPhone,
        selectedDays,
        duration: durationLabel,
        notes: $('#tripNotes').value,
        requestDate: getLocalISO()   // âœ… Ù…Ù‡Ù…
      };

      try {
        const saveRes = await sendToGoogleSheets('submitBooking', bookingData);
        if(!(saveRes && saveRes.success)) {
          showToast(saveRes?.error || 'ØªØ¹Ø°Ù‘Ø± Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø³Ø§Ù†Ø¯.','error');
          bookingBtn.disabled = false;
          bookingBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØµÙŠÙ„';
          return;
        }
      } catch(e) {
        showToast('ØªØ¹Ø°Ù‘Ø± Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø§ØªØµØ§Ù„.','error');
        bookingBtn.disabled = false;
        bookingBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØµÙŠÙ„';
        return;
      }

      const msgLines = [
        'ğŸš— Ø·Ù„Ø¨ ØªÙˆØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù…Ù†ØµØ© Ø³Ø§Ù†Ø¯',
        '',
        'Ù…Ø±Ø­Ø¨Ø§Ù‹ ' + (bookingData.driverName || '') + 'ØŒ',
        '',
        'Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ ØªÙˆØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù…Ù†:',
        'ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ' + (bookingData.passengerName || ''),
        'ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨: ' + (bookingData.passengerTraineeId || ''),
        'ğŸ“ Ø§Ù„Ø­ÙŠ: ' + (bookingData.passengerNeighborhood || ''),
        'ğŸ“… Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ' + selectedDays.join(', '),
        'â° Ù…Ø¯Ø© Ø§Ù„Ø­Ø¬Ø²: ' + (bookingData.duration || '')
      ];
      if (bookingData.notes) msgLines.push('ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ' + bookingData.notes);
      msgLines.push('', 'Ù„Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø§Ø¯Ø®Ù„ Ù…Ù†ØµØ© Ø³Ø§Ù†Ø¯ ÙˆØ§Ø®ØªØ± Ù…ÙˆØ§ÙÙ‚/Ø±ÙØ¶.', 'Ø£Ùˆ ØªÙˆØ§ØµÙ„ Ù…Ø¹ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.');

      const msg = msgLines.join('\n');

      if (driverPhone) {
        const waUrl = `https://wa.me/${encodeURIComponent(driverPhone)}?text=${encodeURIComponent(msg)}`;
        window.open(waUrl, '_blank', 'noopener');
      } else {
        showToast('Ù…Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø³Ø¬Ù‘Ù„','warn');
      }



      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ âœ…','success');

      e.target.reset();
      // Ø­Ù…Ù‘Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ­Ø¯Ø« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹
      await loadUserRequests();
      await updateUserStats();
      // Ø¨Ø¹Ø¯Ù‡Ø§ ÙØ¹Ù‘Ù„ Ø§Ù„Ø²Ø± ÙˆØºÙŠÙ‘Ø± Ø§Ù„Ù†Øµ
      bookingBtn.disabled = false;
      bookingBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØµÙŠÙ„';

    }

    async function handleRating(e) {
      if(appMode !== 'app'){ showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹','warn'); return; }

      e.preventDefault();
      if(!currentUser) {
        showToast('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      
      const ratingBtn = $('#ratingBtn');
      ratingBtn.disabled = true;
      ratingBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

      const partnerId = String($('#ratedDriver').value).trim().toUpperCase();
      const partner = approvedPartners.find(p => String(p.id).trim().toUpperCase() === partnerId);
      if(!partner) {
        showToast('Ø§Ø®ØªØ± Ø·Ø±ÙØ§Ù‹ ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„ÙŠÙ‡');
        ratingBtn.disabled = false;
        ratingBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…';
        return;
      }

      const ratingData = {
        targetType: partner.type,
        targetName: partner.name,
        targetTraineeId: partner.id,
        raterName: currentUser.name,
        raterTraineeId: currentUser.traineeId,
        stars: $('#ratingStars').value,
        notes: $('#ratingNotes').value
      };

      try {
        const res = await sendToGoogleSheets('submitRating', ratingData);
        if(res && res.success) {
          showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­ âœ…','success');
        } else {
          showToast(res?.error || 'ØªØ¹Ø°Ù‘Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…','error');
        }
      } catch(e) {
        showToast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ….','error');
      } finally {
        e.target.reset();
        ratingBtn.disabled = false;
        ratingBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…';
      }
    }



    async function updateUserStats() {
      try {
        const topR = await fetchWithCache('getTopStats', {}, { ttl: CACHE_TTL.getTopStats });
        const top = topR?.data || null;
        $('#communitySize').textContent = resolveCommunityCount(top);
      } catch { $('#communitySize').textContent = '-'; }

      if(!currentUser){
        $('#myTripsCount').textContent='-'; $('#myRating').textContent='-'; $('#myActiveRequests').textContent='-';
        return;
      }

      try {
        const r = await fetchWithCache('getUserStats', {
          traineeId: currentUser.traineeId, userType: currentUser.userType
        }, { ttl: CACHE_TTL.getUserStats });
        const d = r?.data;
        $('#myTripsCount').textContent    = d?.totalTrips ?? '-';
        $('#myRating').textContent        = d?.rating ?? '-';
        $('#myActiveRequests').textContent= d?.activeRequests ?? '-';
      } catch {
        $('#myTripsCount').textContent='-'; $('#myRating').textContent='-'; $('#myActiveRequests').textContent='-';
      }
    }


    function pick(v){ return (v ?? undefined); }
    function resolveCommunityCount(d){
      return pick(d?.totalUsers) ?? pick(d?.communitySize) ?? pick(d?.activeUsers) ?? pick(d?.members) ?? '-';
    }

    async function updateTopStats(prefetched){
      try{
        const r = prefetched ? { data: prefetched } : await fetchWithCache('getTopStats', {}, { ttl: CACHE_TTL.getTopStats });
        const d = r?.data || null;
        $('#totalUsersHeader').textContent   = resolveCommunityCount(d);
        $('#totalTripsHeader').textContent   = (d?.totalTrips ?? d?.trips ?? '-');
        $('#satisfactionHeader').textContent = (d?.satisfaction ?? d?.avgRating ?? '-') || '-';

        if (document.getElementById('availableDriversCount')) {
          const av = (d && (d.activeDrivers ?? d.availableDrivers)) ?? '';
          document.getElementById('availableDriversCount').textContent = av !== '' ? `(${av})` : '';
        }
        if (!currentUser && (d?.pendingRequests ?? d?.pending) != null) {
          updateRequestsBadge(Number(d.pendingRequests ?? d.pending) || 0);
        }
      }catch{
        $('#totalUsersHeader').textContent='-';
        $('#totalTripsHeader').textContent='-';
        $('#satisfactionHeader').textContent='-';
      }
    }

  </script>
  <div id="toastWrap" style="position:fixed;inset-inline-start:20px;bottom:20px;z-index:9999;display:flex;flex-direction:column;gap:10px"></div>
</body>
</html>
