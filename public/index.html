<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ุณุงูุฏ - ูุธุงู ุชูุตูู ุงููุชุฏุฑุจูู</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      /* ููุญุฉ TVTC ุชูุฑูุจูุฉ */
      --tvtc-blue:#1e3c72;   /* ุฃุฒุฑู ุฑุฆูุณู */
      --tvtc-teal:#00a49a;   /* ุฃุฎุถุฑ ููุฒุฑู */
      --tvtc-navy:#0b1f3a;   /* ุฃุฒุฑู ุฏุงูู */

      --bg-grad:linear-gradient(135deg,var(--tvtc-blue) 0%,var(--tvtc-teal) 100%);
      --header-grad:linear-gradient(135deg,var(--tvtc-navy) 0%,var(--tvtc-blue) 100%);

      --card-bg:#fff;
      --text:#1f2937;
      --muted:#495057;
      --border:#e9ecef;

      /* ุดุฑุงุฆุญ ุงูุญุงูุฉ */
      --chip-ok-bg:#d4edda;  --chip-ok-text:#155724;
      --chip-warn-bg:#fff3cd;--chip-warn-text:#856404;
      --chip-bad-bg:#f8d7da; --chip-bad-text:#721c24;

      /* ุจุทุงูุงุช ุงูุทูุจ */
      --req-warn-bg:#fff8e1; --req-warn-bd:#ffcc02;
      --req-acc-bg:#e8f5e8;  --req-acc-bd:#4caf50;
      --req-rej-bg:#ffebee;  --req-rej-bd:#f44336;
    }

        :root{
      --base-fs: 20px; /* ุงูุฃุณุงุณ ุงูุญุงูู */
    }

    /* ุฎููู ุงูู rem ูุนุชูุฏ ุนูู ุงููุชุบูุฑ */
    html{ font-size: var(--base-fs); }

    /* ุงููุถุน ุงูุฏุงูู */
    .dark{
      --bg-grad:linear-gradient(135deg,#0f172a 0%,#0b1f3a 100%);
      --card-bg:#111827;
      --text:#e5e7eb;
      --muted:#cbd5e1;
      --border:#374151;
      --header-grad:linear-gradient(135deg,#0b1f3a 0%,#1e3c72 100%);

      --chip-ok-bg:#064e3b; --chip-ok-text:#a7f3d0;
      --chip-warn-bg:#92400e; --chip-warn-text:#fde68a;
      --chip-bad-bg:#7f1d1d; --chip-bad-text:#fecaca;

      --req-warn-bg:#2a2610; --req-warn-bd:#b69100;
      --req-acc-bg:#11331a;  --req-acc-bd:#3aa85e;
      --req-rej-bg:#3a1618;  --req-rej-bd:#cc3535;
    }
    /* ุฎุท ุฃุณุงุณู + ุจุฏุงุฆู ุนุฑุจูุฉ ุขููุฉ */
    body{
      font-family: 'Sakkal Majalla','Noto Naskh Arabic','Cairo','Tajawal','Segoe UI','Tahoma',sans-serif;
      background:var(--bg-grad);
      min-height:100vh;
      color:var(--text);
      padding:20px;
      padding-bottom:200px;  /* โ ุฒูุงุฏุฉ ูุจูุฑุฉ */
    }

    /* ุชุญุณูู ูุถูุญ ุงูุญุฑูู */
    html,body{
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }


    
      /* Card ููุญุฏ ููุฎุทูุงุช */
      .card {
        background: var(--card-bg);
        border: 1px solid rgba(0,0,0,.06);
        border-radius: 16px;
        box-shadow: 0 6px 18px rgba(0,0,0,.06);
        padding: 18px;
      }

      /* ุฒุฑ Primary ู Outline (ููุณ ุงูุฃููุงู) */
      .btn-primary {
        background: linear-gradient(135deg, var(--tvtc-blue), var(--tvtc-teal));
      }
      .btn-outline {
        background: transparent;
        color: var(--tvtc-blue);
        border: 2px solid var(--tvtc-blue);
      }
      .dark .btn-outline {
        color: #e5e7eb;
        border-color: #e5e7eb33;
      }

      /* ุชุฑููุฒ ุงูุญููู */
      .form-control:focus {
        outline: none;
        border-color: var(--tvtc-blue);
        box-shadow: 0 0 0 3px rgba(30, 60, 114, .15);
      }

      /* ุดุงุฑุฉ ุงููุณู (Pill) ุฃุฎู */
      .section-pill {
        display:inline-block;
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--card-bg);
        font-weight: 700;
      }
    /* ุญุงููุฉ ุฑุฆูุณูุฉ */
    .container{
      max-width:1040px;
      margin:0 auto 180px auto;  /* โ ุฒูุงุฏุฉ ุงููุณุงูุฉ */
      border-radius:15px;
      box-shadow:0 20px 40px rgba(0,0,0,.1);
      overflow:hidden;
      background:var(--card-bg);
    }
    /* ููุฏุฑ */
    .header{
      background:var(--header-grad);
      color:#fff;
      padding:18px 10px;
    }

    /* ุงูููุฏุฑ: ุฃุนุทู ุงูุนููุฏ ุงูุฃูู ุนุฑุถูุง ูุงูููุง */
    .header-bar{
      display:grid;
      grid-template-columns: 1fr auto 1fr;  /* ุนููุฏ ุฃูุณุฑ ูุงุฑุบุ ุนููุฏ ูุณุท ููุดุนุงุฑุ ุนููุฏ ุฃููู ููุฃุฒุฑุงุฑ */
      align-items:center;
      gap:12px;
      position: relative;
    }




    .user-name{font-weight:700}
    .role-badge{
      background:#0ea5e9;
      color:#fff;
      padding:4px 10px;
      border-radius:999px;
      font-size:.85rem;
    }

    .user-actions{display:flex;align-items:center;grid-column: 3;justify-self:end}
    .logout-btn{
      background:#ef4444;
      color:#fff;border:none;border-radius:8px;
      padding:8px 14px;font-weight:700;cursor:pointer;transition:.2s
    }
    .logout-btn:hover{background:#dc2626}


    /* ุดุนุงุฑ ููุฏูุณ ุนููุฏููุง */
    /* 2) ุงููุต ูู ุงูููุชุตู */
      /* ุถุน ุงููุชูุฉ ูู ุงูุนููุฏ ุงูุฃูุณุท ููุณูุท ุงููุต */
      .brand-inline{
        grid-column: 2;        /* ุงูุนููุฏ ุงูุฃูุณุท */
        justify-self: center;
        text-align: center;
      }
      
      .brand-inline .brand-logo-tall{
        position: static !important;   /* ุฅูุบุงุก ุงูู absolute */
        height: 64px;                  /* ุฃู 72px ุญุณุจ ุฑุบุจุชู */
        width: auto;
        transform: none !important;
        right: auto !important;
        left: auto !important;
        top: auto !important;
        margin: 0 auto;                /* ุชูุณูุท ุฏุงุฎู ุงูุนููุฏ ุงูุฃูุณุท */
      }
    .brand-stack{display:flex;flex-direction:column;align-items:center;gap:8px;min-width:0}
    .brand-logo-tall{height:72px;width:auto;display:block;margin:0 auto;filter:drop-shadow(0 2px 4px rgba(0,0,0,.15))}
    .brand-text .logo{font-size:1.6rem;line-height:1.1;font-weight:800;white-space:nowrap}
    .brand-text .tagline{font-size:.95rem;opacity:.9;line-height:1.1}

    /* ุดุฑูุท ุงูุฃุฑูุงู ูู ุงูุฃุนูู */
    .stats-bar{display:flex;justify-content:center;gap:28px;margin-top:10px}
    .stat-item{text-align:center}
    .stat-number{font-size:1.2rem;font-weight:700}
    .stat-label{font-size:.85rem;opacity:.95}

    /* ููุทูุฉ ุงูุฏุฎูู */
    .login-section{padding:35px;background:linear-gradient(135deg,#f8f9fa 0%,#ffffff 100%);border-bottom:1px solid #e9ecef}
    .login-container{max-width:520px;margin:0 auto;text-align:center}
    .welcome-message{font-size:1.15rem;color:#2c5aa0;margin-bottom:18px;font-weight:700}
    .login-form{display:none;animation:fade .45s}
    .login-form.active{display:block}

    /* ุชุจููุจุงุช */
    .tabs{display:none;background:#f8f9fa;border-bottom:1px solid #dee2e6}
    .tabs.active{display:flex;flex-wrap:wrap}
    .tab{flex:1;padding:14px 10px;text-align:center;cursor:pointer;transition:.2s;background:#fff;border:0;font-size:1.02rem;font-weight:700;color:#495057;position:relative}
    .tab:hover{background:#e9ecef}
    .tab.active{background:#2c5aa0;color:#fff}
    .tab.badged .badge{
      position:absolute;top:6px;inset-inline-end:10px;background:#ef4444;color:#fff;min-width:20px;height:20px;
      padding:0 6px;border-radius:999px;font-size:.8rem;display:flex;align-items:center;justify-content:center;font-weight:800
    }

    /* ูุญุชูู */
    .content{padding:22px;min-height:440px;display:none}
    .content.active{display:block}
    @keyframes fade{from{opacity:.3;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}


          /* ===== Fix footer overlap & stacking ===== */
      :root{
        --footer-h: 58px;     /* ุณููุณุชุจุฏู ุชููุงุฆูุงู ุจุงูุงุฑุชูุงุน ุงูุญูููู ุนุจุฑ JS */
        --statsbar-h: 60px;
        --z-footer: 9000;
        --z-stats: 9050;
        --z-fab: 10050;       /* ุฃุนูู ูู ุงูููุชุฑ */
        --z-tip: 10060;       /* ููุชููุชูุจ/ุงูุดุงุฑุฉ */
      }

      body{
        min-height: 100dvh;
        padding-bottom: calc(var(--footer-h) + var(--statsbar-h) + env(safe-area-inset-bottom,0) + 20px) !important;
      }


      /* โ ุดุฑูุท ุงูุฅุญุตุงุฆูุงุช ุซุงุจุช ูู ุงููุญุชูู */
      .stats-bottom-bar{
        position: static;  /* ุซุงุจุช ูู ุงูุชุฏูู ุงูุทุจูุนู */
        margin-top: 20px;
        padding: 10px 20px;
        background: rgba(15, 23, 42, 0.75);
        backdrop-filter: blur(12px);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        display: flex;
        justify-content: center;
        gap: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      /* โ ุงูููุชุฑ ุซุงุจุช ูู ููุงูุฉ ุงูุตูุญุฉ */
      .site-footer{
        position: static;  /* ุซุงุจุช ูู ุงูุชุฏูู ุงูุทุจูุนู */
        background: linear-gradient(135deg, rgba(30, 60, 114, 0.05), rgba(0, 164, 154, 0.05));
        border-top: 1px solid var(--border);
        padding: 20px;
        margin-top: 20px;
      }


      /* ุงูุฒุฑ ุงูุนุงุฆู/ุงูุชูููุญ/ุงูุดุงุฑุฉ ููู ุงูุฌููุน ูุชุชุญุฑู ุขููุงู */
      .support-fab{
        position: fixed;
        inset-inline-end: 18px;
        bottom: calc(var(--footer-h) + var(--statsbar-h) + env(safe-area-inset-bottom,0) + 10px) !important;
        z-index: var(--z-fab);
      }
      .welcome-support-tooltip,
      .status-badge{
        position: fixed;
        bottom: calc(var(--footer-h) + var(--statsbar-h) + env(safe-area-inset-bottom,0) + 14px) !important;
        z-index: var(--z-tip);
      }

      /* ุถูุงู ุนุฏู ูุตู ุฃู ููุจุซูุงุช */
      .container{ overflow: visible; }

      /* ููููุจุงูู: ููุงุณุงุช ุฃุฎู */
      @media (max-width: 768px){
        :root{ --footer-h: 56px; --statsbar-h: 64px; }
      }

    /* ููุงุฐุฌ */
    .form-group{margin-bottom:16px}
    .form-group label{color:var(--muted)}
    .form-control{width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-size:1rem;transition:.2s;background:var(--card-bg);color:var(--text)}
    .form-control:focus{outline:none;border-color:#2c5aa0;box-shadow:0 0 0 3px rgba(44,90,160,.12)}
    .field-hint{font-size:.85rem;margin-top:6px}
    .field-hint.neutral{color:#6b7280}
    .field-hint.good{color:#16a34a}
    .field-hint.warn{color:#b45309}

    .btn{background:linear-gradient(135deg,#1cb26b 0%,#11a39b 100%);color:#fff;padding:12px 20px;border:none;border-radius:8px;font-weight:800;cursor:pointer;transition:.2s;text-decoration:none;display:inline-block}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,.15)}
    .btn:disabled{background:#6c757d;cursor:not-allowed;transform:none;opacity:.6}
    .btn-primary{background:linear-gradient(135deg,var(--tvtc-blue) 0%,var(--tvtc-teal) 100%)}
    .btn-secondary{background:linear-gradient(135deg,#6c757d 0%,#495057 100%);color:#fff}
    .btn-whatsapp{background:linear-gradient(135deg,#25d366 0%,#128c7e 100%);margin-inline:6px;padding:10px 16px;font-size:.92rem}
    .btn-accept{background:linear-gradient(135deg,#4caf50 0%,#45a049 100%)}
    .btn-reject{background:linear-gradient(135deg,#f44336 0%,#d32f2f 100%)}
    .btn-contact{background:linear-gradient(135deg,#2196f3 0%,#1976d2 100%)}

    .dashboard-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin:16px 0}
    .stat-card{background:linear-gradient(135deg,var(--tvtc-blue) 0%,var(--tvtc-teal) 100%);color:#fff;padding:16px;border-radius:12px;text-align:center}
    .stat-card .stat-number{font-size:1.7rem;margin-bottom:6px}

    .driver-card,.request-card{background:linear-gradient(135deg,rgba(248,249,250,.25) 0%,var(--card-bg) 100%);border:2px solid var(--border);border-radius:12px;padding:18px;margin-bottom:14px;transition:.2s}
    .driver-card:hover,.request-card:hover{border-color:#2c5aa0;transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.08)}

    .request-card{border-color:var(--req-warn-bd);background:linear-gradient(135deg,var(--req-warn-bg) 0%,var(--card-bg) 100%)}
    .request-card.accepted{border-color:var(--req-acc-bd);background:linear-gradient(135deg,var(--req-acc-bg) 0%,var(--card-bg) 100%)}
    .request-card.rejected{border-color:var(--req-rej-bd);background:linear-gradient(135deg,var(--req-rej-bg) 0%,var(--card-bg) 100%)}

    .driver-info,.request-header{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center;margin-bottom:10px}
    .driver-details h3,.request-title{color:#2c5aa0;margin-bottom:6px;font-size:1.06rem}
    .driver-details p,.request-details p{margin-bottom:4px;color:#555}
    .rating{color:#ffc107}

    .status-available,.status-accepted{background:var(--chip-ok-bg);color:var(--chip-ok-text);padding:4px 10px;border-radius:999px;font-weight:700}
    .status-booked,.status-rejected{background:var(--chip-bad-bg);color:var(--chip-bad-text);padding:4px 10px;border-radius:999px;font-weight:700}
    .status-pending{background:var(--chip-warn-bg);color:var(--chip-warn-text);padding:4px 10px;border-radius:999px;font-weight:700}

    .alert{padding:12px;border-radius:8px;margin-bottom:14px}
    .alert-success{background:#d4edda;border:1px solid #c3e6cb;color:#155724}
    .alert-info{background:#cce7ff;border:1px solid #99d6ff;color:#0c5460}
    .alert-warning{background:#fff3cd;border:1px solid #ffeaa7;color:#856404}
    .alert-error{background:#f8d7da;border:1px solid #f5c2c7;color:#721c24}

    .loading{text-align:center;padding:16px}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #2c5aa0;border-radius:50%;width:34px;height:34px;animation:spin 1s linear infinite;margin:0 auto}
    @keyframes spin{to{transform:rotate(360deg)}}

    .checkbox-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:6px}
    .checkbox-item{display:flex;align-items:center;gap:8px}

    /* ุดุฑูุท ุญุงูุฉ ุงูุงุชุตุงู */
    .connbar{display:flex;align-items:center;gap:10px;justify-content:center;background:#0b132b;color:#fff;padding:10px;margin-top:10px;border-radius:12px}
    .conn-dot{width:10px;height:10px;border-radius:50%}
    .conn-online{background:#22c55e}
    .conn-connecting{background:#f59e0b}
    .conn-offline{background:#ef4444}
    .conn-text{font-weight:700}

    /* ุดุงุดุฉ ุชุนุฑูู ุชุบุทู ุงูุตูุญุฉ ูุงููุฉ */
    .intro-screen{position:fixed;inset:0;z-index:9999;display:grid;place-items:center;background:var(--bg-grad);padding:24px;overflow:auto}
    .intro-content{width:min(92vw,860px);max-height:92vh;overflow:auto;background:#ffffffd1;backdrop-filter:blur(6px);border-radius:18px;box-shadow:0 20px 40px rgba(0,0,0,.12);padding:24px;text-align:center}
    .intro-hero{display:block;max-width:100%;height:auto;border-radius:14px;margin:0 auto 14px}
    .intro-start{padding:12px 22px;border:0;border-radius:999px;font-weight:700;cursor:pointer;background:#0f172a;color:#fff;box-shadow:0 8px 18px rgba(0,0,0,.18);margin:10px 6px}
    .intro-start:active{transform:scale(.98)}
    .intro-loader{display:none;font-weight:700;margin-top:8px}
    .intro-loader.show{display:block}
    html:not(.app-ready) .container,
    html:not(.app-ready) .connbar,
    html:not(.app-ready) .site-footer{display:none!important}
    html:not(.app-ready),html:not(.app-ready) body{height:100%;overflow:hidden}
    html.app-ready #intro-screen{display:none!important}

    /* ุฒุฑ ุฏุนู ุนุงุฆู */
    .support-fab{position:fixed;inset-inline-end:18px;bottom:84px;z-index:9998}
    .support-fab button.main{width:52px;height:52px;border:0;border-radius:999px;cursor:pointer;background:linear-gradient(135deg,#1e3c72 0%,#00a49a 100%);color:#fff;font-size:22px;box-shadow:0 12px 28px rgba(0,0,0,.18)}
    .support-menu{position:absolute;inset-inline-end:0;bottom:62px;display:none;gap:8px;flex-direction:column;align-items:flex-end}
    .support-menu a{display:inline-flex;align-items:center;gap:8px;text-decoration:none;color:#fff;background:#111827;border-radius:999px;padding:10px 12px;font-weight:800;box-shadow:0 10px 20px rgba(0,0,0,.15)}
    .support-menu a .ico{width:26px;height:26px;display:grid;place-items:center;border-radius:999px;background:rgba(255,255,255,.12)}
    .support-menu a.wa{background:#128c7e}
    .support-menu a.mail{background:#0b5ed7}
    .support-fab.open .support-menu{display:flex}
    .support-tip.show{opacity:1;transform:translateY(0)}
      /* ุชูููุญ ุชุฑุญูุจู ูุญุณูู */
      .welcome-support-tooltip{
        position: fixed;
        inset-inline-end: 82px;
        bottom: 94px;
        z-index: 9999;
        background: linear-gradient(135deg, #1e3c72 0%, #00a49a 100%);
        color: #fff;
        padding: 0;
        border-radius: 16px;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
        opacity: 0;
        transform: translateX(20px) scale(0.9);
        pointer-events: none;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        max-width: 260px;
        animation: tooltipPulse 2s ease-in-out infinite;
      }

      .welcome-support-tooltip.show{
        opacity: 1;
        transform: translateX(0) scale(1);
        pointer-events: auto;
      }

      @keyframes tooltipPulse{
        0%, 100%{ box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25); }
        50%{ box-shadow: 0 12px 38px rgba(30, 60, 114, 0.4); }
      }

      .tooltip-arrow{
        position: absolute;
        inset-inline-start: 100%;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-inline-start: 10px solid #00a49a;
      }

      .tooltip-content{
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
      }

      .tooltip-icon{
        font-size: 2rem;
        line-height: 1;
        animation: tooltipWave 1.5s ease-in-out infinite;
      }

      @keyframes tooltipWave{
        0%, 100%{ transform: rotate(0deg); }
        25%{ transform: rotate(-15deg); }
        75%{ transform: rotate(15deg); }
      }

      .tooltip-text{
        display: flex;
        flex-direction: column;
        gap: 3px;
      }

      .tooltip-text strong{
        font-size: 0.95rem;
        font-weight: 800;
        line-height: 1.2;
      }

      .tooltip-text span{
        font-size: 0.8rem;
        opacity: 0.9;
        line-height: 1.2;
      }

      /* ุฒุฑ ุฅุบูุงู ุฎูู ููุชูููุญ */
      .welcome-support-tooltip::after{
        content: 'ร';
        position: absolute;
        top: 4px;
        inset-inline-end: 8px;
        font-size: 1.2rem;
        font-weight: 700;
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.2s;
        line-height: 1;
      }

      .welcome-support-tooltip:hover::after{
        opacity: 1;
      }

      /* ููุฌูุงู */
      @media (max-width: 768px){
        .welcome-support-tooltip{
          inset-inline-end: 72px;
          bottom: 154px;
          max-width: 220px;
        }
        
        .tooltip-content{
          padding: 10px 12px;
          gap: 10px;
        }
        
        .tooltip-icon{
          font-size: 1.6rem;
        }
        
        .tooltip-text strong{
          font-size: 0.85rem;
        }
        
        .tooltip-text span{
          font-size: 0.75rem;
        }
      }

      /* ุฅุฎูุงุก ุนูุฏ ุนุฏู ุงูุฌุงูุฒูุฉ */
      html:not(.app-ready) .welcome-support-tooltip{
        display: none !important;
      }
    /* ููุชุฑ ุซุงุจุช */
    .site-footer{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(11, 31, 58, 0.98));
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 9999;
      padding: 8px 16px;  /* ุชูููู ุงููุณุงูุฉ ุงูุฏุงุฎููุฉ */
    }

    .footer-content{
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      max-width: 1040px;
      margin: 0 auto;
    }

    .footer-logo{
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .footer-icon{
      font-size: 2rem;
      line-height: 1;
    }

    .footer-text{
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .footer-text strong{
      font-size: 0.7rem;
      color: rgba(255,255,255,0.6);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }


    .footer-text span{
      font-size: 0.75rem;  /* ุชุตุบูุฑ ุงูุฎุท */
      color: #fff;
      font-weight: 700;
      line-height: 1.3;  /* ุชูููู ุงููุณุงูุฉ ุจูู ุงูุฃุณุทุฑ */
      font-family: 'Cairo', 'Tajawal', sans-serif;
    }

    .footer-institute{
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .institute-badge{
      background: linear-gradient(135deg, var(--tvtc-blue), var(--tvtc-teal));
      color: #fff;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 800;
      box-shadow: 0 2px 8px rgba(30, 60, 114, 0.3);
    }

    .version{
      font-size: 0.65rem;
      color: rgba(255,255,255,0.5);
      font-weight: 600;
    }

    @media (max-width: 768px){
      .site-footer{ padding: 6px 10px; }  /* ูุณุงูุฉ ุฃุตุบุฑ */
      
      .footer-content{
        flex-direction: column;
        text-align: center;
        gap: 12px;
      }
      
      .footer-logo{
        flex-direction: column;
        gap: 8px;
      }
      
      .footer-text{
        align-items: center;
      }
      
      .footer-text strong{
        font-size: 0.65rem;
      }
      
      .footer-text span{
        font-size: 0.7rem;  /* ุฃุตุบุฑ ููุฌูุงู */
        line-height: 1.2;
      }
      
      .footer-institute{
        align-items: center;
      }
      
      .institute-badge{
        font-size: 0.75rem;
        padding: 5px 12px;
      }
    }
    /* ุฑุณุงูุฉ ุชุฑุญูุจ */
    .welcome-banner{
      background: linear-gradient(135deg, #1e3c72, #00a49a);
      color: #fff;
      padding: 12px 20px;
      text-align: center;
      border-radius: 10px;
      margin-bottom: 16px;
      animation: slideDown 0.5s ease-out;
      font-weight: 700;
    }
    @keyframes slideDown{
      from{ opacity: 0; transform: translateY(-20px); }
      to{ opacity: 1; transform: translateY(0); }
    }
    /* ุฃุฏูุงุช */
    .hidden{display:none!important}

    /* ุณูุงูุงุช ุนุงูุฉ ููุชุญููู ุฏุงุฎู ุงูุฌูู */
    .w-thin    { font-weight: 300; }  /* ุฑููุน (ุนูุงููู ูุฑุนูุฉ/ูุต ุซุงููู) */
    .w-regular { font-weight: 400; }  /* ุนุงุฏู */
    .w-bold    { font-weight: 700; }  /* ุนุฑูุถ (ููู) */

    /* ุชุฃููุฏ ูุถูุญ ุงูุนูุงููู ุงููููุฉ */
    .em-high   { font-weight: 700; font-size: 1.05em; letter-spacing: .1px; }
    .em-med    { font-weight: 600; }
    .em-low    { font-weight: 400; opacity: .92; }


    /* ===== ุชูุจูุฑ ูุงุฌูุฉ ุงูุฑุฆูุณูุฉ ููุท ===== */
    #homeContent { 
      font-size: 1.25rem;          /* ููุจูุฑ ูู ูุตูุต ุงููุณู */
      line-height: 1.8;
    }
    #homeContent .section-lead { margin-bottom: 12px; }

    /* ุนููุงู ุงูุชุฑุญูุจ */
    #homeContent h2{
      font-size: clamp(1.9rem, 3vw, 2.4rem);
    }

    /* ุจุทุงูุงุช ุงูุฅุญุตุงุฆูุงุช ูู ุงูุฑุฆูุณูุฉ */
    #homeContent .stat-card .stat-number{
      font-size: clamp(2rem, 3vw, 2.4rem);
    }
    #homeContent .stat-card .stat-label{
      font-size: 1.05rem;
    }

        /* ูุงุตู ุฑููุน ุชุญุช ุงูุดุนุงุฑ */
    .header-split{
      height: 1px;
      background: rgba(255,255,255,.25);
      margin: 10px 0 12px;
    }


    /* ุฒุฑ ูุญุงูุฏ ุตุบูุฑ ููุฃูุดูุงุช (ุงููุถุน ุงูุฏุงูู) */
    .pill-btn{
      background:#111827;
      color:#fff;
      border:none;
      border-radius:8px;
      padding:8px 14px;
      font-weight:700;
      cursor:pointer;
      transition:.2s;
    }
    .pill-btn:hover{ opacity:.9 }


    /* (ุงุฎุชูุงุฑู) ุตุบูุฑ ุงูุดุงุฑุฉ ููููุงู */
    .header-sub .role-badge{ flex: none; }
      

            /* ุงูุญุงูุฉ ุงูุงูุชุฑุงุถูุฉ: ุงููุณุท */
      .header .stats-bar{
        justify-content: center;
      }

      /* ูุจู ุชุณุฌูู ุงูุฏุฎูู: ุชุฃููุฏ ุงูุชูุณูุท */
      .mode-login .header .stats-bar{
        justify-content: center;
      }


            /* Divider ูุณุทู ุจูุต ูู ุงูููุชุตู */
      .section-divider{
        position: relative;
        text-align: center;
        margin: 18px 0 8px;
      }
      .section-divider span{
        display:inline-block;
        background: var(--card-bg);
        padding: 4px 12px;
        font-weight: 800;
        border-radius: 999px;
        border: 2px solid var(--border);
      }
      .section-divider::before{
        content:"";
        position:absolute;
        inset-inline: 0;
        top: 50%;
        height: 2px;
        background: var(--border);
        z-index: 0;
      }
      .section-divider span{ position: relative; z-index: 1; }

      /* ูุต ุชุนุฑููู ุจุณูุท ุชุญุช ุงูุนููุงู */
      .section-lead{
        text-align:center;
        color: var(--muted);
        margin: 6px auto 12px;
        max-width: 820px;
        line-height: 1.8;
      }


            /* ุฃุฎูู ุณุทุฑ ุงูุชุฑุญูุจ ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู */
      .mode-app #homeContent h2{ display:none; }

      /* (ุงุฎุชูุงุฑู) ูููู ุงููุณุงูุฉ ููู ุงูุจุทุงูุงุช ููุง ูุฎุชูู ุงูุนููุงู */
      .mode-app #homeContent .dashboard-stats{ margin-top: 4px; }

      /* ุงูุงุณู + ุงูุดุงุฑุฉ ุนูู ุณุทุฑ ูุงุญุฏ ููุงุตููู */
      .header-sub .user-title{
        display: inline-flex;
        align-items: baseline;
        gap: 10px;
        justify-content: flex-end;     /* RTL: ูููู */
        min-width: 0;
      }

      .header-sub .user-name{
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: clamp(1.2rem, 2.2vw, 1.5rem);
        line-height: 1.4;
        font-weight: 800;
        max-width: min(42vw, 520px);   /* ูุง ูุฒุงุญู ุงูุฅุญุตุงุฆูุงุช */
      }



      /* ุฒุฑ ุงูุฎุฑูุฌ ูุซุจุช ูู ุงูุนููุฏ ุงูุซุงูุซ (ุฃูุตู ุงููุณุงุฑ ูู RTL) */
      .header-sub .logout-btn{
        justify-self: start;
      }

      /* ุงุณุชุฌุงุจุฉ ููุฌูุงู: ุฑุตู ุนููุฏู ูุน ุชูุณูุท ุงููู */
      @media (max-width:768px){
        .header-sub{
          grid-template-columns: 1fr;
          row-gap: 8px;
        }
        .header-sub .user-title{ justify-content: center; }
        .header-sub .stats-bar{ justify-content: center; }
        .header-sub .logout-btn{ justify-self: center; }
                /* ุชุตุบูุฑ ุงูุฎุทูุท */
        body{ font-size: 14px; }

        /* ุชูููู padding ุงูุจุทุงูุงุช */
        .driver-card, .request-card{ padding: 12px; }

        /* ุชุตุบูุฑ ุงูุฃุฒุฑุงุฑ */
        .btn{ padding: 10px 14px; font-size: 0.9rem; }

        /* ุถุจุท ุดุฑูุท ุงูุฅุญุตุงุฆูุงุช ุงูุณููู */
        .stats-bottom-bar{
          flex-direction: column;
          padding: 8px;
          gap: 8px;
        }

        .stat-glass-card{
          width: 100%;
          padding: 10px;
        }

        /* ุฑูุน ุงูุดุงุฑุฉ ููู ูู ุดูุก */
        .status-badge{
          bottom: 160px !important;
          font-size: 0.75rem;
          padding: 6px 10px;
        }

        /* ุฑูุน ุฒุฑ ุงูุฏุนู */
        .support-fab{
          bottom: 140px !important;
          inset-inline-end: 10px;
        }

        /* ุชุตุบูุฑ ุงูููุชุฑ */
        .site-footer{ padding: 6px 10px; }
        .footer-text span{ font-size: 0.7rem; }
      }


    @media (max-width:768px){
      body{
        padding-bottom:260px;  /* โ ุงูุขู ุฏุงุฎู body */
      }
      
      .container{
        margin-bottom:180px;
      }
      
      .header-bar{
        grid-template-columns: 1fr;
      }
      
      .brand-inline{ order: 1; justify-self: center; }
      .user-actions{ order: 2; justify-self: center; }
      .driver-info,.request-header{grid-template-columns:1fr}
      .brand-logo-tall{height:56px}
      .brand-text .logo { font-size: clamp(1.6rem, 2.2vw, 2.1rem); }
      .stat-number { font-size: clamp(1.4rem, 2vw, 1.8rem); }
      .brand-text .tagline{display:none}
      .tabs{flex-direction:column}
    }


    /* ====== Mobile-friendly patch ====== */

      /* ุงุฑุชูุงุนุงุช ููุงุณูุฉ ูุงุจูุฉ ููุชุจุฏูู */
      @media (max-width: 768px){
        :root{
          --footer-h: 50px;
          --statsbar-h: 120px; /* ุฃุทูู ูุฃูู ุนููุฏู ุงูุขู */
        }
      }

      /* ุฎุท ุณุงุฆู ููุฌูุงู: ุฃุตุบุฑ ุนูู ุงูุดุงุดุงุช ุงูุตุบูุฑุฉุ ูุง ูุชุฌุงูุฒ 18px ุนูู ุงููุจูุฑุฉ */
      html{ font-size: clamp(14px, 2.4vw, 18px); }

      /* ุงุนุชูุฏ ุนูู 100dvh ุจุฏูุงู ูู 100vh (ูุนุงูุฌ ุดุฑูุท ุงูุนููุงู ูู iOS) */
      body{
        min-height: 100dvh;
        /* ุจุฏูุงู ูู padding-bottom ุงูุซุงุจุช ุงููุจูุฑ:
          ุงุญุฌุฒ ูุณุงุญุฉ ุขููุฉ ุชุญุช ูุนุฏู ุชุบุทูุฉ ุงูุนูุงุตุฑ ุงูุซุงุจุชุฉ + ุงูููุชุด */
        padding-bottom: calc(
          var(--footer-h) + var(--statsbar-h)
          + env(safe-area-inset-bottom, 0px) + 14px
        ) !important;
      }

      /* ูุง ุชูุทุน ุงูุนูุงุตุฑ ุงูุทูููุฉ ุฏุงุฎู ุงูุญุงููุฉ ุนูู ุงูุฌูุงู */
      .container{
        margin: 0 auto calc(var(--statsbar-h) + 12px) auto;
        overflow: visible; /* ูุงู hidden ููุณุจุจ ูุตู ุนูุงุตุฑ ููุจุซูุฉ/ููุงุฆู */
      }

      /* ุซุจูุช ุงุฑุชูุงุน ุงูููุชุฑุ ูุฃุถู ูุณุงุญุฉ ุขููุฉ ููููุชุด */
      .site-footer{
        height: var(--footer-h);
        padding-block: 8px;
        padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
      }

      /* ุงุฑูุน ุดุฑูุท ุงูุฅุญุตุงุฆูุงุช ููู ุงูููุชุฑ */
      .stats-bottom-bar{
        bottom: calc(var(--footer-h) + env(safe-area-inset-bottom, 0px) + 6px);
      }

      /* ุงุฑูุน ุฒุฑ ุงูุฏุนู ูุดุงุฑุฉ ุงูุญุงูุฉ ููู ูู ุดูุก ุจุฃุณูู ุงูุดุงุดุฉ */
      .support-fab{
        bottom: calc(var(--footer-h) + var(--statsbar-h) + env(safe-area-inset-bottom, 0px) + 10px);
      }
      .status-badge{
        bottom: calc(var(--footer-h) + var(--statsbar-h) + env(safe-area-inset-bottom, 0px) + 14px);
      }

      /* ุญููู ุงูุฅุฏุฎุงู ุนูู iOS >= 16px ูุชูุงุฏู ุงูุชูุจูุฑ ุงูุชููุงุฆู */
      .form-control{
        font-size: 16px;
        min-height: 44px; /* ูุฏู ููุณ ูุฑูุญ */
      }

      /* ุฃุฒุฑุงุฑ ุงูุชุจููุจุงุช ุฃุตุบุฑ ูููููุง ุนูู ุงูุดุงุดุงุช ุงูุตุบูุฑุฉ */
      .tabs .tab{
        font-size: clamp(14px, 3.6vw, 16px);
        padding: 12px 10px;
      }

      /* ุงูุนูุงููู ุงููุจูุฑุฉ ุชุตูุฑ ูุฑูุฉ ุจุฏู ุงูุซุงุจุช */
      #homeContent h2,
      .brand-text .logo{
        font-size: clamp(1.3rem, 4.5vw, 2rem);
      }

      /* ููุน ุชุฏุงุฎู ุงูู tooltip ูุน ุงูุญูุงู ุนูู ุงูุฌูุงู ุงูุถูู */
      .welcome-support-tooltip{
        max-width: min(80vw, 280px);
      }

      /* ุตูุฑ ูุดุนุงุฑุงุช ุชุชูููู ุฏุงุฆููุง */
      img{ max-width: 100%; height: auto; }

    .tabs .tab[data-tab="housing"]{ display:none !important; }

       /*ุฅุตูุงุญ ุงูุนุฑุถ ุงูุฃููู ุงูุฒุงุฆุฏ (Horizontal Scroll)*/
        html, body{
          overflow-x: hidden;
          max-width: 100vw;
        }

        * {
          max-width: 100%;
        }

          /* ุดุฑูุท ุงูุฅุญุตุงุฆูุงุช ุงูุณููู */


      .dark .stats-bottom-bar{
        background: rgba(17, 24, 39, 0.85);
        border-top-color: rgba(255, 255, 255, 0.05);
      }

      .stat-glass-card{
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 8px 14px;
        transition: all 0.3s ease;
      }

      .stat-glass-card:hover{
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      }

      .stat-icon{
        font-size: 1.8rem;
        line-height: 1;
      }

      .stat-content{
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .stat-glass-card .stat-number{
        font-size: 1.1rem;
        font-weight: 800;
        color: #fff;
        line-height: 1.2;
      }

      .stat-glass-card .stat-label{
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.75);
        line-height: 1;
      }

      /* ุงุณุชุฌุงุจุฉ ููุฌูุงู */
      @media (max-width: 768px){
        .stats-bottom-bar{
          flex-direction: column;  /* ุฑุต ุนููุฏู */
          padding: 12px;
          gap: 8px;
          margin-top: 16px;
        }
        
        .stat-glass-card{
          width: 100%;  /* ุนุฑุถ ูุงูู */
          padding: 10px 12px;
        }
        
        .stat-icon{
          font-size: 1.6rem;
        }
        
        .stat-glass-card .stat-number{
          font-size: 1.1rem;
        }
        
        .stat-glass-card .stat-label{
          font-size: 0.8rem;
        }
        
        .site-footer{
          padding: 14px 10px;
        }
        
        body{
          padding-bottom: 20px;
        }
      }
           

      /* ุฅุฎูุงุก ุงูุดุฑูุท ูุจู ุชุณุฌูู ุงูุฏุฎูู */
      html:not(.app-ready) .stats-bottom-bar{
        display: none !important;
      }


          /* ุดุงุฑุฉ ุญุงูุฉ ุฃูููุฉ */
    .status-badge{
      position: fixed;
      bottom: 20px;
      inset-inline-start: 20px;
      z-index: 10000;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 10px 16px;
      border-radius: 999px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      font-size: 0.85rem;
      font-weight: 700;
      color: #1f2937;
      transition: all 0.3s ease;
    }

    .dark .status-badge{
      background: rgba(17, 24, 39, 0.95);
      color: #e5e7eb;
    }

    .status-dot{
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: statusPulse 2s ease-in-out infinite;
    }

    @keyframes statusPulse{
      0%, 100%{ opacity: 1; transform: scale(1); }
      50%{ opacity: 0.6; transform: scale(1.2); }
    }

    .status-dot.online{
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
    }

    .status-dot.offline{
      background: #ef4444;
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
    }

    .status-dot.loading{
      background: #f59e0b;
      box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
    }

    .status-badge.hidden{
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
    }

    @media (max-width: 768px){
      .status-badge{
        bottom: 150px;
        inset-inline-start: 10px;
        font-size: 0.75rem;
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>

  <!-- ุดุงุดุฉ ุชุนุฑูู ุจุงููุจุงุฏุฑุฉ (Overlay) -->
  <section id="intro-screen" class="intro-screen">
    <div class="intro-content">
      <img src="assets/intro-hero.jpg" alt="ุชุนุฑูู ุจุงููุจุงุฏุฑุฉ" class="intro-hero" loading="eager" decoding="async" fetchpriority="high">
      <button id="startBtn" class="intro-start">ุงูุทูู</button>
      <div id="introLoader" class="intro-loader" aria-hidden="true">ุฌุงุฑู ุงูุชุญููู...</div>
    </div>
  </section>

  <!-- ุฅุทุงุฑ ุงูุตูุญุฉ -->
  <div class="container">
    
      <!-- ุถุน ุงูููุฏุฑ ููุง -->
      <header class="header">
        <div class="header-bar">
          <div class="brand-inline">
            <div class="brand-stack">
              <img src="assets/logo-college.png" alt="ุดุนุงุฑ ุงููุคุณุณุฉ" class="brand-logo-tall">
              <div class="brand-text">
                <div class="logo">ูุจุงุฏุฑุฉ ุณุงูุฏ ูููุชุฏุฑุจูู</div>
              </div>
            </div>
          </div>

          <div class="user-actions">
            <button id="statsBtn" class="hidden btn btn-secondary" type="button">ููุญุฉ ุงูุฅุญุตุงุฆูุงุช</button>
            <button class="pill-btn" id="themeToggleBtn" type="button" style="background:#111827">ุงููุถุน ุงูุฏุงูู</button>
          </div>
        </div>

        <div class="header-split"></div>

        <!-- ุณุทุฑ ููุญูุฏ: ุงุณู + ุดุงุฑุฉ | ุงูุฅุญุตุงุฆูุงุช | ุชุณุฌูู ุฎุฑูุฌ -->
        <div class="header-sub"> 
          <div class="user-title" id="topUserInfo" style="display:none">
            <span class="user-name" id="userName" aria-live="polite">...</span>
            <span class="role-badge" id="userRole">ูุชุฏุฑุจ</span>
          </div>
          <button class="logout-btn" id="logoutBtn" type="button">ุชุณุฌูู ุงูุฎุฑูุฌ</button>
        </div>
      </header>

    <!-- ูุณู ุงูุฏุฎูู -->
    <section class="login-section" id="loginSection">
      <div class="login-container">
        <div class="welcome-message">ูุฑุญุจุงู ุจู ูู ูุจุงุฏุฑุฉ ุณุงูุฏ ูููุชุฏุฑุจูู</div>
          <form class="login-form active" id="loginForm" aria-hidden="false" onsubmit="return false;">

            <!-- ุณุงูุฏ ููููุงุตูุงุช (ุฃููุงู) -->
            <!-- ุจุทุงูุฉ: ุณุงูุฏ ููููุงุตูุงุช -->
              <div class="card" style="margin-bottom:16px">
                <span class="section-pill">ุณุงูุฏ ููููุงุตูุงุช</span>
                <p class="section-lead" style="margin-top:10px">
                  ุณุงูุฏ ููููุงุตูุงุช ูุจุงุฏุฑุฉ ุชุทูุนูุฉ ุชุฑุจุท ุงููุชุฏุฑุจูู ุจุงูุณุงุฆููู ุฏุงุฎู ุงููุญุงูุธุฉ
                  ูุชูุณูู ุงูุฑุญูุงุช ุงูููููุฉ ุจุณุฑุนุฉ ูุฃูุงู ูุจุฃูู ูุฌููุฏ.
                </p>

                <div class="form-group" style="margin-top:12px">
                  <label for="loginTraineeId">ุฑูู ุงููุชุฏุฑุจ</label>
                  <input type="text" id="loginTraineeId" class="form-control" placeholder="ูุซุงู: 4461XXXX" required>
                  <small id="loginIdHint" class="field-hint neutral" style="display:none"></small>
                </div>

                <div class="alert alert-info">
                  <strong>ููุงุญุธุฉ:</strong> ุณูุชู ุงูุชุญูู ูู ุฑููู ูู ูุงุฆูุฉ ุงููุชุฏุฑุจูู.
                  ุฅุฐุง ูู ุชูู ููุฌูุฏูุง ูู ุงููุงุฆูุฉุ ููู ููุณูุญ ุจุงูุชุณุฌูู ูููุฑุฌู ุงูุชูุงุตู ูุน ุงูููุดุฃุฉ ุงูุชุฏุฑูุจูุฉ.
                </div>

                <button class="btn btn-primary" id="loginBtn" type="button">ุฏุฎูู ุฅูู ุณุงูุฏ ุงูููุงุตูุงุช</button>
              </div>

              <!-- ุจุทุงูุฉ: ุณุงูุฏ ููุณูู -->
              <div class="card">
                <span class="section-pill">ุณุงูุฏ ููุณูู</span>
                <p class="section-lead" style="margin-top:10px">
                  ููููุฑ โุณุงูุฏ ููุณููโ ูุงุฆูุฉ ููุญุฏูุซุฉ ุจุฃุฑูุงู ููุงู ุงูุดูู ูุงูุบุฑู ูู ุงููุญุงูุธุฉุ
                  ูุชุณููู ุชูุงุตู ุงููุชุฏุฑุจูู ูุน ุงููุงูููู ูุจุงุดุฑุฉู ุจุฏูู ูุณุทุงุก. ุชุฃููุฏ ูู ูุทุงุจูุฉ ุงูุชูุงุตูู ูุจู ุงูุงุชูุงู.
                </p>
                <div style="text-align:center">
                 <button class="btn btn-outline" id="openHousingBtn" type="button">๐จ ุงูุฏุฎูู ุฅูู ุณุงูุฏ ุงูุณูู</button>
                </div>
                </div>
          </form>
      </div>
    </section>

    <!-- ุชุจููุจุงุช ุงูุชุทุจูู -->
    <nav class="tabs" id="tabsContainer" role="tablist" aria-label="ุงูุชููู ูู ุณุงูุฏ">
      <button class="tab active" data-tab="home" type="button">๐ ุงูุฑุฆูุณูุฉ</button>
      <button class="tab badged" data-tab="requests" id="requestsTab" type="button">๐ ุทูุจุงุชู <span class="badge" id="requestsBadge" style="display:none">0</span></button>
      <button class="tab" data-tab="drivers" type="button">๐ ุงูุณุงุฆููู</button>
      <button class="tab" data-tab="book" type="button">โ ุญุฌุฒ ุฌุฏูุฏ</button>
      <button class="tab" data-tab="rate" type="button">โญ ุชูููู</button>
      <button class="tab" data-tab="register" type="button">๐ฅ ุชุณุฌูู ุฌุฏูุฏ</button>
    </nav>

    <!-- ุตูุญุงุช ุงููุญุชูู -->

    <!-- ุงูุฑุฆูุณูุฉ -->
      <section class="content active" id="homeContent">
        <h2>ูุฑุญุจุงู <span id="homeUserName">...</span> ๐</h2>

        <div class="welcome-banner" id="welcomeBanner">
          ูุฑุญุจุงู ุจู ูู ูุจุงุฏุฑุฉ ุณุงูุฏ - ูุญู ููุง ูุฎุฏูุชู ๐
        </div>

        <div class="section-divider"><span>ุณุงูุฏ ุงูููุงุตูุงุช</span></div>
        <p class="section-lead" style="margin-bottom:12px">
          ุณุงูุฏ ุงูููุงุตูุงุช ูุจุงุฏุฑุฉ ุชุทูุนูุฉ ูุฑุจุท ุงููุชุฏุฑุจูู ุจุงูุณุงุฆููู ุงููุชุทูุนูู ุฏุงุฎู ุงููุญุงูุธุฉุ
          ูุชูุณูู ุงูุฑุญูุงุช ุงูููููุฉ ุจุดูู ุขูู ูุณุฑูุน ูุจุฃูู ูุฌููุฏ.
        </p>

        <div class="dashboard-stats">
          <div class="stat-card"><div class="stat-number" id="myTripsCount">-</div><div class="stat-label">ุฑุญูุงุชู ุงูููุชููุฉ</div></div>
          <div class="stat-card"><div class="stat-number" id="myRating">-</div><div class="stat-label">ุชููููู</div></div>
          <div class="stat-card"><div class="stat-number" id="myActiveRequests">-</div><div class="stat-label">ุทูุจุงุช ูุดุทุฉ</div></div>
          <div class="stat-card"><div class="stat-number" id="communitySize">-</div><div class="stat-label">ุฃุนุถุงุก ุงููุฌุชูุน</div></div>
        </div>
        <div style="text-align:center; margin-top:16px;">
        <button class="btn btn-secondary" id="refreshHomeStats" type="button">
          ๐ ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
        </button>
      </div>
      </section>


    <!-- ุทูุจุงุชู -->
    <section class="content" id="requestsContent">
      <h2 id="requestsTitle">ุทูุจุงุชู</h2><br>
      <button class="btn" id="refreshRequestsBtn" type="button">๐ ุชุญุฏูุซ ุงูุทูุจุงุช</button>
      <br><br>
      <div id="userRequestsList">
        <div class="loading"><div class="spinner"></div><p>ุฌุงุฑู ุชุญููู ุงูุทูุจุงุช...</p></div>
      </div>
    </section>

    <!-- ุงูุณุงุฆููู -->
    <section class="content" id="driversContent">
      <h2>ุงูุณุงุฆููู ุงููุชุงุญูู <span id="availableDriversCount" style="font-size:.9rem;opacity:.85"></span></h2>

      <div class="form-group">
        <label for="searchDriver">ุจุญุซ ุจุงูุงุณู ุฃู ุฑูู ุงููุชุฏุฑุจ</label>
        <input id="searchDriver" class="form-control" type="text" placeholder="ูุซุงู: ุฃุญูุฏ ุฃู D001">
      </div>

      <div class="form-group">
        <label for="filterNeighborhood">ููุชุฑุฉ ุญุณุจ ุงูุญู</label>
        <select id="filterNeighborhood" class="form-control">
          <option value="">ุฌููุน ุงูุฃุญูุงุก</option>
          <option value="ุงููุฑููู">ุงููุฑููู</option>
          <option value="ุงูุธูุฑุฉ">ุงูุธูุฑุฉ</option>
          <option value="ุงูุญูู">ุงูุญูู</option>
          <option value="ุงูุณูุฎุฉ">ุงูุณูุฎุฉ</option>
          <option value="ุงูุณุจุฎุฉ">ุงูุณุจุฎุฉ</option>
        </select>
      </div>

      <button class="btn" id="refreshDriversBtn" type="button">๐ ุชุญุฏูุซ ูุงุฆูุฉ ุงูุณุงุฆููู</button>
      <br><br>
      <div id="driversList">
        <div class="loading"><div class="spinner"></div><p>ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</p></div>
      </div>
    </section>

    <!-- ุญุฌุฒ ุฌุฏูุฏ -->
    <section class="content" id="bookContent">
      <h2>ุญุฌุฒ ุชูุตูู ุฌุฏูุฏ</h2><br>
      <div class="alert alert-info"><strong>ุชุนูููุงุช:</strong> ุจุนุฏ ุงุฎุชูุงุฑ ุงูุณุงุฆู ูุงูุฃูุงู ุงููุทููุจุฉุ ุณูุชู ุฅุฑุณุงู ุฑุณุงูุฉ ูุงุชุณุงุจ ุชููุงุฆูุฉ ููุณุงุฆู ูุญูุธ ุงูุทูุจ.</div>

      <form id="bookingForm">
        <div class="form-group">
          <label for="selectedDriver">ุงูุณุงุฆู ุงููุฎุชุงุฑ</label>
          <select id="selectedDriver" class="form-control" required><option value="">ุงุฎุชุฑ ุงูุณุงุฆู</option></select>
        </div>

        <div class="form-group">
          <label>ุงูุฃูุงู ุงููุทููุจุฉ</label>
          <div class="checkbox-group" id="daysGroup"></div>
        </div>

        <div class="form-group">
          <label for="duration">ูุฏุฉ ุงูุญุฌุฒ (ุจุงูุฃุณุงุจูุน)</label>
          <select id="duration" class="form-control" required>
            <option value="">ุงุฎุชุฑ ุงููุฏุฉ</option>
            <option value="1">ุฃุณุจูุน ูุงุญุฏ</option>
            <option value="2">ุฃุณุจูุนูู</option>
            <option value="3">3 ุฃุณุงุจูุน</option>
            <option value="4">ุดูุฑ ูุงูู</option>
          </select>
        </div>

        <div class="form-group">
          <label for="tripNotes">ููุงุญุธุงุช ุฅุถุงููุฉ (ุงุฎุชูุงุฑู)</label>
          <textarea id="tripNotes" class="form-control" rows="3" placeholder="ูุซุงู: ุฃุญุชุงุฌ ุงูุชูุตูู ุตุจุงุญุงู 7:30"></textarea>
        </div>

        <button type="submit" class="btn" id="bookingBtn">ุฅุฑุณุงู ุทูุจ ุงูุชูุตูู</button>
      </form>
    </section>

    <!-- ุงูุชูููู -->
    <section class="content" id="rateContent">
      <h2 id="rateTitle">ุชูููู ุงูุณุงุฆู</h2><br>
      <form id="ratingForm">
        <div class="form-group">
          <label for="ratedDriver" id="rateSelectLabel">ุงูุณุงุฆู</label>
          <select id="ratedDriver" class="form-control" required><option value="">ุงุฎุชุฑ</option></select>
        </div>

        <div class="form-group">
          <label for="ratingStars">ุงูุชูููู</label>
          <select id="ratingStars" class="form-control" required>
            <option value="">ุงุฎุชุฑ ุงูุชูููู</option>
            <option value="5">โญโญโญโญโญ ููุชุงุฒ</option>
            <option value="4">โญโญโญโญ ุฌูุฏ ุฌุฏุงู</option>
            <option value="3">โญโญโญ ุฌูุฏ</option>
            <option value="2">โญโญ ููุจูู</option>
            <option value="1">โญ ูุญุชุงุฌ ุชุญุณูู</option>
          </select>
        </div>

        <div class="form-group">
          <label for="ratingNotes">ููุงุญุธุงุช ุฅุถุงููุฉ</label>
          <textarea id="ratingNotes" class="form-control" rows="4" placeholder="ุงูุชุจ ููุงุญุธุงุชู ููุง..."></textarea>
        </div>

        <button type="submit" class="btn" id="ratingBtn">ุฅุฑุณุงู ุงูุชูููู</button>
      </form>
    </section>

    <!-- ุงูุชุณุฌูู -->
    <section class="content" id="registerContent">
      <h2>ุชุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ</h2><br>
      <div class="alert alert-info"><strong>ููุงุญุธุฉ:</strong> ูููู ูููุชุฏุฑุจูู ุชุณุฌูู ุฃููุณูู ูุณุงุฆููู ูุชุทูุนูู ุฃู ููุญุชุงุฌูู ููุชูุตูู.</div>

      <div id="backToLoginWrap" class="back-to-selection" style="display:none;margin-bottom:10px">
        <button type="button" class="btn btn-secondary" id="backToLoginBtn">โฌ๏ธ ุฑุฌูุน ูุดุงุดุฉ ุงูุฏุฎูู</button>
      </div>

      <form id="registrationForm">
        <div class="form-group"><label for="name">ุงูุงุณู ุงููุงูู</label><input type="text" id="name" class="form-control" required></div>
        <div class="form-group"><label for="traineeId">ุฑูู ุงููุชุฏุฑุจ</label><input type="text" id="traineeId" class="form-control" required></div>
        <small id="regIdHint" class="field-hint neutral"></small>
        <div class="form-group"><label for="phone">ุฑูู ุงูุฌูุงู (ูุน ููุฏ ุงูุฏููุฉ)</label><input type="tel" id="phone" class="form-control" placeholder="9665XXXXXXXX" required></div>

        <div class="form-group">
          <label for="neighborhood">ุงูุญู</label>
          <select id="neighborhood" class="form-control" required>
            <option value="">ุงุฎุชุฑ ุงูุญู</option>
            <option value="ุงููุฑููู">ุงููุฑููู</option>
            <option value="ุงูุธูุฑุฉ">ุงูุธูุฑุฉ</option>
            <option value="ุงูุญูู">ุงูุญูู</option>
            <option value="ุงูุณูุฎุฉ">ุงูุณูุฎุฉ</option>
            <option value="ุงูุณุจุฎุฉ">ุงูุณุจุฎุฉ</option>
          </select>
        </div>

        <div class="form-group">
          <label for="userType">ููุน ุงููุณุชุฎุฏู</label>
          <select id="userType" class="form-control" required>
            <option value="">ุงุฎุชุฑ ููุน ุงููุณุชุฎุฏู</option>
            <option value="ุณุงุฆู">ุณุงุฆู ูุชุทูุน</option>
            <option value="ูุชุฏุฑุจ">ูุญุชุงุฌ ูุชูุตูู</option>
          </select>
        </div>

        <button type="submit" class="btn" id="registerBtn">ุชุณุฌูู ูู ุณุงูุฏ</button>
      </form>
 
    </section>
               <!-- ุดุฑูุท ุงูุฅุญุตุงุฆูุงุช ุงูุซุงุจุช -->
    <div class="stats-bottom-bar" id="statsBottomBar" aria-live="polite">
      <div class="stat-glass-card">
        <div class="stat-icon">๐ฅ</div>
        <div class="stat-content">
          <div class="stat-number" id="totalUsersBottom">-</div>
          <div class="stat-label">ูุณุชุฎุฏู ูุดุท</div>
        </div>
      </div>
      
      <div class="stat-glass-card">
        <div class="stat-icon">๐</div>
        <div class="stat-content">
          <div class="stat-number" id="totalTripsBottom">-</div>
          <div class="stat-label">ุฑุญูุฉ ููุชููุฉ</div>
        </div>
      </div>
      
      <div class="stat-glass-card">
        <div class="stat-icon">โญ</div>
        <div class="stat-content">
          <div class="stat-number" id="satisfactionBottom">-</div>
          <div class="stat-label">ุชูููู ุงูุฎุฏูุฉ</div>
        </div>
      </div>
    </div>
  </div><!-- /container -->



    <!-- ุดุงุฑุฉ ุญุงูุฉ ุงููุธุงู -->
    <div class="status-badge" id="statusBadge">
      <span class="status-dot" id="statusDot"></span>
      <span class="status-text" id="statusText">ุฌุงุฑู ุงูุชุญููู...</span>
    </div>

  <!-- ุฒุฑ ุฏุนู ุนุงุฆู + ุชูุณุช -->
  <div class="support-fab" id="supportFab" aria-label="ุงูุฏุนู ุงูููู">
      <!-- ุชูููุญ ุชุฑุญูุจู ุฌุฏูุฏ -->
      <div class="welcome-support-tooltip" id="welcomeSupportTip">
        <div class="tooltip-arrow"></div>
        <div class="tooltip-content">
          <div class="tooltip-icon">๐ฌ</div>
          <div class="tooltip-text">
            <strong>ูุญุชุงุฌ ูุณุงุนุฏุฉุ</strong>
            <span>ุชูุงุตู ูุนูุง ูุจุงุดุฑุฉ</span>
          </div>
        </div>
      </div>
    <div class="support-menu" aria-hidden="true">
      <a class="wa" target="_blank" rel="noopener" href="https://wa.me/9665XXXXXXXX?text=%D9%85%D8%B3%D8%A7%D8%B9%D8%AF%D8%A9%20%D8%AF%D8%B9%D9%85%20%D9%81%D9%86%D9%8A">
        <span class="ico">๐ฌ</span><span>ูุงุชุณุงุจ</span>
      </a>
      <a class="mail" href="mailto:someone@example.com?subject=%D8%AF%D8%B9%D9%85%20%D9%81%D9%86%D9%8A">
        <span class="ico">โ๏ธ</span><span>ุงูุจุฑูุฏ</span>
      </a>
    </div>
    <button class="main" type="button" title="ุงูุฏุนู">๐</button>
  </div>

  <div id="toastWrap" role="region" aria-live="polite" aria-atomic="true" style="position:fixed;inset-inline-start:20px;bottom:90px;z-index:10050;display:flex;flex-direction:column;gap:10px"></div>



    <footer class="site-footer">
      <div class="footer-content">
        <div class="footer-logo">
          <span class="footer-icon">๐๏ธ</span>
          <div class="footer-text">
            <strong>ูุจุงุฏุฑุฉ ูู</strong>
            <span>ูุญุฏุฉ ุงูุฎุฏูุงุช ุงูุฅุฑุดุงุฏูุฉ ูุชุทููุฑ ููุงูุฉ ุถุจุท ุงูุฌูุฏุฉ</span>
          </div>
        </div>
        <div class="footer-institute">
          <span class="institute-badge">ุงููููุฉ ุงูุชูููุฉ ุจุญูู</span>
          <span class="version">ุงููุณุฎุฉ 1.0</span>
        </div>
      </div>
    </footer>

  <!-- ุณูุฑุจุช ุงูุชุทุจูู -->
  <script>
    
    // ===== ุฅุนุฏุงุฏุงุช ุนุงูุฉ (ูู config.json) =====
    let GOOGLE_SCRIPT_URL = ''; // ุณูุชู ููุคู ูู config.json
    let API_KEY = '';
    let CFG = null;

    // ุญุงูุฉ ุนุงูุฉ
    let requestsAutoTimer = null;
    let allowSelfRegister = false;
    let lastVerifiedTrainee = null;
    let lastQuickDriverId = null;

    let DAYS = ['ุงูุฃุญุฏ','ุงูุงุซููู','ุงูุซูุงุซุงุก','ุงูุฃุฑุจุนุงุก','ุงูุฎููุณ']; // ุงูุชุฑุงุถู

    let drivers = [];
    let currentUser = null;
    let approvedPartners = [];

    // ุงูููู: 'login' | 'register_only' | 'app'
    let appMode = 'login';
    function isValidUserType(t){ return t === 'ุณุงุฆู' || t === 'ูุชุฏุฑุจ'; }

    function setAppMode(mode){
      appMode = mode;

      // ุถูู/ุงุญุฐู ููุงุณุงุช ุงูุญุงูุฉ ุนูู <body> ูุงุณุชุฎุฏุงููุง ูู CSS
      document.body.classList.remove('mode-login','mode-register','mode-app');
      if(mode === 'login')         document.body.classList.add('mode-login');
      if(mode === 'register_only') document.body.classList.add('mode-register');
      if(mode === 'app')           document.body.classList.add('mode-app');

      const logoutBtn    = document.getElementById('logoutBtn');
      const tabs         = document.getElementById('tabsContainer');
      const topUserInfo  = document.getElementById('topUserInfo');
      const loginSection = document.getElementById('loginSection');
      const allContents  = Array.from(document.querySelectorAll('.content'));
      const reg          = document.getElementById('registerContent');
      const backWrap     = document.getElementById('backToLoginWrap');
      const regTab       = document.querySelector('.tab[data-tab="register"]');
      if(regTab) regTab.style.display = 'none';

      const hideAllContents = ()=>{
        allContents.forEach(c=>{
          c.classList.remove('active');
          c.setAttribute('hidden','');
          c.setAttribute('aria-hidden','true');
          c.setAttribute('inert','');
        });
      };
      const showOnly = (el)=>{
        el.classList.add('active');
        el.removeAttribute('hidden');
        el.setAttribute('aria-hidden','false');
        el.removeAttribute('inert');
      };

      if(mode==='login'){
        if (logoutBtn) logoutBtn.style.display = 'none';
        loginSection.style.display='block';
        tabs.classList.remove('active');
        topUserInfo.style.display='none';
        hideAllContents();
        document.querySelector('.tab[data-tab="register"]')?.style.setProperty('display','none');
        backWrap.style.display='none';
      }

      if(mode==='register_only'){
        if (logoutBtn) logoutBtn.style.display = 'none';
        loginSection.style.display='none';
        tabs.classList.remove('active');
        topUserInfo.style.display='none';
        hideAllContents(); 
        showOnly(reg);
        document.querySelector('.tab[data-tab="register"]')?.style.setProperty('display','none');
        backWrap.style.display='block';
      }

      if(mode==='app'){
        if (logoutBtn) logoutBtn.style.display = 'inline-block'; // ุฃู 'flex'
        loginSection.style.display='none';
        // ุฅุฎูุงุก ุฑุณุงูุฉ ุงูุชุฑุญูุจ ุจุนุฏ 5 ุซูุงูู
        setTimeout(() => {
          const banner = document.getElementById('welcomeBanner');
          if(banner) banner.style.display = 'none';
        }, 5000);
        tabs.classList.add('active');
        hideAllContents(); 
        showOnly(document.getElementById('homeContent'));
        setIsHome(true); // ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ููุนููุฉ ุงูุขู
        topUserInfo.style.display='inline-flex'; // ุงูุงุณู + ุงูุดุงุฑุฉ ุฌูุจ ุจุนุถ
        allContents.forEach(c=>{
          c.removeAttribute('hidden'); 
          c.removeAttribute('inert');
          c.setAttribute('aria-hidden', c.classList.contains('active') ? 'false' : 'true');
        });
        document.querySelector('.tab[data-tab="register"]')?.style.setProperty('display','none');
        backWrap.style.display='none';
      }
    }

    function guardNavigation(ev){
      if(appMode!=='app'){
        ev.preventDefault();
        showToast('ุฃููู ุงูุชุณุฌูู ุฃููุงู.','warn');
        return true;
      }
      return false;
    }

    // ===== Utils =====
    function sanitizeStr(s){ return String(s||'').replace(/[\u200E\u200F\u202A-\u202E]/g,'').trim(); }
    function normalizeDigits(s=''){
      const map={'ู':'0','ูก':'1','ูข':'2','ูฃ':'3','ูค':'4','ูฅ':'5','ูฆ':'6','ูง':'7','ูจ':'8','ูฉ':'9','ฐ':'0','ฑ':'1','ฒ':'2','ณ':'3','ด':'4','ต':'5','ถ':'6','ท':'7','ธ':'8','น':'9'};
      return String(s).replace(/[ู-ูฉฐ-น]/g, ch => map[ch] || ch);
    }
    function normalizePhoneKSA(raw=''){
      const s = normalizeDigits(String(raw)).replace(/\s+/g,'').replace(/[^\d+]/g,'');
      if(!s) return '';
      if(/^(\+)?9665\d{8}$/.test(s)) return s.replace(/^\+/, '');
      if(/^05\d{8}$/.test(s))        return '966' + s.slice(1);
      if(/^5\d{8}$/.test(s))         return '966' + s;
      if(/^009665\d{8}$/.test(s))    return s.replace(/^00/, '');
      return '';
    }
    function isValidPhoneKSA(v){ return /^9665\d{8}$/.test(normalizePhoneKSA(v)); }
    function buildWaUrl(phone, text=''){
      const p = normalizePhoneKSA(phone);
      if(!p) return '';
      const q = text ? ('?text=' + encodeURIComponent(text)) : '';
      return `https://wa.me/${p}${q}`;
    }
    function getWaPhoneFromRecord(rec={}){
      const candidates = [rec.phone,rec.whatsapp,rec.mobile,rec.passengerPhone,rec.driverPhone].filter(Boolean);
      for(const c of candidates){
        const n = normalizePhoneKSA(c);
        if(n) return n;
      }
      return '';
    }
    function showToast(msg,type='info',timeout=3500){
      const wrap = document.getElementById('toastWrap'); if(!wrap) return;
      const d = document.createElement('div');
      const palette = {
        info:{bg:'#cce7ff',bd:'#99d6ff',tx:'#0c5460'},
        success:{bg:'#d4edda',bd:'#c3e6cb',tx:'#155724'},
        warn:{bg:'#fff3cd',bd:'#ffeaa7',tx:'#856404'},
        error:{bg:'#f8d7da',bd:'#f5c2c7',tx:'#721c24'}
      }[type] || {bg:'#cce7ff',bd:'#99d6ff',tx:'#0c5460'};
      d.style.cssText = `padding:12px 14px;border-radius:10px;border:1px solid ${palette.bd};background:${palette.bg};color:${palette.tx};min-width:220px;box-shadow:0 10px 20px rgba(0,0,0,.08);font-weight:700`;
      d.textContent = msg;
      wrap.appendChild(d);
      setTimeout(()=>{ d.style.opacity='0'; d.style.transform='translateY(6px)'; }, timeout);
      setTimeout(()=>{ d.remove(); }, timeout+300);
    }

    // ===== ุญุงูุฉ ุงูุงุชุตุงู =====
    const connDot = () => document.getElementById('connDot');
    const connText = () => document.getElementById('connText');
    function setConnStatus(state){
      const badge = document.getElementById('statusBadge');
      const dot = document.getElementById('statusDot');
      const txt = document.getElementById('statusText');
      
      if(!badge || !dot || !txt) return;
      
      dot.classList.remove('online','offline','loading');
      
      if(state === 'online'){
        dot.classList.add('online');
        txt.textContent = 'ุงููุธุงู ุฌุงูุฒ';
        setTimeout(() => badge.classList.add('hidden'), 2000);
      } else if(state === 'offline'){
        dot.classList.add('offline');
        txt.textContent = 'ุฎุทุฃ ูู ุงูุงุชุตุงู';
        badge.classList.remove('hidden');
      } else {
        dot.classList.add('loading');
        txt.textContent = 'ุฌุงุฑู ุงูุชุญููู...';
        badge.classList.remove('hidden');
      }
    }

    // ===== ุชุฎุฒูู ูุคูุช =====
    const CACHE_TTL = { getTopStats:60000, getDrivers:60000, getUserStats:45000, getPassengerRequests:30000, getDriverRequests:30000 };
    const memCache = new Map();      // actionKey -> {ts,data}
    const inflight = new Map();      // actionKey -> Promise

    function stableStringify(obj){
      if (obj === null || typeof obj !== 'object') return String(obj);
      if (Array.isArray(obj)) return '[' + obj.map(stableStringify).join(',') + ']';
      const keys = Object.keys(obj).sort();
      return '{' + keys.map(k => JSON.stringify(k) + ':' + stableStringify(obj[k])).join(',') + '}';
    }
    function buildCacheKey(action,data){ return String(action||'') + ':' + stableStringify(data||{}); }
    function lcGet(key){ try{ return JSON.parse(localStorage.getItem(key) || 'null'); }catch{return null} }
    function lcSet(key,val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch{} }
    function isFresh(ts,ttl){ return (Date.now()-ts) < ttl; }

    async function fetchWithCache(action, data={}, {ttl=30000, staleOK=true} = {}){
      const cacheKey = buildCacheKey(action,data);
      const lsKey = 'sand_cache_' + cacheKey;

      const m = memCache.get(cacheKey);
      if(m && isFresh(m.ts, ttl)) return {from:'mem', data:m.data};

      const lc = lcGet(lsKey);
      if(lc && staleOK){
        backgroundRefresh(action,data,ttl);
        return {from:'local', data:lc.data, stale:!isFresh(lc.ts,ttl)};
      }

      if(inflight.has(cacheKey)) return inflight.get(cacheKey);

      const p = (async ()=>{
        const res = await sendToGoogleSheets(action,data);
        const payload = res?.data ?? null;
        const entry = {ts:Date.now(), data:payload};
        memCache.set(cacheKey, entry);
        lcSet(lsKey, entry);
        return {from:'net', data:payload};
      })().finally(()=> inflight.delete(cacheKey));

      inflight.set(cacheKey,p);
      return p;
    }

    function backgroundRefresh(action,data,ttl){
      fetchWithCache(action,data,{ttl,staleOK:false}).catch(()=>{});
    }

    async function sendToGoogleSheets(action,data){
      let connectingTimer = setTimeout(()=> setConnStatus('connecting'), 600);
      const controller = new AbortController();
      const t = setTimeout(()=> controller.abort(), 20000);

      try{
        if(!GOOGLE_SCRIPT_URL){ clearTimeout(connectingTimer); setConnStatus('offline'); throw new Error('GOOGLE_SCRIPT_URL is empty'); }

        const resp = await fetch(GOOGLE_SCRIPT_URL,{
          method:'POST',
          headers:{'Content-Type':'text/plain;charset=utf-8'},
          body:JSON.stringify({action,data, ...(API_KEY? {key:API_KEY}:{}) }),
          signal:controller.signal,
          mode:'cors',credentials:'omit',cache:'no-store',redirect:'follow',referrerPolicy:'no-referrer'
        });

        clearTimeout(connectingTimer); clearTimeout(t);
        if(!resp.ok){ setConnStatus('offline'); throw new Error('HTTP ' + resp.status); }
        const json = await resp.json().catch(()=>{ throw new Error('INVALID_JSON'); });

        setConnStatus('online');
        return json;
      }catch(err){
        clearTimeout(connectingTimer); clearTimeout(t);
        setConnStatus('offline');
        console.error('[GS Error]', err);
        throw new Error( err.name==='AbortError' ? 'TIMEOUT_20S' : (err.message==='INVALID_JSON' ? 'INVALID_JSON' : ('NET_'+(err.message||'ERR'))) );
      }
    }

    async function heartbeat(){
      try{
        const r = await fetchWithCache('getTopStats', {}, {ttl:CACHE_TTL.getTopStats});
        updateTopStats(r?.data);
      }catch{}
    }

    // ===== ุนูุงุตุฑ ูุณุงุนุฏุฉ ุณุฑูุนุฉ =====
    function $(sel){ return document.querySelector(sel); }
    function $$(sel){ return Array.from(document.querySelectorAll(sel)); }

    // ===== ุชูููุญุงุช ุฑูู ุงููุชุฏุฑุจ =====
    function hintTraineeIdState(value){
      const v = String(value||'').trim();
      if(!v){ return {cls:'neutral', msg:''}; }
      if(/^\d{6,}$/.test(v)){ return {cls:'good', msg:'โ ุงูุตูุบุฉ ุฑูููุฉ ุชุจุฏู ุตุญูุญุฉ'}; }
      return {cls:'warn', msg:'โ๏ธ ูุฑุฌู ุฅุฏุฎุงู ุฃุฑูุงู ููุท'};
    }
    function setupTraineeIdHints(){
      const loginInput = document.getElementById('loginTraineeId');
      const loginHint  = document.getElementById('loginIdHint');
      const regInput   = document.getElementById('traineeId');
      const regHint    = document.getElementById('regIdHint');

      function bindHint(input, hintEl){
        if(!input || !hintEl) return;
        input.addEventListener('input', ()=>{
          const {cls, msg} = hintTraineeIdState(input.value);
          hintEl.classList.remove('neutral','good','warn');
          hintEl.classList.add(cls);
          hintEl.textContent = msg;
          hintEl.style.display = msg ? 'inline' : 'none';
        });
      }
      bindHint(loginInput, loginHint);
      bindHint(regInput, regHint);
    }

    // ===== ุชุญุฏูุซ ุฃุฑูุงู ุงูุนููุงู =====
      function updateTopStats(data){
        try{
          const u = document.getElementById('totalUsersBottom');
          const t = document.getElementById('totalTripsBottom');
          const s = document.getElementById('satisfactionBottom');

          if(u) u.textContent = data?.totalUsers ?? '-';
          if(t) t.textContent = data?.totalTrips ?? '-';

          if(s){
            const v = data?.satisfaction;
            if (v == null || v === '-') { s.textContent = '-'; }
            else if (typeof v === 'string' && v.trim().endsWith('%')) { s.textContent = v; }
            else if (!isNaN(Number(v))) { s.textContent = `${Number(v)}`.replace(/\.0+$/,'') + '%'; }
            else { s.textContent = String(v); }
          }
        }catch{}
      }
      function setIsHome(active){
        document.body.classList.toggle('is-home', !!active);
      }


    // ===== ูุงุฌูุฉ ุงููุณุชุฎุฏู: ุชุจููุจุงุช =====
    function switchTab(name){
      // ููุน ุงูุชููู ุฅู ูู ูููู ุงูุฏุฎูู
      if(guardNavigation(new Event('nav'))) return;

      $$('.tab').forEach(b=> b.classList.toggle('active', b.dataset.tab===name));
      $$('.content').forEach(sec=>{
        const active = (sec.id === (name+'Content'));
        sec.classList.toggle('active', active);
        sec.setAttribute('aria-hidden', active ? 'false' : 'true');
      });
      // ุชุญุฏูุซ ุงููุญุชูู ุนูุฏ ูุชุญ ุชุจููุจ ูุนููู
      if(name==='drivers')   loadDrivers();
      if(name==='requests')  loadRequests();
      if(name==='home')      loadMyStats();
      if(name==='book')      prepareBookingUI();
      if(name==='rate')      prepareRatingUI();
      setIsHome(name === 'home');
    }

    // ===== ุชุญููู ุงูุฅุนุฏุงุฏุงุช ูู config.json =====
    async function loadConfig(){
      const url = 'config.json?ts=' + Date.now(); // ุชูุงุฏู ุงููุงุด
      try{
        const res = await fetch(url, { cache:'no-store' });
        if(!res.ok) throw new Error('config.json not found ('+res.status+')');

        // ูู ุฑุฌุน HTML ุจุฏู JSON (ุจุนุถ ุงูุงุณุชุถุงูุงุช ุชุนูุฏ index.html)
        const ct = (res.headers.get('content-type') || '').toLowerCase();
        const raw = await res.text();
        if (ct.includes('text/html') || raw.trim().startsWith('<')) {
          console.error('[CONFIG] Expected JSON but got HTML. First 200 chars:\n', raw.slice(0,200));
          throw new Error('config.json returned HTML');
        }

        // ุฑุฌูุน ุงููุต ูู JSON ุจุนุฏ ุงููุญุต
        const cfg = JSON.parse(raw);
        CFG = cfg;

        // ูุฏุนู ุฃุณูุงุก ููุงุชูุญ ูุชุนุฏุฏุฉ (ูุฑููุฉ ููููุงุช ูุฏููุฉ/ุฌุฏูุฏุฉ)
        GOOGLE_SCRIPT_URL = sanitizeStr(
          cfg?.GOOGLE_SCRIPT_URL || cfg?.SCRIPT_URL || cfg?.scriptUrl || ''
        );
        API_KEY = sanitizeStr(
          cfg?.API_KEY || cfg?.apiKey || cfg?.defaultApiKey || ''
        );
        allowSelfRegister = !!cfg?.allowSelfRegister;

        // ุงูุฃูุงู: ุฅุฐุง ูุญุฏุฏุฉ ูู ุงูููู ูุณุชุฎุฏููุงุ ูุฅูุง ุฅุฐุง includeWeekend=true ูุถู ุงูุฌูุนุฉ+ุงูุณุจุช
        if (Array.isArray(cfg?.days) && cfg.days.length) {
          DAYS = cfg.days.map(String);
        } else if (cfg?.includeWeekend === true) {
          DAYS = ['ุงูุฃุญุฏ','ุงูุงุซููู','ุงูุซูุงุซุงุก','ุงูุฃุฑุจุนุงุก','ุงูุฎููุณ','ุงูุฌูุนุฉ','ุงูุณุจุช'];
        }
      }catch(e){
        console.warn('[CONFIG] Using defaults:', e.message);
        // ุฅุจูุงุก ุงูููู ุงูุงูุชุฑุงุถูุฉุ ูุชุฑู GOOGLE_SCRIPT_URL ูุงุฑุบูุง ููุธูุฑ ุดุฑูุท ุงูุญุงูุฉ "ุบูุฑ ูุชุตู"
      }
    }


    // ===== ุนูุงุตุฑ ุงููุงุฌูุฉ ุงููุณุงุนุฏุฉ =====
    function fillDaysCheckboxes(){
      const host = document.getElementById('daysGroup');
      if(!host) return;
      host.innerHTML = '';
      DAYS.forEach((d, i)=>{
        const id = 'day_'+i;
        const w = document.createElement('label');
        w.className = 'checkbox-item';
        w.innerHTML = `<input type="checkbox" value="${d}" id="${id}"><span>${d}</span>`;
        host.appendChild(w);
      });
    }

    function setUserHeaderUI(user){
      const name = document.getElementById('userName');
      const role = document.getElementById('userRole');
      const homeU = document.getElementById('homeUserName');
      if(name)  name.textContent  = sanitizeStr(user?.name || 'ูุณุชุฎุฏู');
      if(homeU) homeU.textContent = sanitizeStr(user?.name || 'ูุณุชุฎุฏู');
      if(role)  role.textContent  = sanitizeStr(user?.userType || 'ุฑุงูุจ');
    }

    // ===== ุงูุณุงุฆููู =====
    function renderDrivers(list){
      const wrap = document.getElementById('driversList');
      const countEl = document.getElementById('availableDriversCount');
      if(countEl) countEl.textContent = `(${list?.length ?? 0})`;
      if(!wrap) return;

      if(!list || !list.length){
        wrap.innerHTML = `<div class="alert alert-warning">ูุง ููุฌุฏ ุณุงุฆููู ูุชุงุญูู ุญุงููุงู</div>`;
        return;
      }

      wrap.innerHTML = '';
      list.forEach(d=>{
        const phone = getWaPhoneFromRecord(d);
        const waUrl = phone ? buildWaUrl(phone, `ูุฑุญุจุงู ${d.name}ุ ุฃูุฏ ุงูุชูุณูู ูุฑุญูุฉ ุนุจุฑ "ุณุงูุฏ".`) : '';
        const card = document.createElement('div');
        card.className = 'driver-card';
        card.innerHTML = `
          <div class="driver-info">
            <div class="driver-details">
              <h3>${sanitizeStr(d.name || 'ุจุฏูู ุงุณู')}</h3>
              <p>ุงูุฑูู: <strong>${sanitizeStr(d.traineeId || d.id || '')}</strong></p>
              <p>ุงูุญู: ${sanitizeStr(d.neighborhood || '-')}</p>
              <p class="rating">ุงูุชูููู: ${'โญ'.repeat(Math.max(1, Math.min(5, Number(d.rating)||0)))} (${d.rating||0})</p>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              ${waUrl ? `<a class="btn btn-whatsapp" href="${waUrl}" target="_blank" rel="noopener">ูุงุชุณุงุจ</a>`:''}
              <button class="btn btn-primary" data-pick="${sanitizeStr(d.traineeId || d.id || '')}">ุงุฎุชูุงุฑ</button>
            </div>
          </div>
        `;
        wrap.appendChild(card);
      });

      // ุงุฎุชูุงุฑ ุณุฑูุน ูุณุงุฆู
      wrap.querySelectorAll('button[data-pick]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-pick');
          lastQuickDriverId = id;
          document.querySelector('.tab[data-tab="book"]')?.click();
          setTimeout(()=>{
            const sel = document.getElementById('selectedDriver');
            if(sel){
              const match = drivers.find(x => (x.traineeId||x.id) == id);
              if(match){
                sel.value = (match.traineeId || match.id || '');
              }
            }
          }, 50);
        });
      });
    }

    async function loadDrivers(){
      try{
        const q = $('#searchDriver')?.value?.trim() || '';
        const neigh = $('#filterNeighborhood')?.value || '';
        const {data} = await fetchWithCache('getDrivers', {}, {ttl:CACHE_TTL.getDrivers});
        let list = Array.isArray(data) ? data : [];

        // ููุชุฑุฉ
        if(q){
          const nq = normalizeDigits(q).toLowerCase();
          list = list.filter(d =>
            String(d.name||'').toLowerCase().includes(nq) ||
            String(d.traineeId||d.id||'').toLowerCase().includes(nq)
          );
        }
        if(neigh) list = list.filter(d => String(d.neighborhood||'') === neigh);

        drivers = list;
        renderDrivers(list);
      }catch(e){
        $('#driversList').innerHTML = `<div class="alert alert-error">ุชุนุฐุฑ ุชุญููู ูุงุฆูุฉ ุงูุณุงุฆููู</div>`;
      }
    }

    // ===== ุทูุจุงุช ุงููุณุชุฎุฏู =====
    function renderRequests(list){
      const host = document.getElementById('userRequestsList');
      const badge = document.getElementById('requestsBadge');
      if(!host) return;

      if(!list || !list.length){
        host.innerHTML = `<div class="alert alert-info">ูุง ุชูุฌุฏ ุทูุจุงุช ุญุงููุงู</div>`;
        if(badge){ badge.textContent='0'; badge.style.display='none'; }
        return;
      }

      host.innerHTML = '';
      let activeCount = 0;

      list.forEach(r=>{
        const st = String(r.status||'pending');
        if(st==='pending') activeCount++;
        const cls = st==='accepted' ? 'accepted' : (st==='rejected' ? 'rejected' : '');
        const d = document.createElement('div');
        d.className = `request-card ${cls}`;
        d.innerHTML = `
          <div class="request-header">
            <div class="request-title">ุทูุจ #${sanitizeStr(r.id||'-')}</div>
            <div class="status-${st==='accepted'?'accepted':(st==='rejected'?'rejected':'pending')}">
              ${st==='accepted'?'ููุจูู':(st==='rejected'?'ูุฑููุถ':'ููุฏ ุงููุฑุงุฌุนุฉ')}
            </div>
          </div>
          <div class="request-details">
            <p>ุงูุณุงุฆู: <strong>${sanitizeStr(r.driverName || '-')}</strong></p>
            <p>ุงูุฃูุงู: ${Array.isArray(r.days)? r.days.join('ุ ') : '-'}</p>
            <p>ุงููุฏุฉ: ${sanitizeStr(r.duration || '-')} ุฃุณุจูุน</p>
            ${r.notes? `<p>ููุงุญุธุงุช: ${sanitizeStr(r.notes)}</p>`:''}
          </div>
        `;
        host.appendChild(d);
      });

      if(badge){
        badge.textContent = String(activeCount);
        badge.style.display = activeCount ? 'inline-flex' : 'none';
      }
    }

    async function loadRequests(){
      if(!currentUser) return;
      try{
        const {data} = await fetchWithCache('getPassengerRequests', { passengerTraineeId: currentUser.traineeId }, { ttl: CACHE_TTL.getPassengerRequests });
        renderRequests(Array.isArray(data)?data:[]);
      }catch{
        $('#userRequestsList').innerHTML = `<div class="alert alert-error">ุชุนุฐุฑ ุชุญููู ุงูุทูุจุงุช</div>`;
      }
    }


    function pickNumber(obj, keys){
        for(const k of keys){
          const v = Number(obj?.[k]);
          if(!Number.isNaN(v) && v >= 0) return v;
        }
        return null;
      }

    // ===== ุฅุญุตุงุฆูุงุชู =====
      function updateMyStatsUI(data){
        $('#myTripsCount').textContent     = (data?.totalTrips ?? '-');
        $('#myRating').textContent         = data?.rating ? `${data.rating} โญ` : '-';
        $('#myActiveRequests').textContent = data?.activeRequests ?? '-';
        $('#communitySize').textContent    = (data?.community ?? '-');
      }


    async function loadMyStats(){
      if(!currentUser) return;
      try{
          const [{data:me},{data:top}] = await Promise.all([
            fetchWithCache('getUserStats', {
              traineeId: currentUser.traineeId,
              userType: currentUser.userType   // โ ูุฐุง ูู ุงูููู
            }, {ttl: CACHE_TTL.getUserStats}),
            fetchWithCache('getTopStats', {}, {ttl: CACHE_TTL.getTopStats})
          ]);


        // ุฌููุฒ โcommunityโ ุญุชู ูู ุงูุณูุฑูุฑ ูุง ุฑุฌูุนู
        const communityFallback = pickNumber(me, ['community','communitySize','members','users','community_count'])
                              ?? pickNumber(top, ['totalUsers','users']);
        const merged = {...(me||{}), community: communityFallback};

        updateMyStatsUI(merged||{});
      }catch(e){
        // ูููู ุชุฎูููุง ุตุงูุชุฉ ุฃู ุชุถูู ููุฌ:
        console.debug('loadMyStats error', e);
      }
    }


    // ===== ุงูุญุฌุฒ =====
    function prepareBookingUI(){
      // ุชุนุจุฆุฉ ุงูุณุงุฆููู ูู ุงูุณููุช
      const sel = document.getElementById('selectedDriver');
      if(sel){
        const cur = sel.value;
        sel.innerHTML = `<option value="">ุงุฎุชุฑ ุงูุณุงุฆู</option>` + drivers.map(d=>{
          const id = sanitizeStr(d.traineeId || d.id || '');
          const nm = sanitizeStr(d.name || id || 'ุณุงุฆู');
          return `<option value="${id}">${nm} โ ${sanitizeStr(d.neighborhood||'-')}</option>`;
        }).join('');
        if(lastQuickDriverId) sel.value = lastQuickDriverId;
        if(cur && !sel.value) sel.value = cur;
      }
      fillDaysCheckboxes();
    }

    async function submitBooking(ev){
      ev?.preventDefault?.();
      if(!currentUser){ showToast('ุณุฌูู ุงูุฏุฎูู ุฃููุงู','warn'); return; }

      const driverId = $('#selectedDriver').value;
      const days = Array.from(document.querySelectorAll('#daysGroup input:checked')).map(i=>i.value);
      const duration = Number($('#duration').value || 0);
      const notes = $('#tripNotes').value.trim();

      if(!driverId){ showToast('ุงุฎุชุฑ ุงูุณุงุฆู','warn'); return; }
      if(!days.length){ showToast('ุงุฎุชุฑ ุนูู ุงูุฃูู ููู ูุงุญุฏ','warn'); return; }
      if(!duration){ showToast('ุงุฎุชุฑ ุงููุฏุฉ','warn'); return; }

      const driver = drivers.find(d => (d.traineeId||d.id) == driverId);
      const wa = driver ? getWaPhoneFromRecord(driver) : '';

      try{
        $('#bookingBtn').disabled = true;
        const payload = {
          passengerId: currentUser.traineeId,
          passengerName: currentUser.name,
          driverId,
          days,
          duration,
          notes
        };
        const resp = await sendToGoogleSheets('submitBooking', payload);
        if(resp?.ok){
          showToast('ุชู ุฅุฑุณุงู ุงูุทูุจ ุจูุฌุงุญ','success');
          // ูุงุชุณุงุจ ุงุฎุชูุงุฑู
          if(wa){
            const msg = `ูุฑุญุจุงู ${driver?.name||''}ุ ุฃูุง ${currentUser.name}. ุทูุจุช ุชูุตูู (${days.join('ุ ')}) ููุฏุฉ ${duration} ุฃุณุจูุน(ุฃุณุงุจูุน) ุนุจุฑ "ุณุงูุฏ".`;
            window.open(buildWaUrl(wa, msg), '_blank', 'noopener');
          }
          loadRequests();
          document.querySelector('.tab[data-tab="requests"]')?.click();
        }else{
          showToast('ุชุนุฐุฑ ุญูุธ ุงูุทูุจ','error');
        }
      }catch{
        showToast('ุฎุทุฃ ูู ุงูุงุชุตุงู','error');
      }finally{
        $('#bookingBtn').disabled = false;
      }
    }

    // ===== ุงูุชูููู =====
    function prepareRatingUI(){
      const sel = document.getElementById('ratedDriver');
      if(!sel) return;
      const cur = sel.value;
      sel.innerHTML = `<option value="">ุงุฎุชุฑ</option>` + drivers.map(d=>{
        const id = sanitizeStr(d.traineeId || d.id || '');
        const nm = sanitizeStr(d.name || id || 'ุณุงุฆู');
        return `<option value="${id}">${nm}</option>`;
      }).join('');
      if(cur) sel.value = cur;
    }

    async function submitRating(ev){
      ev?.preventDefault?.();
      if(!currentUser){ showToast('ุณุฌูู ุงูุฏุฎูู ุฃููุงู','warn'); return; }
      const driverId = $('#ratedDriver').value;
      const stars    = Number($('#ratingStars').value || 0);
      const notes    = $('#ratingNotes').value.trim();

      if(!driverId || !stars){ showToast('ุงุฎุชุฑ ุงูุณุงุฆู ูุงูุชูููู','warn'); return; }

      try{
        $('#ratingBtn').disabled = true;
        const payload = {
          passengerId: currentUser.traineeId,
          driverId,
          stars,
          notes
        };
        const resp = await sendToGoogleSheets('submitRating', payload);
        if(resp?.ok){
          showToast('ุดูุฑุงู ูุชููููู','success');
          $('#ratingForm').reset();
          loadMyStats();
        }else{
          showToast('ุชุนุฐุฑ ุฅุฑุณุงู ุงูุชูููู','error');
        }
      }catch{
        showToast('ุฎุทุฃ ูู ุงูุงุชุตุงู','error');
      }finally{
        $('#ratingBtn').disabled = false;
      }
    }

    // ===== ุงูุชุณุฌูู =====
    async function submitRegistration(ev){
      ev?.preventDefault?.();
      const name  = $('#name').value.trim();
      const id    = normalizeDigits($('#traineeId').value.trim());
      const phone = normalizePhoneKSA($('#phone').value);
      const hood  = $('#neighborhood').value;
      const type  = $('#userType').value;

      if(!name || !id || !phone || !hood || !isValidUserType(type)){
        showToast('ุฃููู ุงูุญููู ุงููุทููุจุฉ ุจุดูู ุตุญูุญ','warn'); return;
      }

      try{
        $('#registerBtn').disabled = true;
        const payload = {name, traineeId:id, phone, neighborhood:hood, userType:type};
        const resp = await sendToGoogleSheets('registerUser', payload);
        if(resp?.ok){
          showToast('ุชู ุงูุชุณุฌูู ุจูุฌุงุญุ ููููู ุงูุฏุฎูู ุงูุขู','success');
          // ุนูุฏุฉ ูุดุงุดุฉ ุงูุฏุฎูู
          setAppMode('login');
          $('#loginTraineeId').value = id;
        }else{
          showToast(resp?.error||'ุชุนุฐุฑ ุฅุชูุงู ุงูุชุณุฌูู','error');
        }
      }catch{
        showToast('ุฎุทุฃ ูู ุงูุงุชุตุงู','error');
      }finally{
        $('#registerBtn').disabled = false;
      }
    }

    // ===== ุชุณุฌูู ุงูุฏุฎูู =====
    async function doLogin(){
      const raw = $('#loginTraineeId').value.trim();
      const id  = normalizeDigits(raw);
      if(!/^\d{6,}$/.test(id)){ showToast('ุฑูู ุงููุชุฏุฑุจ ุบูุฑ ุตุญูุญ','warn'); return; }

      try{
        $('#loginBtn').disabled = true;
        const resp = await sendToGoogleSheets('verifyUser', { traineeId: id });

        const valid =
          resp && resp.success === true &&
          resp.data && typeof resp.data === 'object' &&
          typeof resp.data.traineeId === 'string' &&
          resp.data.traineeId.replace(/\s/g,'') === id &&
          isValidUserType(resp.data.userType) &&
          typeof resp.data.name === 'string' && resp.data.name.trim().length > 0;

        if (valid) {
          currentUser = resp.data;
          setUserHeaderUI(currentUser);
          setAppMode('app');
          document.documentElement.classList.add('app-ready');
          showToast('ูุฑุญุจุงู ุจู ูู ุณุงูุฏ','success');
          heartbeat(); loadDrivers(); loadRequests(); loadMyStats();
        } else {
          if (allowSelfRegister) {
            showToast('ูู ูุชู ุงูุนุซูุฑ ุนูู ุฑููู โ ุฃููู ุงูุชุณุฌูู','warn');
            setAppMode('register_only');
            $('#traineeId').value = id;
          } else {
            showToast('ุฑููู ุบูุฑ ููุฌูุฏ โ ุชูุงุตู ูุน ุงูููุดุฃุฉ','error');
          }
        }

      }catch{
        showToast('ุชุนุฐุฑ ุงูุชุญูู ูู ุงูุฑูู','error');
      }finally{
        $('#loginBtn').disabled = false;
      }
    }

    // ===== ุงูุซูู =====
    function toggleTheme(){
      const root = document.documentElement;
      const btn  = document.getElementById('themeToggleBtn');
      const dark = root.classList.toggle('dark');
      if(btn) btn.textContent = dark ? 'ุงููุถุน ุงููุงุชุญ' : 'ุงููุถุน ุงูุฏุงูู';
      try{ localStorage.setItem('sand_theme', dark?'dark':'light'); }catch{}
    }
    function restoreTheme(){
      try{
        const v = localStorage.getItem('sand_theme');
        if(v==='dark'){ document.documentElement.classList.add('dark'); $('#themeToggleBtn').textContent='ุงููุถุน ุงููุงุชุญ'; }
      }catch{}
    }

    // ===== ุฏุนู ุนุงุฆู =====
    function setupSupportFab(){
      const fab = document.getElementById('supportFab');
      const welcomeTip = document.getElementById('welcomeSupportTip');
      if(!fab) return;
      
      const main = fab.querySelector('button.main');
      const menu = fab.querySelector('.support-menu');
      
      // ุฅุธูุงุฑ ุงูุชูููุญ ุงูุชุฑุญูุจู ุชููุงุฆููุง
      const hasSeenTip = localStorage.getItem('sand_support_tip_seen');
      if(!hasSeenTip && welcomeTip){
        setTimeout(()=>{
          welcomeTip.classList.add('show');
          
          // ุฅุฎูุงุก ุจุนุฏ 6 ุซูุงูู
          setTimeout(()=>{
            welcomeTip.classList.remove('show');
            localStorage.setItem('sand_support_tip_seen', 'true');
          }, 6000);
        }, 1500); // ุชุฃุฎูุฑ ุซุงููุฉ ููุต ุจุนุฏ ุงูุฏุฎูู
      }
      
      // ุฅุบูุงู ุงูุชูููุญ ุนูุฏ ุงูุถุบุท ุนูู ร
      if(welcomeTip){
        welcomeTip.addEventListener('click', (e)=>{
          if(e.target === welcomeTip || e.offsetX > welcomeTip.offsetWidth - 30){
            welcomeTip.classList.remove('show');
            localStorage.setItem('sand_support_tip_seen', 'true');
          }
        });
      }
      
      // ูุชุญ/ุฅุบูุงู ูุงุฆูุฉ ุงูุฏุนู
      main?.addEventListener('click', ()=>{
        fab.classList.toggle('open');
        if(welcomeTip) welcomeTip.classList.remove('show');
      });
      
      // ุฅุบูุงู ุนูุฏ ุงูุถุบุท ุฎุงุฑุฌ ุงููุงุฆูุฉ
      document.addEventListener('click', (e)=>{
        if(!fab.contains(e.target)){
          fab.classList.remove('open');
        }
      });
    }
    // ===== ุฅุญุฏุงุซูุงุช ุงููุงุฌูุฉ =====
    function setupUIEvents(){
      // ุชุจููุจุงุช
      $$('.tab').forEach(b=>{
        b.addEventListener('click', ()=> switchTab(b.dataset.tab));
      });

      $('#openHousingBtn')?.addEventListener('click', ()=>{
        // ุงูุชุญ ุตูุญุฉ ุนุงูุฉ ูุณุชููุฉ ูุณุงูุฏ ููุณูู
        window.location.href = 'housing.html';
      });


      // ุฃุฒุฑุงุฑ
      $('#refreshDriversBtn')?.addEventListener('click', loadDrivers);
      $('#refreshRequestsBtn')?.addEventListener('click', loadRequests);
      $('#bookingForm')?.addEventListener('submit', submitBooking);
      $('#ratingForm')?.addEventListener('submit', submitRating);
      $('#registrationForm')?.addEventListener('submit', submitRegistration);
      $('#loginBtn')?.addEventListener('click', doLogin);
      $('#logoutBtn')?.addEventListener('click', ()=>{
        currentUser = null;
        showToast('ุชู ุชุณุฌูู ุงูุฎุฑูุฌ','info');
        setAppMode('login');
      });
      $('#themeToggleBtn')?.addEventListener('click', toggleTheme);

      // ุจุญุซ/ููุชุฑุฉ ุงูุณุงุฆููู
      $('#searchDriver')?.addEventListener('input', ()=> loadDrivers());
      $('#filterNeighborhood')?.addEventListener('change', ()=> loadDrivers());

      // ุฒุฑ ุงูุฑุฌูุน ูู ุงูุชุณุฌูู
      $('#backToLoginBtn')?.addEventListener('click', ()=> setAppMode('login'));

      // ุฒุฑ ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
      $('#refreshHomeStats')?.addEventListener('click', async () => {
        const btn = $('#refreshHomeStats');
        btn.disabled = true;
        btn.textContent = 'โณ ุฌุงุฑู ุงูุชุญุฏูุซ...';
        await loadMyStats();
        await heartbeat();
        btn.textContent = '๐ ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช';
        btn.disabled = false;
        showToast('ุชู ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช', 'success');
      });
      setupTraineeIdHints();
      setupSupportFab();
    }
          // ====== ุณุงูุฏ ููุณูู (rent) ======
      function telHref(raw=''){
        const s = normalizePhoneKSA(raw);      // ุฏุงูุฉ ููุฌูุฏุฉ ุนูุฏู
        return s ? `tel:+${s}` : '#';
      }

      // ุดูู ุงูุจุทุงูุฉ ููู ูุงูู
      function housingCard(row){
        const seq  = sanitizeStr(row.seq ?? row['ุงูุชุณูุณู'] ?? '');
        const name = sanitizeStr(row.owner ?? row['ุงุณู ุงููุงูู'] ?? '');
        const ph   = sanitizeStr(row.phone ?? row['ุฑูู ุงูุฌูุงู'] ?? '');
        const gov  = sanitizeStr(row.governorate ?? row['ุงููุญุงูุธุฉ'] ?? '');
        const hood = sanitizeStr(row.neighborhood ?? row['ุงูุญู'] ?? '');

        return `
          <div class="driver-card" style="margin-bottom:10px">
            <div class="driver-info">
              <div class="driver-details">
                <h3>${name || 'โ'}</h3>
                <p>ุงูุชุณูุณู: <strong>${seq || '-'}</strong></p>
                <p>ุงููุญุงูุธุฉ: ${gov || '-'}</p>
                <p>ุงูุญู: ${hood || '-'}</p>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                ${ph ? `<a class="btn btn-contact" href="${telHref(ph)}">๐ ุงุชุตุงู</a>` : '<span class="status-pending">ูุง ููุฌุฏ ุฑูู</span>'}
              </div>
            </div>
          </div>
        `;
      }

      function renderHousingTabs(data){
        const tabsWrap = document.getElementById('housingTabs');
        const panels   = document.getElementById('housingPanels');
        if(!tabsWrap || !panels) return;

        // ุชุฌููุน ุญุณุจ ุงููุญุงูุธุฉ
        const byGov = new Map();
        (Array.isArray(data) ? data : []).forEach(r=>{
          const gov = sanitizeStr(r.governorate ?? r['ุงููุญุงูุธุฉ'] ?? 'ุฃุฎุฑู') || 'ุฃุฎุฑู';
          if(!byGov.has(gov)) byGov.set(gov, []);
          byGov.get(gov).push(r);
        });

        tabsWrap.innerHTML = '';
        panels.innerHTML = '';

        const govs = Array.from(byGov.keys()).sort((a,b)=> a.localeCompare(b, 'ar'));

        govs.forEach((gov, idx)=>{
          const tid = `hgov_${idx}`;

          // ุฒุฑ ุชุจููุจ ูููุญุงูุธุฉ
          const btn = document.createElement('button');
          btn.className = 'tab' + (idx===0 ? ' active' : '');
          btn.type = 'button';
          btn.dataset.tab = tid;
          btn.textContent = gov;
          tabsWrap.appendChild(btn);

          // ุงููุญุชูู ุงูุฎุงุต ุจูุฐู ุงููุญุงูุธุฉ
          const panel = document.createElement('div');
          panel.className = 'content' + (idx===0 ? ' active' : '');
          panel.id = tid;
          panel.innerHTML = byGov.get(gov).map(housingCard).join('') || `
            <div class="alert alert-info">ูุง ุชูุฌุฏ ุนุฑูุถ ูู ูุฐู ุงููุญุงูุธุฉ ุญุงููุงู</div>`;
          panels.appendChild(panel);
        });

        // ุชุจุฏูู ุชุจููุจุงุช ุงูุณูู
        tabsWrap.querySelectorAll('.tab').forEach(b=>{
          b.addEventListener('click', ()=>{
            tabsWrap.querySelectorAll('.tab').forEach(x=> x.classList.toggle('active', x===b));
            panels.querySelectorAll('.content').forEach(sec=>{
              const active = (sec.id === b.dataset.tab);
              sec.classList.toggle('active', active);
              sec.setAttribute('aria-hidden', active ? 'false' : 'true');
            });
          });
        });
      }

      async function loadHousing(){
        try{
          const {data} = await fetchWithCache('getRent', {}, {ttl: 60000});
          renderHousingTabs(Array.isArray(data) ? data : []);
        }catch(e){
          const panels = document.getElementById('housingPanels');
          if(panels){
            panels.innerHTML = `<div class="alert alert-error">ุชุนุฐุฑ ุชุญููู ุจูุงูุงุช ุงูุณูู</div>`;
          }
        }
      }


    // ===== ุดุงุดุฉ ุงูููุฏูุฉ =====
    async function startApp(){
      const startBtn = document.getElementById('startBtn');
      const loader   = document.getElementById('introLoader');
      startBtn?.addEventListener('click', async ()=>{
        try{
          startBtn.disabled = true;
          loader?.classList.add('show');
          await loadConfig();
          restoreTheme();
          try{
            await heartbeat();
            setConnStatus('online');
          }catch{
            setConnStatus('offline');
          }
          // ุฌุงูุฒูุฉ ุงููุงุฌูุฉ
          document.documentElement.classList.add('app-ready');
          setAppMode('login');
          setupUIEvents();
          // ุชุญุฏูุซ ุฏูุฑู ููุฅุญุตุงุฆูุงุช
          if(requestsAutoTimer) clearInterval(requestsAutoTimer);
          requestsAutoTimer = setInterval(heartbeat, 60000);
        }catch{
          showToast('ุชุนุฐุฑ ุจุฏุก ุงูุชุทุจูู โ ุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช','error');
        }finally{
          loader?.classList.remove('show');
          startBtn.disabled = false;
        }
      });
    }

    // ุชุดุบูู
    document.addEventListener('DOMContentLoaded', ()=>{
      try{
        // ูู ูุงู ุงููุณุชุฎุฏู ูุฏ ุฏุฎู ุณุงุจูุงู (ูุณุชูุจูุงู ูููู ุงุณุชุฎุฏุงู ุชุฎุฒูู ุขูู)
        // ุญุงููุงู ูุจุฏุฃ ูู ุดุงุดุฉ ุงูููุฏูุฉ
        startApp();
      }catch(e){
        console.error(e);
      }
    });
  </script>
</body>
</html>
