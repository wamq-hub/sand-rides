<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ساند - نظام توصيل المتدربين</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      /* لوحة TVTC تقريبية */
      --tvtc-blue:#1e3c72;   /* أزرق رئيسي */
      --tvtc-teal:#00a49a;   /* أخضر مُزرق */
      --tvtc-navy:#0b1f3a;   /* أزرق داكن */

      --bg-grad:linear-gradient(135deg,var(--tvtc-blue) 0%,var(--tvtc-teal) 100%);
      --header-grad:linear-gradient(135deg,var(--tvtc-navy) 0%,var(--tvtc-blue) 100%);

      --card-bg:#fff;
      --text:#1f2937;
      --muted:#495057;
      --border:#e9ecef;

      /* شرائح الحالة */
      --chip-ok-bg:#d4edda;  --chip-ok-text:#155724;
      --chip-warn-bg:#fff3cd;--chip-warn-text:#856404;
      --chip-bad-bg:#f8d7da; --chip-bad-text:#721c24;

      /* بطاقات الطلب */
      --req-warn-bg:#fff8e1; --req-warn-bd:#ffcc02;
      --req-acc-bg:#e8f5e8;  --req-acc-bd:#4caf50;
      --req-rej-bg:#ffebee;  --req-rej-bd:#f44336;
    }


    /* الوضع الداكن */
    .dark{
      --bg-grad:linear-gradient(135deg,#0f172a 0%,#0b1f3a 100%);
      --card-bg:#111827;
      --text:#e5e7eb;
      --muted:#cbd5e1;
      --border:#374151;
      --header-grad:linear-gradient(135deg,#0b1f3a 0%,#1e3c72 100%);

      --chip-ok-bg:#064e3b; --chip-ok-text:#a7f3d0;
      --chip-warn-bg:#92400e; --chip-warn-text:#fde68a;
      --chip-bad-bg:#7f1d1d; --chip-bad-text:#fecaca;

      --req-warn-bg:#2a2610; --req-warn-bd:#b69100;
      --req-acc-bg:#11331a;  --req-acc-bd:#3aa85e;
      --req-rej-bg:#3a1618;  --req-rej-bd:#cc3535;
    }
    /* خط أساسي + بدائل عربية آمنة */
    body{
      font-family: 'Sakkal Majalla','Noto Naskh Arabic','Cairo','Tajawal','Segoe UI','Tahoma',sans-serif;
      background:var(--bg-grad);
      min-height:100vh;
      color:var(--text);
      padding:20px;
      padding-bottom:200px;  /* ✅ زيادة كبيرة */
    }

    /* تحسين وضوح الحروف */
    html,body{
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }


    
      /* Card موحد للخطوات */
      .card {
        background: var(--card-bg);
        border: 1px solid rgba(0,0,0,.06);
        border-radius: 16px;
        box-shadow: 0 6px 18px rgba(0,0,0,.06);
        padding: 18px;
      }

      /* زر Primary و Outline (نفس الألوان) */
      .btn-primary {
        background: linear-gradient(135deg, var(--tvtc-blue), var(--tvtc-teal));
      }
      .btn-outline {
        background: transparent;
        color: var(--tvtc-blue);
        border: 2px solid var(--tvtc-blue);
      }
      .dark .btn-outline {
        color: #e5e7eb;
        border-color: #e5e7eb33;
      }

      /* تركيز الحقول */
      .form-control:focus {
        outline: none;
        border-color: var(--tvtc-blue);
        box-shadow: 0 0 0 3px rgba(30, 60, 114, .15);
      }

      /* شارة القسم (Pill) أخف */
      .section-pill {
        display:inline-block;
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--card-bg);
        font-weight: 700;
      }
    /* حاوية رئيسية */
    .container{
      max-width:1040px;
      margin:0 auto 180px auto;  /* ✅ زيادة المسافة */
      border-radius:15px;
      box-shadow:0 20px 40px rgba(0,0,0,.1);
      overflow:hidden;
      background:var(--card-bg);
    }
    /* هيدر */
    .header{
      background:var(--header-grad);
      color:#fff;
      padding:18px 10px;
    }

    /* الهيدر: أعطِ العمود الأول عرضًا كافيًا */
    .header-bar{
      display:grid;
      grid-template-columns: 1fr auto 1fr;  /* عمود أيسر فارغ، عمود وسط للشعار، عمود أيمن للأزرار */
      align-items:center;
      gap:12px;
      position: relative;
    }




    .user-name{font-weight:700}
    .role-badge{
      background:#0ea5e9;
      color:#fff;
      padding:4px 10px;
      border-radius:999px;
      font-size:.85rem;
    }

    .user-actions{display:flex;align-items:center;grid-column: 3;justify-self:end}
    .logout-btn{
      background:#ef4444;
      color:#fff;border:none;border-radius:8px;
      padding:8px 14px;font-weight:700;cursor:pointer;transition:.2s
    }
    .logout-btn:hover{background:#dc2626}


    /* شعار مكدّس عموديًا */
    /* 2) النص في المنتصف */
      /* ضع الكتلة في العمود الأوسط ووسّط النص */
      .brand-inline{
        grid-column: 2;        /* العمود الأوسط */
        justify-self: center;
        text-align: center;
      }
      
      .brand-inline .brand-logo-tall{
        position: static !important;   /* إلغاء الـ absolute */
        height: 64px;                  /* أو 72px حسب رغبتك */
        width: auto;
        transform: none !important;
        right: auto !important;
        left: auto !important;
        top: auto !important;
        margin: 0 auto;                /* توسيط داخل العمود الأوسط */
      }
    .brand-stack{display:flex;flex-direction:column;align-items:center;gap:8px;min-width:0}
    .brand-logo-tall{
      height: 120px;  /* ✅ زيادة الحجم الكلي */
      width: 120px;
      object-fit: contain;
      display: block;
      margin: 0 auto;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.15));
      border: 3px solid rgba(255, 255, 255, 0.4);
      border-radius: 12px;
      padding: 0px;  /* ✅ زيادة المسافة الداخلية */
      background: #ffffff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .brand-text .logo{font-size:1.6rem;line-height:1.1;font-weight:800;white-space:nowrap}
    .brand-text .tagline{font-size:.95rem;opacity:.9;line-height:1.1}

    /* شريط الأرقام في الأعلى */
    .stats-bar{display:flex;justify-content:center;gap:28px;margin-top:10px}
    .stat-item{text-align:center}
    .stat-number{font-size:1.2rem;font-weight:700}
    .stat-label{font-size:.85rem;opacity:.95}

    /* منطقة الدخول */
    .login-section{padding:35px;background:linear-gradient(135deg,#f8f9fa 0%,#ffffff 100%);border-bottom:1px solid #e9ecef}
    .login-container{max-width:520px;margin:0 auto;text-align:center}
    .welcome-message{font-size:1.15rem;color:#2c5aa0;margin-bottom:18px;font-weight:700}
    .login-form{display:none;animation:fade .45s}
    .login-form.active{display:block}

    /* تبويبات */
    .tabs{display:none;background:#f8f9fa;border-bottom:1px solid #dee2e6}
    .tabs.active{display:flex;flex-wrap:wrap}
    .tab{flex:1;padding:14px 10px;text-align:center;cursor:pointer;transition:.2s;background:#fff;border:0;font-size:1.02rem;font-weight:700;color:#495057;position:relative}
    .tab:hover{background:#e9ecef}
    .tab.active{background:#2c5aa0;color:#fff}
    .tab.badged .badge{
      position:absolute;top:6px;inset-inline-end:10px;background:#ef4444;color:#fff;min-width:20px;height:20px;
      padding:0 6px;border-radius:999px;font-size:.8rem;display:flex;align-items:center;justify-content:center;font-weight:800
    }

    /* محتوى */
    .content{padding:22px;min-height:440px;display:none}
    .content.active{display:block}
    @keyframes fade{from{opacity:.3;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}


          /* ===== Fix footer overlap & stacking ===== */
      :root{
        --footer-h: 58px;     /* سيُستبدل تلقائياً بالارتفاع الحقيقي عبر JS */
        --statsbar-h: 60px;
        --z-footer: 9000;
        --z-stats: 9050;
        --z-fab: 10050;       /* أعلى من الفوتر */
        --z-tip: 10060;       /* للتولتيب/الشارة */
      }

      body{
        min-height: 100dvh;
          padding-bottom: 20px;
      }


      /* ✅ شريط الإحصائيات ثابت في المحتوى */
      .stats-bottom-bar{
        position: static;  /* ثابت في التدفق الطبيعي */
        margin-top: 20px;
        padding: 10px 20px;
        background: linear-gradient(135deg, rgba(30, 60, 114, 0.85), rgba(0, 164, 154, 0.85));  /* ✅ ألوان المؤسسة */
        backdrop-filter: blur(12px);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        display: flex;
        justify-content: center;
        gap: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      /* ✅ الفوتر ثابت في نهاية الصفحة */
      .site-footer{
        position: static;  /* ثابت في التدفق الطبيعي */
        background: linear-gradient(135deg, rgba(30, 60, 114, 0.05), rgba(0, 164, 154, 0.05));
        border-top: 1px solid var(--border);
        padding: 20px;
        margin-top: 20px;
      }


      /* الزر العائم/التلميح/الشارة فوق الجميع وتتحرك آلياً */

      /* ضمان عدم قصّ أي منبثقات */
      .container{ overflow: visible; }

      /* للموبايل: قياسات أخف */
      @media (max-width: 768px){
        :root{ --footer-h: 56px; --statsbar-h: 64px; }
      }

    /* نماذج */
    .form-group{margin-bottom:16px}
    .form-group label{color:var(--muted)}
    .form-control{width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-size:1rem;transition:.2s;background:var(--card-bg);color:var(--text)}
    .form-control:focus{outline:none;border-color:#2c5aa0;box-shadow:0 0 0 3px rgba(44,90,160,.12)}
    .field-hint{font-size:.85rem;margin-top:6px}
    .field-hint.neutral{color:#6b7280}
    .field-hint.good{color:#16a34a}
    .field-hint.warn{color:#b45309}

    .btn{background:linear-gradient(135deg,#1cb26b 0%,#11a39b 100%);color:#fff;padding:12px 20px;border:none;border-radius:8px;font-weight:800;cursor:pointer;transition:.2s;text-decoration:none;display:inline-block}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,.15)}
    .btn:disabled{background:#6c757d;cursor:not-allowed;transform:none;opacity:.6}
    .btn-primary{background:linear-gradient(135deg,var(--tvtc-blue) 0%,var(--tvtc-teal) 100%)}
    .btn-secondary{background:linear-gradient(135deg,#6c757d 0%,#495057 100%);color:#fff}
    .btn-whatsapp{background:linear-gradient(135deg,#25d366 0%,#128c7e 100%);margin-inline:6px;padding:10px 16px;font-size:.92rem}
    .btn-accept{background:linear-gradient(135deg,#4caf50 0%,#45a049 100%)}
    .btn-reject{background:linear-gradient(135deg,#f44336 0%,#d32f2f 100%)}
    .btn-contact{background:linear-gradient(135deg,#2196f3 0%,#1976d2 100%)}

    .dashboard-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin:16px 0}
    .stat-card{background:linear-gradient(135deg,var(--tvtc-blue) 0%,var(--tvtc-teal) 100%);color:#fff;padding:16px;border-radius:12px;text-align:center}
    .stat-card .stat-number{font-size:1.7rem;margin-bottom:6px}

    .driver-card,.request-card{background:linear-gradient(135deg,rgba(248,249,250,.25) 0%,var(--card-bg) 100%);border:2px solid var(--border);border-radius:12px;padding:18px;margin-bottom:14px;transition:.2s}
    .driver-card:hover,.request-card:hover{border-color:#2c5aa0;transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.08)}

    .request-card{border-color:var(--req-warn-bd);background:linear-gradient(135deg,var(--req-warn-bg) 0%,var(--card-bg) 100%)}
    .request-card.accepted{border-color:var(--req-acc-bd);background:linear-gradient(135deg,var(--req-acc-bg) 0%,var(--card-bg) 100%)}
    .request-card.rejected{border-color:var(--req-rej-bd);background:linear-gradient(135deg,var(--req-rej-bg) 0%,var(--card-bg) 100%)}

    .driver-info,.request-header{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center;margin-bottom:10px}
    .driver-details h3,.request-title{color:#2c5aa0;margin-bottom:6px;font-size:1.06rem}
    .driver-details p,.request-details p{margin-bottom:4px;color:#555}
    .rating{color:#ffc107}

    .status-available,.status-accepted{background:var(--chip-ok-bg);color:var(--chip-ok-text);padding:4px 10px;border-radius:999px;font-weight:700}
    .status-booked,.status-rejected{background:var(--chip-bad-bg);color:var(--chip-bad-text);padding:4px 10px;border-radius:999px;font-weight:700}
    .status-pending{background:var(--chip-warn-bg);color:var(--chip-warn-text);padding:4px 10px;border-radius:999px;font-weight:700}

    .alert{padding:12px;border-radius:8px;margin-bottom:14px}
    .alert-success{background:#d4edda;border:1px solid #c3e6cb;color:#155724}
    .alert-info{background:#cce7ff;border:1px solid #99d6ff;color:#0c5460}
    .alert-warning{background:#fff3cd;border:1px solid #ffeaa7;color:#856404}
    .alert-error{background:#f8d7da;border:1px solid #f5c2c7;color:#721c24}

    .loading{text-align:center;padding:16px}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #2c5aa0;border-radius:50%;width:34px;height:34px;animation:spin 1s linear infinite;margin:0 auto}
    @keyframes spin{to{transform:rotate(360deg)}}

    .checkbox-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:6px}
    .checkbox-item{display:flex;align-items:center;gap:8px}

    /* شريط حالة الاتصال */
    .connbar{display:flex;align-items:center;gap:10px;justify-content:center;background:#0b132b;color:#fff;padding:10px;margin-top:10px;border-radius:12px}
    .conn-dot{width:10px;height:10px;border-radius:50%}
    .conn-online{background:#22c55e}
    .conn-connecting{background:#f59e0b}
    .conn-offline{background:#ef4444}
    .conn-text{font-weight:700}

    /* شاشة تعريف تغطي الصفحة كاملة */
    .intro-screen{position:fixed;inset:0;z-index:9999;display:grid;place-items:center;background:var(--bg-grad);padding:24px;overflow:auto}
    .intro-content{width:min(92vw,860px);max-height:92vh;overflow:auto;background:#ffffffd1;backdrop-filter:blur(6px);border-radius:18px;box-shadow:0 20px 40px rgba(0,0,0,.12);padding:24px;text-align:center}
    .intro-hero{display:block;max-width:100%;height:auto;border-radius:14px;margin:0 auto 14px}
    .intro-start{padding:12px 22px;border:0;border-radius:999px;font-weight:700;cursor:pointer;background:#0f172a;color:#fff;box-shadow:0 8px 18px rgba(0,0,0,.18);margin:10px 6px}
    .intro-start:active{transform:scale(.98)}
    .intro-loader{display:none;font-weight:700;margin-top:8px}
    .intro-loader.show{display:block}
    html:not(.app-ready) .container,
    html:not(.app-ready) .connbar,
    html:not(.app-ready) .site-footer{display:none!important}
    html:not(.app-ready),html:not(.app-ready) body{height:100%;overflow:hidden}
    html.app-ready #intro-screen{display:none!important}

    /* زر دعم عائم */
    .support-fab{
        position: fixed;
        inset-inline-end: 18px;
        bottom: 20px;  /* ✅ ثابت دائماً */
        z-index: 10050; /* ✅ فوق كل شيء */
      }

      /* للجوال: رفع الزر أعلى قليلاً */
      @media (max-width: 768px){
        .support-fab{
          bottom: 80px;  /* فوق الفوتر مباشرة */
          inset-inline-end: 15px;
        }
      }
      .support-fab button.main{
        width: 60px;    /* ✅ أكبر قليلاً */
        height: 60px;
        border: 0;
        border-radius: 999px;
        cursor: pointer;
        background: linear-gradient(135deg, #1e3c72 0%, #00a49a 100%);
        color: #fff;
        font-size: 26px;  /* ✅ أيقونة أكبر */
        box-shadow: 0 12px 28px rgba(0,0,0,.18);
        transition: all 0.3s ease;
      }

      .support-fab button.main:hover{
        transform: scale(1.1);  /* ✅ تكبير عند المرور */
      }

      /* للجوال: حجم أصغر */
      @media (max-width: 768px){
        .support-fab button.main{
          width: 52px;
          height: 52px;
          font-size: 22px;
        }
      }
      /* القائمة تظهر فوق الزر وبشكل مزاح يمينًا قليلاً */
      .support-menu{
        position: absolute;

        /* محاذاة للجهة الصحيحة في RTL (يمين العنصر) + بديل فيزيائي */
        inset-inline-start: 0;  /* في RTL = يمين */
        right: 0;               /* فallback للمتصفحات القديمة */

        /* فوق الزر بمسافة ثابتة بدل أرقام عشوائية */
        bottom: calc(100% + 10px); /* تظهر فوق الزر بـ 10px */
        /* إزاحة بسيطة لليمين */
        transform: translateX(20px);

        display: none;
        gap: 8px;
        flex-direction: column;
        align-items: flex-end;
        z-index: 10060; /* تأكد أنها فوق الفوتر */
      }
    .support-menu a{display:inline-flex;align-items:center;gap:8px;text-decoration:none;color:#fff;background:#111827;border-radius:999px;padding:10px 12px;font-weight:800;box-shadow:0 10px 20px rgba(0,0,0,.15)}
    .support-menu a .ico{width:26px;height:26px;display:grid;place-items:center;border-radius:999px;background:rgba(255,255,255,.12)}
    .support-menu a.wa{background:#128c7e}
    .support-menu a.mail{background:#0b5ed7}
    .support-fab.open .support-menu{display:flex}
    .support-tip.show{opacity:1;transform:translateY(0)}
      /* تلميح ترحيبي محسّن */
      .welcome-support-tooltip{
        position: fixed;
        inset-inline-end: 90px;
        bottom: 30px;  /* ✅ بجانب الزر */
        z-index: 10060; /* فوق كل شيء */
        background: linear-gradient(135deg, #1e3c72 0%, #00a49a 100%);
        color: #fff;
        padding: 0;
        border-radius: 16px;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
        opacity: 0;
        transform: translateX(20px) scale(0.9);
        pointer-events: none;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        max-width: 280px;
        animation: tooltipPulse 2s ease-in-out infinite;
      }

      .welcome-support-tooltip.show{
        opacity: 1;
        transform: translateX(0) scale(1);
        pointer-events: auto;
      }

      @keyframes tooltipPulse{
        0%, 100%{ box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25); }
        50%{ box-shadow: 0 12px 38px rgba(30, 60, 114, 0.4); }
      }

      .tooltip-arrow{
        position: absolute;
        inset-inline-start: 100%;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-inline-start: 10px solid #00a49a;
      }

      .tooltip-content{
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
      }

      .tooltip-icon{
        font-size: 2rem;
        line-height: 1;
        animation: tooltipWave 1.5s ease-in-out infinite;
      }

      @keyframes tooltipWave{
        0%, 100%{ transform: rotate(0deg); }
        25%{ transform: rotate(-15deg); }
        75%{ transform: rotate(15deg); }
      }

      .tooltip-text{
        display: flex;
        flex-direction: column;
        gap: 3px;
      }

      .tooltip-text strong{
        font-size: 0.95rem;
        font-weight: 800;
        line-height: 1.2;
      }

      .tooltip-text span{
        font-size: 0.8rem;
        opacity: 0.9;
        line-height: 1.2;
      }

      /* زر إغلاق خفي للتلميح */
      .welcome-support-tooltip::after{
        content: '×';
        position: absolute;
        top: 4px;
        inset-inline-end: 8px;
        font-size: 1.2rem;
        font-weight: 700;
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.2s;
        line-height: 1;
      }

      .welcome-support-tooltip:hover::after{
        opacity: 1;
      }


      .dark .brand-logo-tall{
        background: #ffffff;  /* خلفية بيضاء حتى في الوضع الداكن */
        border-color: rgba(30, 60, 114, 0.5);  /* إطار بلون المؤسسة */
      }

      /* تأثير نبض للزر لجذب الانتباه */
        @keyframes fabPulse{
          0%, 100%{ 
            box-shadow: 0 12px 28px rgba(0,0,0,.18); 
          }
          50%{ 
            box-shadow: 0 12px 38px rgba(30, 60, 114, .5), 0 0 0 8px rgba(30, 60, 114, .2); 
          }
        }

        .support-fab button.main{
          animation: fabPulse 3s ease-in-out infinite;
        }

        /* إيقاف النبض عند المرور أو الفتح */
        .support-fab.open button.main,
        .support-fab button.main:hover{
          animation: none;
        }

      /* للجوال */
      @media (max-width: 768px){
        .welcome-support-tooltip{
          inset-inline-end: 85px;
          bottom: 85px;
          max-width: 200px;
        }
        
        .tooltip-content{
          padding: 10px 12px;
          gap: 10px;
        }
        
        .tooltip-icon{
          font-size: 1.6rem;
        }
        
        .tooltip-text strong{
          font-size: 0.85rem;
        }
        
        .tooltip-text span{
          font-size: 0.75rem;
        }
      }

      /* إخفاء عند عدم الجاهزية */
      html:not(.app-ready) .welcome-support-tooltip{
        display: none !important;
      }
    /* فوتر ثابت */
    .site-footer{
      position: static;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(30, 60, 114, 0.05), rgba(0, 164, 154, 0.05));
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);
      z-index: 9999;
      padding: 20px;
      margin-top: 20px;

    }

    .footer-content{
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      max-width: 1040px;
      margin: 0 auto;
    }

    .footer-logo{
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .footer-icon{
      font-size: 2rem;
      line-height: 1;
    }

    .footer-text{
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .footer-text strong{
      font-size: 0.7rem;
      color: rgba(255,255,255,0.6);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }


    .footer-text span{
      font-size: 0.75rem;  /* تصغير الخط */
      color: #fff;
      font-weight: 700;
      line-height: 1.3;  /* تقليل المسافة بين الأسطر */
      font-family: 'Cairo', 'Tajawal', sans-serif;
    }

    .footer-institute{
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .institute-badge{
      background: linear-gradient(135deg, var(--tvtc-blue), var(--tvtc-teal));
      color: #fff;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 800;
      box-shadow: 0 2px 8px rgba(30, 60, 114, 0.3);
    }

    .version{
      font-size: 0.65rem;
      color: rgba(255,255,255,0.5);
      font-weight: 600;
    }

    @media (max-width: 768px){
      .site-footer{ padding: 6px 10px; }  /* مسافة أصغر */
      
      .footer-content{
        flex-direction: column;
        text-align: center;
        gap: 12px;
      }
      
      .footer-logo{
        flex-direction: column;
        gap: 8px;
      }
      
      .footer-text{
        align-items: center;
      }
      
      .footer-text strong{
        font-size: 0.65rem;
      }
      
      .footer-text span{
        font-size: 0.7rem;  /* أصغر للجوال */
        line-height: 1.2;
      }
      
      .footer-institute{
        align-items: center;
      }
      
      .institute-badge{
        font-size: 0.75rem;
        padding: 5px 12px;
      }
    }
    /* رسالة ترحيب */
    .welcome-banner{
      background: linear-gradient(135deg, #1e3c72, #00a49a);
      color: #fff;
      padding: 12px 20px;
      text-align: center;
      border-radius: 10px;
      margin-bottom: 16px;
      animation: slideDown 0.5s ease-out;
      font-weight: 700;
    }


    @media (max-width: 768px){
      .brand-logo-tall{
        height: 72px;  /* حجم مناسب للجوال */
        width: 72px;
        padding: 8px;
        border-width: 2px;
      }
    }
    @keyframes slideDown{
      from{ opacity: 0; transform: translateY(-20px); }
      to{ opacity: 1; transform: translateY(0); }
    }
    /* أدوات */
    .hidden{display:none!important}

    /* سماكات عامة للتحكّم داخل الجمل */
    .w-thin    { font-weight: 300; }  /* رفيع (عناوين فرعية/نص ثانوي) */
    .w-regular { font-weight: 400; }  /* عادي */
    .w-bold    { font-weight: 700; }  /* عريض (مهم) */

    /* تأكيد وضوح العناوين المهمة */
    .em-high   { font-weight: 700; font-size: 1.05em; letter-spacing: .1px; }
    .em-med    { font-weight: 600; }
    .em-low    { font-weight: 400; opacity: .92; }


    /* ===== تكبير واجهة الرئيسية فقط ===== */
    #homeContent { 
      font-size: 1.25rem;          /* يكبّر كل نصوص القسم */
      line-height: 1.8;
    }
    #homeContent .section-lead { margin-bottom: 12px; }

    /* عنوان الترحيب */
    #homeContent h2{
      font-size: clamp(1.9rem, 3vw, 2.4rem);
    }

    /* بطاقات الإحصائيات في الرئيسية */
    #homeContent .stat-card .stat-number{
      font-size: clamp(2rem, 3vw, 2.4rem);
    }
    #homeContent .stat-card .stat-label{
      font-size: 1.05rem;
    }

        /* فاصل رفيع تحت الشعار */
    .header-split{
      height: 1px;
      background: rgba(255,255,255,.25);
      margin: 10px 0 12px;
    }


    /* زر محايد صغير للأكشنات (الوضع الداكن) */
    .pill-btn{
      background:#111827;
      color:#fff;
      border:none;
      border-radius:8px;
      padding:8px 14px;
      font-weight:700;
      cursor:pointer;
      transition:.2s;
    }
    .pill-btn:hover{ opacity:.9 }


    /* (اختياري) صغّر الشارة قليلاً */
    .header-sub .role-badge{ flex: none; }
      

            /* الحالة الافتراضية: الوسط */
      .header .stats-bar{
        justify-content: center;
      }

      /* قبل تسجيل الدخول: تأكيد التوسيط */
      .mode-login .header .stats-bar{
        justify-content: center;
      }


            /* Divider وسطي بنص في المنتصف */
      .section-divider{
        position: relative;
        text-align: center;
        margin: 18px 0 8px;
      }
      .section-divider span{
        display:inline-block;
        background: var(--card-bg);
        padding: 4px 12px;
        font-weight: 800;
        border-radius: 999px;
        border: 2px solid var(--border);
      }
      .section-divider::before{
        content:"";
        position:absolute;
        inset-inline: 0;
        top: 50%;
        height: 2px;
        background: var(--border);
        z-index: 0;
      }
      .section-divider span{ position: relative; z-index: 1; }

      /* نص تعريفي بسيط تحت العنوان */
      .section-lead{
        text-align:center;
        color: var(--muted);
        margin: 6px auto 12px;
        max-width: 820px;
        line-height: 1.8;
      }


            /* أخفِ سطر الترحيب بعد تسجيل الدخول */
      .mode-app #homeContent h2{ display:none; }

      /* (اختياري) قلّل المسافة فوق البطاقات لما يختفي العنوان */
      .mode-app #homeContent .dashboard-stats{ margin-top: 4px; }

      /* الاسم + الشارة على سطر واحد ملاصقين */
      .header-sub .user-title{
        display: inline-flex;
        align-items: baseline;
        gap: 10px;
        justify-content: flex-end;     /* RTL: يمين */
        min-width: 0;
      }

      .header-sub .user-name{
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: clamp(1.2rem, 2.2vw, 1.5rem);
        line-height: 1.4;
        font-weight: 800;
        max-width: min(42vw, 520px);   /* لا يزاحم الإحصائيات */
      }



      /* زر الخروج يثبت في العمود الثالث (أقصى اليسار في RTL) */
      .header-sub .logout-btn{
        justify-self: start;
      }

      /* استجابة للجوال: رصّ عمودي مع توسيط الكل */
      @media (max-width:768px){
        .support-fab{
          bottom: 80px !important;  /* ✅ موضع ثابت ومرئي */
          z-index: 10050;
        }
        
        .welcome-support-tooltip{
          bottom: 85px !important;
          inset-inline-end: 85px !important;
          z-index: 10060;
        }
      }

    @media (max-width:768px){
      body{
        padding-bottom:260px;  /* ✅ الآن داخل body */
      }
      
      .container{
        margin-bottom:180px;
      }
      
      .header-bar{
        grid-template-columns: 1fr;
      }
      
      .brand-inline{ order: 1; justify-self: center; }
      .user-actions{ order: 2; justify-self: center; }
      .driver-info,.request-header{grid-template-columns:1fr}
      .brand-logo-tall{height:56px}
      .brand-text .logo { font-size: clamp(1.6rem, 2.2vw, 2.1rem); }
      .stat-number { font-size: clamp(1.4rem, 2vw, 1.8rem); }
      .brand-text .tagline{display:none}
      .tabs{flex-direction:column}
    }


    /* ====== Mobile-friendly patch ====== */

      /* ارتفاعات قياسية قابلة للتبديل */
      @media (max-width: 768px){
        :root{
          --footer-h: 50px;
          --statsbar-h: 120px; /* أطول لأنه عمودي الآن */
        }
      }

      /* خط سائل للجوال: أصغر على الشاشات الصغيرة، لا يتجاوز 18px على الكبيرة */
      html{ font-size: clamp(14px, 2.4vw, 18px); }

      /* اعتمد على 100dvh بدلاً من 100vh (يعالج شريط العنوان في iOS) */
      body{
        min-height: 100dvh;
        /* بدلاً من padding-bottom الثابت الكبير:
          احجز مساحة آمنة تحت لعدم تغطية العناصر الثابتة + النوتش */
        padding-bottom: calc(
          var(--footer-h) + var(--statsbar-h)
          + env(safe-area-inset-bottom, 0px) + 14px
        ) !important;
      }

      /* لا تقطع العناصر الطولية داخل الحاوية على الجوال */
      .container{
        margin: 0 auto calc(var(--statsbar-h) + 12px) auto;
        overflow: visible; /* كان hidden ويسبب قصّ عناصر منبثقة/قوائم */
      }

      /* ثبّت ارتفاع الفوتر، وأضف مساحة آمنة للنوتش */
      .site-footer{
        height: var(--footer-h);
        padding-block: 8px;
        padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
      }

      /* ارفع شريط الإحصائيات فوق الفوتر */
      .stats-bottom-bar{
        bottom: calc(var(--footer-h) + env(safe-area-inset-bottom, 0px) + 6px);
      }

      /* ارفع زر الدعم وشارة الحالة فوق كل شيء بأسفل الشاشة */
      .support-fab{
        bottom: 20px;
      }

      .status-badge{
        bottom: 20px;
      }

      /* حقول الإدخال على iOS >= 16px لتفادي التكبير التلقائي */
      .form-control{
        font-size: 16px;
        min-height: 44px; /* هدف لمس مريح */
      }

      /* أزرار التبويبات أصغر قليلًا على الشاشات الصغيرة */
      .tabs .tab{
        font-size: clamp(14px, 3.6vw, 16px);
        padding: 12px 10px;
      }

      /* العناوين الكبيرة تصير مرنة بدل الثابت */
      #homeContent h2,
      .brand-text .logo{
        font-size: clamp(1.3rem, 4.5vw, 2rem);
      }

      /* منع تداخل الـ tooltip مع الحواف على الجوال الضيق */
      .welcome-support-tooltip{
        max-width: min(80vw, 280px);
      }

      /* صور وشعارات تتكيّف دائمًا */
      img{ max-width: 100%; height: auto; }

    .tabs .tab[data-tab="housing"]{ display:none !important; }

       /*إصلاح العرض الأفقي الزائد (Horizontal Scroll)*/
        html, body{
          overflow-x: hidden;
          max-width: 100vw;
        }

        * {
          max-width: 100%;
        }

          /* شريط الإحصائيات السفلي */


      .dark .stats-bottom-bar{
        background: rgba(17, 24, 39, 0.85);
        border-top-color: rgba(255, 255, 255, 0.05);
      }

      .stat-glass-card{
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 12px;
        padding: 8px 14px;
        transition: all 0.3s ease;
      }

      .stat-glass-card:hover{
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      }

      .stat-icon{
        font-size: 1.8rem;
        line-height: 1;
      }

      .stat-content{
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .stat-glass-card .stat-number{
        font-size: 1.1rem;
        font-weight: 800;
        color: #fff;
        line-height: 1.2;
      }

      .stat-glass-card .stat-label{
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.75);
        line-height: 1;
      }

      /* استجابة للجوال */
      @media (max-width: 768px){
        .stats-bottom-bar{
          flex-direction: column;  /* رص عمودي */
          padding: 12px;
          gap: 8px;
          margin-top: 16px;
        }
        
        .stat-glass-card{
          width: 100%;  /* عرض كامل */
          padding: 10px 12px;
        }
        
        .stat-icon{
          font-size: 1.6rem;
        }
        
        .stat-glass-card .stat-number{
          font-size: 1.1rem;
        }
        
        .stat-glass-card .stat-label{
          font-size: 0.8rem;
        }
        
        .site-footer{
          padding: 14px 10px;
        }
        
        body{
          padding-bottom: 20px;
        }
      }
           

      /* إخفاء الشريط قبل تسجيل الدخول */
      html:not(.app-ready) .stats-bottom-bar{
        display: none !important;
      }


          /* شارة حالة أنيقة */
    .status-badge{
      position: fixed;
      bottom: 20px;
      inset-inline-start: 20px;
      z-index: 10000;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 10px 16px;
      border-radius: 999px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      font-size: 0.85rem;
      font-weight: 700;
      color: #1f2937;
      transition: all 0.3s ease;
    }

    .dark .status-badge{
      background: rgba(17, 24, 39, 0.95);
      color: #e5e7eb;
    }

    .status-dot{
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: statusPulse 2s ease-in-out infinite;
    }

    @keyframes statusPulse{
      0%, 100%{ opacity: 1; transform: scale(1); }
      50%{ opacity: 0.6; transform: scale(1.2); }
    }

    .status-dot.online{
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
    }

    .status-dot.offline{
      background: #ef4444;
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
    }

    .status-dot.loading{
      background: #f59e0b;
      box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
    }

    .status-badge.hidden{
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
    }

    @media (max-width: 768px){
      .status-badge{
        bottom: 150px;
        inset-inline-start: 10px;
        font-size: 0.75rem;
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>

  <!-- شاشة تعريف بالمبادرة (Overlay) -->
  <section id="intro-screen" class="intro-screen">
    <div class="intro-content">
      <img src="assets/intro-hero.jpg" alt="تعريف بالمبادرة" class="intro-hero" loading="eager" decoding="async" fetchpriority="high">
      <button id="startBtn" class="intro-start">متابعة الدخول</button>
      <div id="introLoader" class="intro-loader" aria-hidden="true">جاري التحميل...</div>
    </div>
  </section>

  <!-- إطار الصفحة -->
  <div class="container">
    
      <!-- ضع الهيدر هنا -->
      <header class="header">
        <div class="header-bar">
          <div class="brand-inline">
            <div class="brand-stack">
              <img src="assets/logo-college.png" alt="شعار المؤسسة" class="brand-logo-tall">
              <div class="brand-text">
                <div class="logo">مبادرة ساند للمتدربين</div>
              </div>
            </div>
          </div>

          <div class="user-actions">
            <a id="goDashboardBtn" href="dashboard.html" class="btn btn-secondary">لوحة الإحصائيات</a>
            <button class="pill-btn" id="themeToggleBtn" type="button" style="background:#111827">الوضع الداكن</button>
          </div>
        </div>

        <div class="header-split"></div>

        <!-- سطر موحّد: اسم + شارة | الإحصائيات | تسجيل خروج -->
        <div class="header-sub"> 
          <div class="user-title" id="topUserInfo" style="display:none">
            <span class="user-name" id="userName" aria-live="polite">...</span>
            <span class="role-badge" id="userRole">متدرب</span>
          </div>
          <button class="logout-btn" id="logoutBtn" type="button">تسجيل الخروج</button>
        </div>
      </header>

    <!-- قسم الدخول -->
    <section class="login-section" id="loginSection">
      <div class="login-container">
        <div class="welcome-message">مرحباً بك في مبادرة ساند للمتدربين</div>
          <form class="login-form active" id="loginForm" aria-hidden="false" onsubmit="return false;">

            <!-- ساند للمواصلات (أولاً) -->
            <!-- بطاقة: ساند للمواصلات -->
              <div class="card" style="margin-bottom:16px">
                <span class="section-pill">ساند للمواصلات</span>
                <p class="section-lead" style="margin-top:10px">
                  ساند للمواصلات مبادرة تطوعية تربط المتدربين بالسائقين داخل المحافظة
                  لتنسيق الرحلات اليومية بسرعة وأمان وبأقل مجهود.
                </p>

                <div class="form-group" style="margin-top:12px">
                  <label for="loginTraineeId">رقم المتدرب</label>
                  <input type="text" id="loginTraineeId" class="form-control" placeholder="مثال: 4461XXXX" required>
                  <small id="loginIdHint" class="field-hint neutral" style="display:none"></small>
                </div>

                <div class="alert alert-info">
                  <strong>ملاحظة:</strong> سيتم التحقق من رقمك في قائمة المتدربين.
                  إذا لم تكن موجودًا في القائمة، فلن يُسمح بالتسجيل ويُرجى التواصل مع المنشأة التدريبية.
                </div>

                <button class="btn btn-primary" id="loginBtn" type="button">دخول إلى ساند المواصلات</button>
              </div>

              <!-- بطاقة: ساند للسكن -->
              <div class="card">
                <span class="section-pill">ساند للسكن</span>
                <p class="section-lead" style="margin-top:10px">
                  يوفّر “ساند للسكن” قائمة مُحدّثة بأرقام ملاك الشقق والغرف في المحافظة،
                  لتسهيل تواصل المتدربين مع المالكين مباشرةً بدون وسطاء. تأكّد من مطابقة التفاصيل قبل الاتفاق.
                </p>
                <div style="text-align:center">
                 <button class="btn btn-outline" id="openHousingBtn" type="button">🏨 الدخول إلى ساند السكن</button>
                </div>
                </div>
          </form>
      </div>
    </section>

    <!-- تبويبات التطبيق -->
    <nav class="tabs" id="tabsContainer" role="tablist" aria-label="التنقل في ساند">
      <button class="tab active" data-tab="home" type="button">🏠 الرئيسية</button>
      <button class="tab badged" data-tab="requests" id="requestsTab" type="button">📋 طلباتي <span class="badge" id="requestsBadge" style="display:none">0</span></button>
      <button class="tab" data-tab="drivers" type="button">🚗 السائقين</button>
      <button class="tab" data-tab="book" type="button">➕ حجز جديد</button>
      <button class="tab" data-tab="rate" type="button">⭐ تقييم</button>
      <button class="tab" data-tab="register" type="button">👥 تسجيل جديد</button>
    </nav>

    <!-- صفحات المحتوى -->

    <!-- الرئيسية -->
      <section class="content active" id="homeContent">
        <h2>مرحباً <span id="homeUserName">...</span> 👋</h2>

        <div class="welcome-banner" id="welcomeBanner">
          مرحباً بك في مبادرة ساند - نحن هنا لخدمتك 🌟
        </div>

        <div class="section-divider"><span>ساند المواصلات</span></div>
        <p class="section-lead" style="margin-bottom:12px">
          ساند المواصلات مبادرة تطوعية لربط المتدربين بالسائقين المتطوعين داخل المحافظة،
          وتنسيق الرحلات اليومية بشكل آمن وسريع وبأقل مجهود.
        </p>

        <div class="dashboard-stats">
          <div class="stat-card"><div class="stat-number" id="myTripsCount">-</div><div class="stat-label">رحلاتي المكتملة</div></div>
          <div class="stat-card"><div class="stat-number" id="myRating">-</div><div class="stat-label">تقييمي</div></div>
          <div class="stat-card"><div class="stat-number" id="myActiveRequests">-</div><div class="stat-label">طلبات نشطة</div></div>
          <div class="stat-card"><div class="stat-number" id="communitySize">-</div><div class="stat-label">أعضاء المجتمع</div></div>
        </div>
        <div style="text-align:center; margin-top:16px;">
        <button class="btn btn-secondary" id="refreshHomeStats" type="button">
          🔄 تحديث الإحصائيات
        </button>
      </div>
      </section>


    <!-- طلباتي -->
    <section class="content" id="requestsContent">
      <h2 id="requestsTitle">طلباتي</h2><br>
      <button class="btn" id="refreshRequestsBtn" type="button">🔄 تحديث الطلبات</button>
      <br><br>
      <div id="userRequestsList">
        <div class="loading"><div class="spinner"></div><p>جاري تحميل الطلبات...</p></div>
      </div>
    </section>

    <!-- السائقون -->
    <section class="content" id="driversContent">
      <h2>السائقين المتاحين <span id="availableDriversCount" style="font-size:.9rem;opacity:.85"></span></h2>

      <div class="form-group">
        <label for="searchDriver">بحث بالاسم أو رقم المتدرب</label>
        <input id="searchDriver" class="form-control" type="text" placeholder="مثال: أحمد أو D001">
      </div>

      <div class="form-group">
        <label for="filterNeighborhood">فلترة حسب الحي</label>
        <select id="filterNeighborhood" class="form-control">
          <option value="">جميع الأحياء</option>
          <option value="اليرموك">اليرموك</option>
          <option value="الظهرة">الظهرة</option>
          <option value="الحقل">الحقل</option>
          <option value="السيخة">السيخة</option>
          <option value="السبخة">السبخة</option>
        </select>
      </div>

      <button class="btn" id="refreshDriversBtn" type="button">🔄 تحديث قائمة السائقين</button>
      <br><br>
      <div id="driversList">
        <div class="loading"><div class="spinner"></div><p>جاري تحميل البيانات...</p></div>
      </div>
    </section>

    <!-- حجز جديد -->
    <section class="content" id="bookContent">
      <h2>حجز توصيل جديد</h2><br>
      <div class="alert alert-info"><strong>تعليمات:</strong> بعد اختيار السائق والأيام المطلوبة، سيتم إرسال رسالة واتساب تلقائية للسائق وحفظ الطلب.</div>

      <form id="bookingForm">
        <div class="form-group">
          <label for="selectedDriver">السائق المختار</label>
          <select id="selectedDriver" class="form-control" required><option value="">اختر السائق</option></select>
        </div>

        <div class="form-group">
          <label>الأيام المطلوبة</label>
          <div class="checkbox-group" id="daysGroup"></div>
        </div>

        <div class="form-group">
          <label for="duration">مدة الحجز (بالأسابيع)</label>
          <select id="duration" class="form-control" required>
            <option value="">اختر المدة</option>
            <option value="1">أسبوع واحد</option>
            <option value="2">أسبوعين</option>
            <option value="3">3 أسابيع</option>
            <option value="4">شهر كامل</option>
          </select>
        </div>

        <div class="form-group">
          <label for="tripNotes">ملاحظات إضافية (اختياري)</label>
          <textarea id="tripNotes" class="form-control" rows="3" placeholder="مثال: أحتاج التوصيل صباحاً 7:30"></textarea>
        </div>

        <button type="submit" class="btn" id="bookingBtn">إرسال طلب التوصيل</button>
      </form>
    </section>

    <!-- التقييم -->
    <section class="content" id="rateContent">
      <h2 id="rateTitle">تقييم السائق</h2><br>
      <form id="ratingForm">
        <div class="form-group">
          <label for="ratedDriver" id="rateSelectLabel">السائق</label>
          <select id="ratedDriver" class="form-control" required><option value="">اختر</option></select>
        </div>

        <div class="form-group">
          <label for="ratingStars">التقييم</label>
          <select id="ratingStars" class="form-control" required>
            <option value="">اختر التقييم</option>
            <option value="5">⭐⭐⭐⭐⭐ ممتاز</option>
            <option value="4">⭐⭐⭐⭐ جيد جداً</option>
            <option value="3">⭐⭐⭐ جيد</option>
            <option value="2">⭐⭐ مقبول</option>
            <option value="1">⭐ يحتاج تحسين</option>
          </select>
        </div>

        <div class="form-group">
          <label for="ratingNotes">ملاحظات إضافية</label>
          <textarea id="ratingNotes" class="form-control" rows="4" placeholder="اكتب ملاحظاتك هنا..."></textarea>
        </div>

        <button type="submit" class="btn" id="ratingBtn">إرسال التقييم</button>
      </form>
    </section>

    <!-- التسجيل -->
    <section class="content" id="registerContent">
      <h2>تسجيل مستخدم جديد</h2><br>
      <div class="alert alert-info"><strong>ملاحظة:</strong> يمكن للمتدربين تسجيل أنفسهم كسائقين متطوعين أو كمحتاجين للتوصيل.</div>

      <div id="backToLoginWrap" class="back-to-selection" style="display:none;margin-bottom:10px">
        <button type="button" class="btn btn-secondary" id="backToLoginBtn">⬅️ رجوع لشاشة الدخول</button>
      </div>

      <form id="registrationForm">
        <div class="form-group"><label for="name">الاسم الكامل</label><input type="text" id="name" class="form-control" required></div>
        <div class="form-group"><label for="traineeId">رقم المتدرب</label><input type="text" id="traineeId" class="form-control" required></div>
        <small id="regIdHint" class="field-hint neutral"></small>
        <div class="form-group"><label for="phone">رقم الجوال (مع كود الدولة)</label><input type="tel" id="phone" class="form-control" placeholder="9665XXXXXXXX" required></div>

        <div class="form-group">
          <label for="neighborhood">الحي</label>
          <select id="neighborhood" class="form-control" required>
            <option value="">اختر الحي</option>
            <option value="اليرموك">اليرموك</option>
            <option value="الظهرة">الظهرة</option>
            <option value="الحقل">الحقل</option>
            <option value="السيخة">السيخة</option>
            <option value="السبخة">السبخة</option>
          </select>
        </div>

        <div class="form-group">
          <label for="userType">نوع المستخدم</label>
          <select id="userType" class="form-control" required>
            <option value="">اختر نوع المستخدم</option>
            <option value="سائق">سائق متطوع</option>
            <option value="متدرب">محتاج لتوصيل</option>
          </select>
        </div>

        <button type="submit" class="btn" id="registerBtn">تسجيل في ساند</button>
      </form>
 
    </section>
               <!-- شريط الإحصائيات الثابت -->
    <div class="stats-bottom-bar" id="statsBottomBar" aria-live="polite">
      <div class="stat-glass-card">
        <div class="stat-icon">👥</div>
        <div class="stat-content">
          <div class="stat-number" id="totalUsersBottom">-</div>
          <div class="stat-label">مستخدم نشط</div>
        </div>
      </div>
      
      <div class="stat-glass-card">
        <div class="stat-icon">🚗</div>
        <div class="stat-content">
          <div class="stat-number" id="totalTripsBottom">-</div>
          <div class="stat-label">رحلة مكتملة</div>
        </div>
      </div>
      
      <div class="stat-glass-card">
        <div class="stat-icon">⭐</div>
        <div class="stat-content">
          <div class="stat-number" id="satisfactionBottom">-</div>
          <div class="stat-label">تقييم الخدمة</div>
        </div>
      </div>
    </div>
  </div><!-- /container -->



    <!-- شارة حالة النظام -->
    <div class="status-badge" id="statusBadge">
      <span class="status-dot" id="statusDot"></span>
      <span class="status-text" id="statusText">جاري التحميل...</span>
    </div>

  <!-- زر دعم عائم + توست -->
  <div class="support-fab" id="supportFab" aria-label="الدعم الفني">
      <!-- تلميح ترحيبي جديد -->
      <div class="welcome-support-tooltip" id="welcomeSupportTip">
        <div class="tooltip-arrow"></div>
        <div class="tooltip-content">
          <div class="tooltip-icon">💬</div>
          <div class="tooltip-text">
            <strong>محتاج مساعدة؟</strong>
            <span>تواصل معنا مباشرة</span>
          </div>
        </div>
      </div>
          <div class="support-menu" aria-hidden="true">
            <a class="wa" target="_blank" rel="noopener" href="https://wa.me/966144510265?text=%D9%85%D8%B1%D8%AD%D8%A8%D8%A7%D8%8C%20%D8%A3%D9%86%D8%A7%20%D9%85%D9%86%20%D9%85%D9%86%D8%B5%D8%A9%20%D8%B3%D8%A7%D9%86%D8%AF%20%D9%84%D9%84%D9%85%D8%AA%D8%AF%D8%B1%D8%A8%D9%8A%D9%86%20%D9%88%D8%A3%D8%AD%D8%AA%D8%A7%D8%AC%20%D9%85%D8%B3%D8%A7%D8%B9%D8%AF%D8%A9%20%D9%81%D9%8A%3A%20">
              <span class="ico">💬</span><span>واتساب</span>
            </a>
            <a class="mail" href="mailto:a.alotaibi9@tvtc.gov.sa?subject=%D8%AF%D8%B9%D9%85%20%D9%81%D9%86%D9%8A%20-%20%D9%85%D9%86%D8%B5%D8%A9%20%D8%B3%D8%A7%D9%86%D8%AF&body=%D9%85%D8%B1%D8%AD%D8%A8%D8%A7%D8%8C%0A%0A%D8%A3%D9%86%D8%A7%20%D9%85%D9%86%20%D9%85%D9%86%D8%B5%D8%A9%20%D8%B3%D8%A7%D9%86%D8%AF%20%D9%84%D9%84%D9%85%D8%AA%D8%AF%D8%B1%D8%A8%D9%8A%D9%86%20%D9%88%D8%A3%D8%AD%D8%AA%D8%A7%D8%AC%20%D9%85%D8%B3%D8%A7%D8%B9%D8%AF%D8%A9%20%D9%81%D9%8A%3A%0A%0A%5B%D8%A7%D8%B0%D9%83%D8%B1%20%D9%85%D8%B4%D9%83%D9%84%D8%AA%D9%83%20%D9%87%D9%86%D8%A7%5D%0A%0A%D8%B4%D9%83%D8%B1%D8%A7%D9%8B">
              <span class="ico">✉️</span><span>البريد</span>
            </a>
          </div>
    <button class="main" type="button" title="الدعم">👤</button>
  </div>

  <div id="toastWrap" role="region" aria-live="polite" aria-atomic="true" style="position:fixed;inset-inline-start:20px;bottom:90px;z-index:10050;display:flex;flex-direction:column;gap:10px"></div>



    <footer class="site-footer">
      <div class="footer-content">
        <div class="footer-logo">
          <span class="footer-icon">🏛️</span>
          <div class="footer-text">
            <strong>مبادرة من</strong>
            <span>وحدة الخدمات الإرشادية وتطوير وكالة ضبط الجودة</span>
          </div>
        </div>
        <div class="footer-institute">
          <span class="institute-badge">الكلية التقنية بحقل</span>
          <span class="version">النسخة 1.0</span>
        </div>
      </div>
    </footer>

  <!-- سكربت التطبيق -->
  <script>
    
    // ===== إعدادات عامة (من config.json) =====
    let GOOGLE_SCRIPT_URL = ''; // سيتم ملؤه من config.json
    let API_KEY = '';
    let CFG = null;

    // حالة عامة
    let requestsAutoTimer = null;
    let allowSelfRegister = false;
    let lastVerifiedTrainee = null;
    let lastQuickDriverId = null;

    let DAYS = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس']; // افتراضي

    let drivers = [];
    let currentUser = null;
    let approvedPartners = [];
    let activeDriverLocks = []; // [{driverTraineeId, fromISO, toISO}]


    // القيم: 'login' | 'register_only' | 'app'
    let appMode = 'login';
    function isValidUserType(t){ return t === 'سائق' || t === 'متدرب'; }

    function setAppMode(mode){
      appMode = mode;

      // تبديل كلاسات عامة على <body>
      document.body.classList.remove('mode-login','mode-register','mode-app');
      if(mode === 'login')         document.body.classList.add('mode-login');
      if(mode === 'register_only') document.body.classList.add('mode-register');
      if(mode === 'app')           document.body.classList.add('mode-app');

      // مراجع عناصر الواجهة
      const logoutBtn    = document.getElementById('logoutBtn');
      const tabs         = document.getElementById('tabsContainer');
      const topUserInfo  = document.getElementById('topUserInfo');
      const loginSection = document.getElementById('loginSection');
      const allContents  = Array.from(document.querySelectorAll('.content'));
      const reg          = document.getElementById('registerContent');
      const backWrap     = document.getElementById('backToLoginWrap');

      // إخفاء تبويب التسجيل دائمًا من واجهة التطبيق الرئيسية
      document.querySelector('.tab[data-tab="register"]')?.style.setProperty('display','none');

      // دوال مساعدة محلية
      const hideAllContents = ()=>{
        allContents.forEach(c=>{
          c.classList.remove('active');
          c.setAttribute('hidden','');
          c.setAttribute('aria-hidden','true');
          c.setAttribute('inert','');
        });
      };
      const showOnly = (el)=>{
        el.classList.add('active');
        el.removeAttribute('hidden');
        el.setAttribute('aria-hidden','false');
        el.removeAttribute('inert');
      };

      if(mode==='login'){
        if (logoutBtn) logoutBtn.style.display = 'none';
        loginSection.style.display='block';
        tabs.classList.remove('active');
        topUserInfo.style.display='none';
        hideAllContents();
        backWrap.style.display='none';
      }

      if(mode==='register_only'){
        if (logoutBtn) logoutBtn.style.display = 'none';
        loginSection.style.display='none';
        tabs.classList.remove('active');
        topUserInfo.style.display='none';
        hideAllContents(); 
        showOnly(reg);
        backWrap.style.display='block';
      }

      if(mode==='app'){
        if (logoutBtn) logoutBtn.style.display = 'inline-block';
        loginSection.style.display='none';

        // إخفاء بانر الترحيب لاحقًا
        setTimeout(() => {
          const banner = document.getElementById('welcomeBanner');
          if(banner) banner.style.display = 'none';
        }, 5000);

        tabs.classList.add('active');
        hideAllContents(); 
        showOnly(document.getElementById('homeContent'));
        setIsHome(true);
        topUserInfo.style.display='inline-flex';

        // فكّ إلغاء تفعيل بقية الأقسام
        allContents.forEach(c=>{
          c.removeAttribute('hidden'); 
          c.removeAttribute('inert');
          c.setAttribute('aria-hidden', c.classList.contains('active') ? 'false' : 'true');
        });
        backWrap.style.display='none';

        // 🔒 قياس نوع المستخدم
        const isDriver = !!currentUser && String(currentUser.userType).trim() === 'سائق';

        // 🔒 إخفاء تبويب "حجز جديد" إذا كان المستخدم سائق
        const bookTab  = document.querySelector('.tab[data-tab="book"]');
        if (bookTab) bookTab.style.display = isDriver ? 'none' : 'inline-block';

        // 🔒 إخفاء تبويب "السائقين" إذا كان المستخدم سائق
        const driversTab = document.querySelector('.tab[data-tab="drivers"]');
        if (driversTab) driversTab.style.display = isDriver ? 'none' : 'inline-block';

        // (اختياري) تأمين محتوى صفحة السائقين نفسها
        const driversContent = document.getElementById('driversContent');
        if (driversContent) {
          if (isDriver) {
            driversContent.setAttribute('hidden', '');
            driversContent.setAttribute('aria-hidden', 'true');
            driversContent.setAttribute('inert', '');
          } else {
            driversContent.removeAttribute('hidden');
            driversContent.setAttribute('aria-hidden', driversContent.classList.contains('active') ? 'false' : 'true');
            driversContent.removeAttribute('inert');
          }
        }
      }
    }


    function guardNavigation(ev){
      if(appMode!=='app'){
        ev.preventDefault();
        showToast('أكمل التسجيل أولاً.','warn');
        return true;
      }
      return false;
    }

    // ===== Utils =====

    // احسب بداية الأحد القادم (أو هذا الأحد إذا اليوم أحد)
    function getUpcomingSundayStart(d = new Date()){
      const dt = new Date(d);
      const day = dt.getDay(); // 0=الأحد في بيئة KSA لو المتصفح على Asia/Riyadh؛ JS القياسي: 0=الأحد
      const diff = (day === 0) ? 0 : (7 - day); // إلى الأحد القادم
      dt.setHours(0,0,0,0);
      dt.setDate(dt.getDate() + diff);
      return dt;
    }

    // احسب نهاية السبت لنهاية المدة (duration أسابيع)
    function calcLockWindow(durationWeeks = 1, base = new Date()){
      const start = getUpcomingSundayStart(base);              // الأحد 00:00
      const end   = new Date(start);                           // نسخة
      end.setDate(end.getDate() + (durationWeeks * 7) - 1);    // السبت
      end.setHours(23,59,59,999);
      return { start, end };
    }


    function sanitizeStr(s){ return String(s||'').replace(/[\u200E\u200F\u202A-\u202E]/g,'').trim(); }
    function normalizeDigits(s=''){
      const map={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
      return String(s).replace(/[٠-٩۰-۹]/g, ch => map[ch] || ch);
    }
    function normalizePhoneKSA(raw=''){
      const s = normalizeDigits(String(raw)).replace(/\s+/g,'').replace(/[^\d+]/g,'');
      if(!s) return '';
      if(/^(\+)?9665\d{8}$/.test(s)) return s.replace(/^\+/, '');
      if(/^05\d{8}$/.test(s))        return '966' + s.slice(1);
      if(/^5\d{8}$/.test(s))         return '966' + s;
      if(/^009665\d{8}$/.test(s))    return s.replace(/^00/, '');
      return '';
    }
    function isValidPhoneKSA(v){ return /^9665\d{8}$/.test(normalizePhoneKSA(v)); }
    function buildWaUrl(phone, text=''){
      const p = normalizePhoneKSA(phone);
      if(!p) return '';
      const q = text ? ('?text=' + encodeURIComponent(text)) : '';
      return `https://wa.me/${p}${q}`;
    }
    function getWaPhoneFromRecord(rec={}){
      const candidates = [rec.phone,rec.whatsapp,rec.mobile,rec.passengerPhone,rec.driverPhone].filter(Boolean);
      for(const c of candidates){
        const n = normalizePhoneKSA(c);
        if(n) return n;
      }
      return '';
    }
    function showToast(msg,type='info',timeout=3500){
      const wrap = document.getElementById('toastWrap'); if(!wrap) return;
      const d = document.createElement('div');
      const palette = {
        info:{bg:'#cce7ff',bd:'#99d6ff',tx:'#0c5460'},
        success:{bg:'#d4edda',bd:'#c3e6cb',tx:'#155724'},
        warn:{bg:'#fff3cd',bd:'#ffeaa7',tx:'#856404'},
        error:{bg:'#f8d7da',bd:'#f5c2c7',tx:'#721c24'}
      }[type] || {bg:'#cce7ff',bd:'#99d6ff',tx:'#0c5460'};
      d.style.cssText = `padding:12px 14px;border-radius:10px;border:1px solid ${palette.bd};background:${palette.bg};color:${palette.tx};min-width:220px;box-shadow:0 10px 20px rgba(0,0,0,.08);font-weight:700`;
      d.textContent = msg;
      wrap.appendChild(d);
      setTimeout(()=>{ d.style.opacity='0'; d.style.transform='translateY(6px)'; }, timeout);
      setTimeout(()=>{ d.remove(); }, timeout+300);
    }

    // ===== حالة الاتصال =====

    function setConnStatus(state){
      const badge = document.getElementById('statusBadge');
      const dot = document.getElementById('statusDot');
      const txt = document.getElementById('statusText');
      
      if(!badge || !dot || !txt) return;
      
      dot.classList.remove('online','offline','loading');
      
      if(state === 'online'){
        dot.classList.add('online');
        txt.textContent = 'النظام جاهز';
        setTimeout(() => badge.classList.add('hidden'), 2000);
      } else if(state === 'offline'){
        dot.classList.add('offline');
        txt.textContent = 'خطأ في الاتصال';
        badge.classList.remove('hidden');
      } else {
        dot.classList.add('loading');
        txt.textContent = 'جاري التحميل...';
        badge.classList.remove('hidden');
      }
    }

    // ===== تخزين مؤقت =====
    const CACHE_TTL = { getTopStats:60000, getDrivers:60000, getUserStats:45000, getPassengerRequests:30000, getDriverRequests:30000 };
    const memCache = new Map();      // actionKey -> {ts,data}
    const inflight = new Map();      // actionKey -> Promise

    function stableStringify(obj){
      if (obj === null || typeof obj !== 'object') return String(obj);
      if (Array.isArray(obj)) return '[' + obj.map(stableStringify).join(',') + ']';
      const keys = Object.keys(obj).sort();
      return '{' + keys.map(k => JSON.stringify(k) + ':' + stableStringify(obj[k])).join(',') + '}';
    }
    function buildCacheKey(action,data){ return String(action||'') + ':' + stableStringify(data||{}); }
    function lcGet(key){ try{ return JSON.parse(localStorage.getItem(key) || 'null'); }catch{return null} }
    function lcSet(key,val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch{} }
    function isFresh(ts,ttl){ return (Date.now()-ts) < ttl; }

    async function fetchWithCache(action, data={}, {ttl=30000, staleOK=true} = {}){
      const cacheKey = buildCacheKey(action,data);
      const lsKey = 'sand_cache_' + cacheKey;

      const m = memCache.get(cacheKey);
      if(m && isFresh(m.ts, ttl)) return {from:'mem', data:m.data};

      const lc = lcGet(lsKey);
      if(lc && staleOK){
        backgroundRefresh(action,data,ttl);
        return {from:'local', data:lc.data, stale:!isFresh(lc.ts,ttl)};
      }

      if(inflight.has(cacheKey)) return inflight.get(cacheKey);

      const p = (async ()=>{
        const res = await sendToGoogleSheets(action,data);
        const payload = res?.data ?? null;
        const entry = {ts:Date.now(), data:payload};
        memCache.set(cacheKey, entry);
        lcSet(lsKey, entry);
        return {from:'net', data:payload};
      })().finally(()=> inflight.delete(cacheKey));

      inflight.set(cacheKey,p);
      return p;
    }

    function backgroundRefresh(action,data,ttl){
      fetchWithCache(action,data,{ttl,staleOK:false}).catch(()=>{});
    }

    async function sendToGoogleSheets(action,data){
      let connectingTimer = setTimeout(()=> setConnStatus('connecting'), 600);
      const controller = new AbortController();
      const t = setTimeout(()=> controller.abort(), 20000);

      try{
        if(!GOOGLE_SCRIPT_URL){ clearTimeout(connectingTimer); setConnStatus('offline'); throw new Error('GOOGLE_SCRIPT_URL is empty'); }

        const resp = await fetch(GOOGLE_SCRIPT_URL,{
          method:'POST',
          headers:{'Content-Type':'text/plain;charset=utf-8'},
          body:JSON.stringify({action,data, ...(API_KEY? {key:API_KEY}:{}) }),
          signal:controller.signal,
          mode:'cors',credentials:'omit',cache:'no-store',redirect:'follow',referrerPolicy:'no-referrer'
        });

        clearTimeout(connectingTimer); clearTimeout(t);
        if(!resp.ok){ setConnStatus('offline'); throw new Error('HTTP ' + resp.status); }
        const json = await resp.json().catch(()=>{ throw new Error('INVALID_JSON'); });

        setConnStatus('online');
        return json;
      }catch(err){
        clearTimeout(connectingTimer); clearTimeout(t);
        setConnStatus('offline');
        console.error('[GS Error]', err);
        throw new Error( err.name==='AbortError' ? 'TIMEOUT_20S' : (err.message==='INVALID_JSON' ? 'INVALID_JSON' : ('NET_'+(err.message||'ERR'))) );
      }
    }

    async function heartbeat(){
      try{
        const r = await fetchWithCache('getTopStats', {}, {ttl:CACHE_TTL.getTopStats});
        updateTopStats(r?.data);
      }catch{}
    }

    // ===== عناصر مساعدة سريعة =====
    function $(sel){ return document.querySelector(sel); }
    function $$(sel){ return Array.from(document.querySelectorAll(sel)); }

    // ===== تلميحات رقم المتدرب =====
    function hintTraineeIdState(value){
      const v = String(value||'').trim();
      if(!v){ return {cls:'neutral', msg:''}; }
      if(/^\d{6,}$/.test(v)){ return {cls:'good', msg:'✅ الصيغة رقمية تبدو صحيحة'}; }
      return {cls:'warn', msg:'⚠️ يرجى إدخال أرقام فقط'};
    }
    function setupTraineeIdHints(){
      const loginInput = document.getElementById('loginTraineeId');
      const loginHint  = document.getElementById('loginIdHint');
      const regInput   = document.getElementById('traineeId');
      const regHint    = document.getElementById('regIdHint');

      function bindHint(input, hintEl){
        if(!input || !hintEl) return;
        input.addEventListener('input', ()=>{
          const {cls, msg} = hintTraineeIdState(input.value);
          hintEl.classList.remove('neutral','good','warn');
          hintEl.classList.add(cls);
          hintEl.textContent = msg;
          hintEl.style.display = msg ? 'inline' : 'none';
        });
      }
      bindHint(loginInput, loginHint);
      bindHint(regInput, regHint);
    }

    // ===== تحديث أرقام العنوان =====
      function updateTopStats(data){
        try{
          const u = document.getElementById('totalUsersBottom');
          const t = document.getElementById('totalTripsBottom');
          const s = document.getElementById('satisfactionBottom');

          if(u) u.textContent = data?.totalUsers ?? '-';
          if(t) t.textContent = data?.totalTrips ?? '-';

          if(s){
            const v = data?.satisfaction;
            if (v == null || v === '-') { s.textContent = '-'; }
            else if (typeof v === 'string' && v.trim().endsWith('%')) { s.textContent = v; }
            else if (!isNaN(Number(v))) { s.textContent = `${Number(v)}`.replace(/\.0+$/,'') + '%'; }
            else { s.textContent = String(v); }
          }
        }catch{}
      }
      function setIsHome(active){
        document.body.classList.toggle('is-home', !!active);
      }


    // ===== واجهة المستخدم: تبويبات =====
    function switchTab(name){
      // منع التنقل إن لم يكمل الدخول
      if(guardNavigation(new Event('nav'))) return;

      // 🔒 منع السائق من فتح تبويب "حجز جديد"
      if (name === 'book' && currentUser && String(currentUser.userType).trim() === 'سائق') {
        showToast('الحجز متاح للركاب فقط', 'warn');
        return;
      }

      // 🔒 منع السائق من فتح تبويب "السائقين"
      if (name === 'drivers' && currentUser && String(currentUser.userType).trim() === 'سائق') {
        showToast('هذه الصفحة مخصصة للركاب فقط', 'warn');
        return;
      }

      // تفعيل التبويب المطلوب وإخفاء البقية
      $$('.tab').forEach(b=> b.classList.toggle('active', b.dataset.tab===name));
      $$('.content').forEach(sec=>{
        const active = (sec.id === (name+'Content'));
        sec.classList.toggle('active', active);
        sec.setAttribute('aria-hidden', active ? 'false' : 'true');
      });

      // تحميل المحتوى الخاص بكل تبويب عند فتحه
      if(name==='drivers')   loadDrivers();
      if(name==='requests')  loadRequests();
      if(name==='home')      loadMyStats();
      if(name==='book')      prepareBookingUI();
      if(name==='rate')      prepareRatingUI?.();

      setIsHome(name === 'home');
    }

    async function fetchActiveLocks(){
      const {data} = await fetchWithCache('getActiveDriverLocks', {}, {ttl: 30000});
      // نتوقع مصفوفة عناصر فيها: driverTraineeId, fromISO, toISO
      activeDriverLocks = Array.isArray(data) ? data : [];
    }

    // helper: هل السائق مقفول الآن؟
    function isDriverLockedNow(driverId){
      const now = Date.now();
      return activeDriverLocks.some(l=>{
        return String(l.driverTraineeId) === String(driverId)
          && now >= Date.parse(l.fromISO) && now <= Date.parse(l.toISO);
      });
    }

    // helper: نهاية القفل (إن وجد)
    function driverLockEnd(driverId){
      const now = Date.now();
      const hit = activeDriverLocks.find(l =>
        String(l.driverTraineeId) === String(driverId)
        && now >= Date.parse(l.fromISO) && now <= Date.parse(l.toISO)
      );
      return hit ? new Date(hit.toISO) : null;
    }


    // ===== تحميل الإعدادات من config.json =====
    async function loadConfig(){
      const url = 'config.json?ts=' + Date.now(); // تفادي الكاش
      try{
        const res = await fetch(url, { cache:'no-store' });
        if(!res.ok) throw new Error('config.json not found ('+res.status+')');

        // لو رجع HTML بدل JSON (بعض الاستضافات تعيد index.html)
        const ct = (res.headers.get('content-type') || '').toLowerCase();
        const raw = await res.text();
        if (ct.includes('text/html') || raw.trim().startsWith('<')) {
          console.error('[CONFIG] Expected JSON but got HTML. First 200 chars:\n', raw.slice(0,200));
          throw new Error('config.json returned HTML');
        }

        // رجّع النص كـ JSON بعد الفحص
        const cfg = JSON.parse(raw);
        CFG = cfg;

        // ندعم أسماء مفاتيح متعددة (مرونة لملفات قديمة/جديدة)
        GOOGLE_SCRIPT_URL = sanitizeStr(
          cfg?.GOOGLE_SCRIPT_URL || cfg?.SCRIPT_URL || cfg?.scriptUrl || ''
        );
        API_KEY = sanitizeStr(
          cfg?.API_KEY || cfg?.apiKey || cfg?.defaultApiKey || ''
        );
        allowSelfRegister = !!cfg?.allowSelfRegister;

        // الأيام: إذا محددة في الملف نستخدمها، وإلا إذا includeWeekend=true نضم الجمعة+السبت
        if (Array.isArray(cfg?.days) && cfg.days.length) {
          DAYS = cfg.days.map(String);
        } else if (cfg?.includeWeekend === true) {
          DAYS = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];
        }
      }catch(e){
        console.warn('[CONFIG] Using defaults:', e.message);
        // إبقاء القيم الافتراضية، وترك GOOGLE_SCRIPT_URL فارغًا ليظهر شريط الحالة "غير متصل"
      }
    }


    // ===== عناصر الواجهة المساعدة =====
    function fillDaysCheckboxes(){
      const host = document.getElementById('daysGroup');
      if(!host) return;
      host.innerHTML = '';
      DAYS.forEach((d, i)=>{
        const id = 'day_'+i;
        const w = document.createElement('label');
        w.className = 'checkbox-item';
        w.innerHTML = `<input type="checkbox" value="${d}" id="${id}"><span>${d}</span>`;
        host.appendChild(w);
      });
    }

    function setUserHeaderUI(user){
      const name = document.getElementById('userName');
      const role = document.getElementById('userRole');
      const homeU = document.getElementById('homeUserName');
      if(name)  name.textContent  = sanitizeStr(user?.name || 'مستخدم');
      if(homeU) homeU.textContent = sanitizeStr(user?.name || 'مستخدم');
      if(role)  role.textContent  = sanitizeStr(user?.userType || 'راكب');
    }

    // ===== السائقون =====
// ===== السائقون =====
    function renderDrivers(list){
      const wrap = document.getElementById('driversList');
      const countEl = document.getElementById('availableDriversCount');
      if (countEl) countEl.textContent = `(${list?.length ?? 0})`;
      if (!wrap) return;

      if (!list || !list.length){
        wrap.innerHTML = `<div class="alert alert-warning">لا يوجد سائقون حالياً</div>`;
        return;
      }

      wrap.innerHTML = '';

      const isViewerDriver = !!currentUser && String(currentUser.userType).trim() === 'سائق';

      list.forEach(d=>{
        const id    = sanitizeStr(d.traineeId || d.id || '');
        const phone = getWaPhoneFromRecord(d);
        const waUrl = phone ? buildWaUrl(phone, `مرحباً ${d.name}، أرغب بالتنسيق عبر "ساند".`) : '';

        // 🔒 حالة القفل (غير متاح)
        const locked   = isDriverLockedNow(id);
        const lockEnd  = locked ? driverLockEnd(id) : null;
        const untilTxt = (locked && lockEnd)
          ? `غير متاح حتى ${lockEnd.toLocaleDateString('ar-SA')}`
          : (locked ? 'غير متاح حالياً' : '');

        // سطر التقييم يُخفى عن السائقين، ويُستبدل بشارة القفل عند الإقفال
        const ratingHtml = (!isViewerDriver && !locked)
          ? `<p class="rating">التقييم: ${'⭐'.repeat(Math.max(1, Math.min(5, Number(d.rating)||0)))} (${d.rating||0})</p>`
          : '';

        const card = document.createElement('div');
        card.className = 'driver-card';
        card.innerHTML = `
          <div class="driver-info">
            <div class="driver-details">
              <h3>${sanitizeStr(d.name || 'بدون اسم')}</h3>
              <p>الرقم: <strong>${id}</strong></p>
              <p>الحي: ${sanitizeStr(d.neighborhood || '-')}</p>
              ${locked ? `<div class="status-booked">${untilTxt}</div>` : ratingHtml}
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              ${waUrl ? `<a class="btn btn-whatsapp" href="${waUrl}" target="_blank" rel="noopener">واتساب</a>` : ''}
              <button class="btn btn-primary" data-pick="${id}" ${locked ? 'disabled' : ''}>
                ${locked ? 'غير متاح' : 'اختيار'}
              </button>
            </div>
          </div>
        `;
        wrap.appendChild(card);
      });

      // اختيار سريع للسائق (مع منع اختيار المقفول)
      wrap.querySelectorAll('button[data-pick]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-pick');
          if (!id) return;

          if (isDriverLockedNow(id)){
            showToast('السائق غير متاح حالياً', 'warn');
            return;
          }

          if (currentUser && String(currentUser.userType).trim() === 'سائق') {
            showToast('الحجز متاح للركاب فقط', 'warn');
            return;
          }

          lastQuickDriverId = id;
          document.querySelector('.tab[data-tab="book"]')?.click();
          setTimeout(()=>{
            const sel = document.getElementById('selectedDriver');
            if (sel){
              const match = (drivers || []).find(x => String(x.traineeId||x.id) === id);
              if (match) sel.value = (match.traineeId || match.id || '');
            }
          }, 50);
        });
      });
    }
    async function loadDrivers(){
      try{
        // اجلب الأقفال النشطة أولاً
        try{ await fetchActiveLocks(); }catch{}

        const q = $('#searchDriver')?.value?.trim() || '';
        const neigh = $('#filterNeighborhood')?.value || '';
        const {data} = await fetchWithCache('getDrivers', {}, {ttl:CACHE_TTL.getDrivers});
        let list = Array.isArray(data) ? data : [];

        // فلترة نص/حي
        if(q){
          const nq = normalizeDigits(q).toLowerCase();
          list = list.filter(d =>
            String(d.name||'').toLowerCase().includes(nq) ||
            String(d.traineeId||d.id||'').toLowerCase().includes(nq)
          );
        }
        if(neigh) list = list.filter(d => String(d.neighborhood||'') === neigh);

        // ✅ استبعاد السائقين المقفولين (مقبولين/محجوزين)
        list = list.filter(d => !isDriverLockedNow(d.traineeId || d.id));

        // ترتيب بالاسم
        list.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||''), 'ar'));

        drivers = list;
        renderDrivers(list);
      }catch(e){
        $('#driversList').innerHTML = `<div class="alert alert-error">تعذر تحميل قائمة السائقين</div>`;
      }
    }




    // ===== طلبات المستخدم =====

/* ============ طلباتي (راكب): عرض + زر حذف يحمل driverTraineeId ============ */
// استبدل دالتك renderPassengerRequests بهذه النسخة
function renderPassengerRequests(list){
  const host  = document.getElementById('userRequestsList');
  const badge = document.getElementById('requestsBadge');
  if(!host) return;

  if(!list || !list.length){
    host.innerHTML = `<div class="alert alert-info">لا توجد طلبات حالياً</div>`;
    if(badge){ badge.textContent='0'; badge.style.display='none'; }
    return;
  }

  host.innerHTML = '';
  let activeCount = 0;

  list.forEach(r=>{
    const stAr = String(r.status || 'معلق').trim();
    if(stAr === 'معلق') activeCount++;

    const cls =
      stAr === 'مقبول' ? 'accepted' :
      stAr === 'مرفوض' ? 'rejected' : '';

    const daysArr = Array.isArray(r.selectedDays)
      ? r.selectedDays
      : String(r.selectedDays || '').split(',').map(s=>s.trim()).filter(Boolean);

    const stChip =
        stAr === 'مقبول' ? '<div class="status-accepted">مقبول</div>' :
        stAr === 'مرفوض' ? '<div class="status-rejected">مرفوض</div>' :
        stAr === 'محذوف' ? '<div class="status-rejected">محذوف</div>' :
                            '<div class="status-pending">قيد المراجعة</div>';


    // ✅ الآن زر الحذف يحمل أيضًا driverTraineeId لتنظيف كاش السائق
    const delBtn = (stAr === 'معلق')
      ? `<button class="btn btn-reject" data-del="${r.id}" data-driver="${sanitizeStr(r.driverTraineeId||'')}">🗑️ حذف الطلب</button>`
      : '';

    const d = document.createElement('div');
    d.className = `request-card ${cls}`;
    d.innerHTML = `
      <div class="request-header">
        <div class="request-title">طلب #${(r.id ?? '-')}</div>
        ${stChip}
      </div>
      <div class="request-details">
        <p>السائق: <strong>${sanitizeStr(r.driverName || '-')}</strong></p>
        <p>الأيام: ${daysArr.length ? daysArr.join('، ') : '-'}</p>
        <p>المدة: ${r.duration || '-'} أسبوع</p>
        ${r.notes ? `<p>ملاحظات: ${sanitizeStr(r.notes)}</p>` : ''}
        ${delBtn}
      </div>
    `;
    host.appendChild(d);
  });

  if(badge){
    badge.textContent = String(activeCount);
    badge.style.display = activeCount ? 'inline-flex' : 'none';
  }

  // ربط الحذف وتمرير driverTraineeId
  host.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id       = btn.getAttribute('data-del');
      const driverId = btn.getAttribute('data-driver') || '';
      if(!id) return;
      deleteMyPendingRequest(id, driverId);
    });
  });
}


/* ============ حذف طلب (راكب): مع تنظيف كاش السائق وإجبار التحديث ============ */
// استبدل دالتك deleteMyPendingRequest بهذه النسخة
async function deleteMyPendingRequest(requestId, driverId=''){
  if(!currentUser){ showToast('سجّل الدخول أولاً','warn'); return; }
  if(!confirm('هل تريد حذف هذا الطلب؟')) return;

  try{
    const resp = await sendToGoogleSheets('deleteRequest', {
      requestId: String(requestId),
      passengerTraineeId: currentUser.traineeId
    });

    if(resp && resp.success){
      showToast('تم حذف الطلب','success');

      // 🧹 تنظيف كاش الراكب
      clearCache('getPassengerRequests', { passengerTraineeId: currentUser.traineeId });

      // 🧹 تنظيف كاش السائق المتأثر (إن توفر رقم السائق)
      if(driverId){
        clearCache('getDriverRequests', { driverTraineeId: driverId });
      }

      // 🔄 جلب فوري من الشبكة لتحديث القوائم
      await loadRequests({force:true});

      // (اختياري) حدّث قائمة السائقين مباشرة لو كان الحجز المقبول يفتح قفلًا — هنا لا حاجة لأن الحذف للطلبات المعلقة فقط.
      // await loadDrivers();

    }else{
      showToast(resp?.error || 'تعذر حذف الطلب','error');
    }
  }catch(e){
    console.error(e);
    showToast('خطأ في الاتصال','error');
  }
}

/* ============ ربط زر التحديث ليجبر الجلب من الشبكة ============ */
// ضع هذا الربط (يستبدل الربط القديم إن وُجد)
document.getElementById('refreshRequestsBtn')?.addEventListener('click', ()=>{
  loadRequests({force:true});
});

    function renderDriverRequests(list){
  const host  = document.getElementById('userRequestsList');
  const badge = document.getElementById('requestsBadge');
  if(!host) return;

  if(!list || !list.length){
    host.innerHTML = `<div class="alert alert-info">لا توجد طلبات واردة حالياً</div>`;
    if(badge){ badge.textContent='0'; badge.style.display='none'; }
    return;
  }

  host.innerHTML = '';
  let pendingCount = 0;

  list.forEach(r=>{
    const stAr = String(r.status || 'معلق').trim();
    if(stAr === 'معلق') pendingCount++;

    const cls =
      stAr === 'مقبول' ? 'accepted' :
      stAr === 'مرفوض' ? 'rejected' : '';

    const daysArr = Array.isArray(r.selectedDays)
      ? r.selectedDays
      : String(r.selectedDays || '').split(',').map(s=>s.trim()).filter(Boolean);

    const stChip =
      stAr === 'مقبول' ? '<div class="status-accepted">مقبول</div>' :
      stAr === 'مرفوض' ? '<div class="status-rejected">مرفوض</div>' :
      stAr === 'محذوف' ? '<div class="status-rejected">محذوف</div>' :
                          '<div class="status-pending">قيد المراجعة</div>';


    const controls = (stAr === 'معلق')
      ? `
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-accept" data-act="accept" data-id="${r.id}">✅ قبول</button>
          <button class="btn btn-reject" data-act="reject" data-id="${r.id}">❌ رفض</button>
        </div>
      `
      : '';

    const d = document.createElement('div');
    d.className = `request-card ${cls}`;
    d.innerHTML = `
      <div class="request-header">
        <div class="request-title">طلب #${(r.id ?? '-')}</div>
        ${stChip}
      </div>
      <div class="request-details">
        <p>الراكب: <strong>${(r.passengerName || '-')}</strong> — ${sanitizeStr(r.passengerTraineeId || '')}</p>
        <p>الهاتف: ${sanitizeStr(r.passengerPhone || '-')}</p>
        <p>الأيام: ${daysArr.length ? daysArr.join('، ') : '-'}</p>
        <p>المدة: ${r.duration || '-'} أسبوع</p>
        ${r.notes ? `<p>ملاحظات: ${r.notes}</p>` : ''}
      </div>
      ${controls}
    `;
    host.appendChild(d);
  });

  if(badge){
    badge.textContent = String(pendingCount);
    badge.style.display = pendingCount ? 'inline-flex' : 'none';
  }

  // ربط أزرار القبول/الرفض
  host.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id  = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act'); // 'accept' | 'reject'
      if(!id) return;
      setRequestStatus(id, act);
    });
  });
}


async function setRequestStatus(id, action){
  if(!currentUser || String(currentUser.userType||'') !== 'سائق'){
    showToast('هذا الإجراء مخصص للسائقين','warn'); return;
  }
  const approve = (action === 'accept');
  const payload = {
    requestId: String(id),
    response:  approve ? 'مقبول' : 'مرفوض',
    driverTraineeId: currentUser.traineeId
  };

  try{
    const resp = await sendToGoogleSheets('respondToRequest', payload);
    if(resp && resp.success){
      showToast(approve ? 'تم قبول الطلب' : 'تم رفض الطلب', 'success');

      // 🧹 تفريغ كاش طلبات السائق لضمان التحديث الفوري
      try{
        const key = buildCacheKey('getDriverRequests', { driverTraineeId: currentUser.traineeId });
        memCache.delete(key);
        localStorage.removeItem('sand_cache_' + key);
      }catch{}
      await loadRequests();
      try{
          await fetchActiveLocks();  // يسحب الأقفال الجديدة
          await loadDrivers();       // ينعش قائمة السائقين (ستظهر محجوز)
        }catch{}
    }else{
      showToast(resp?.error || 'تعذر تحديث الحالة','error');
    }
  }catch(e){
    console.error(e);
    showToast('خطأ في الاتصال','error');
  }
}



/* ===================== أدوات مساعدة للكاش ===================== */
function clearCache(action, dataObj){
  try{
    const key = buildCacheKey(action, dataObj||{});
    memCache.delete(key);
    localStorage.removeItem('sand_cache_' + key);
  }catch{}
}

/* ===================== طلباتي: تحميل مع خيار force ===================== */
// استبدل دالتك loadRequests بهذه النسخة
async function loadRequests(opts = {}) {
  if(!currentUser) return;

  const force   = !!opts.force; // عند true: جلب مباشر من الشبكة
  const isDriver = String(currentUser.userType || '').trim() === 'سائق';
  const host     = document.getElementById('userRequestsList');
  const titleEl  = document.getElementById('requestsTitle');
  const badge    = document.getElementById('requestsBadge');

  if (titleEl) titleEl.textContent = isDriver ? 'الطلبات الواردة لي كسائق' : 'طلباتي';

  try{
    if (isDriver){
      const {data} = await fetchWithCache(
        'getDriverRequests',
        { driverTraineeId: currentUser.traineeId },
        force ? { ttl: 0, staleOK: false } : { ttl: CACHE_TTL.getDriverRequests }
      );

      const list = Array.isArray(data) ? data
                 : (Array.isArray(data?.requests) ? data.requests : []);
      const pendingCount = (Array.isArray(data?.requests) && data?.stats?.pendingRequests != null)
        ? Number(data.stats.pendingRequests)
        : list.filter(r => String(r.status||'').trim()==='معلق').length;

      renderDriverRequests(list);

      if(badge){
        badge.textContent = String(pendingCount || 0);
        badge.style.display = pendingCount ? 'inline-flex' : 'none';
      }

    } else {
      const {data} = await fetchWithCache(
        'getPassengerRequests',
        { passengerTraineeId: currentUser.traineeId },
        force ? { ttl: 0, staleOK: false } : { ttl: CACHE_TTL.getPassengerRequests }
      );

      const list = Array.isArray(data) ? data : [];
      renderPassengerRequests(list);
    }
  }catch(e){
    console.error('loadRequests error', e);
    if(host) host.innerHTML = `<div class="alert alert-error">تعذر تحميل الطلبات</div>`;
    if(badge){ badge.textContent='0'; badge.style.display='none'; }
  }
}




    function pickNumber(obj, keys){
        for(const k of keys){
          const v = Number(obj?.[k]);
          if(!Number.isNaN(v) && v >= 0) return v;
        }
        return null;
      }

    // ===== إحصائياتي =====
      function updateMyStatsUI(data){
        $('#myTripsCount').textContent     = (data?.totalTrips ?? '-');
        $('#myRating').textContent         = data?.rating ? `${data.rating} ⭐` : '-';
        $('#myActiveRequests').textContent = data?.activeRequests ?? '-';
        $('#communitySize').textContent    = (data?.community ?? '-');
      }


    async function loadMyStats(){
      if(!currentUser) return;
      try{
          const [{data:me},{data:top}] = await Promise.all([
            fetchWithCache('getUserStats', {
              traineeId: currentUser.traineeId,
              userType: currentUser.userType   // ✅ هذا هو المهم
            }, {ttl: CACHE_TTL.getUserStats}),
            fetchWithCache('getTopStats', {}, {ttl: CACHE_TTL.getTopStats})
          ]);


        // جهّز “community” حتى لو السيرفر ما رجّعه
        const communityFallback = pickNumber(me, ['community','communitySize','members','users','community_count'])
                              ?? pickNumber(top, ['totalUsers','users']);
        const merged = {...(me||{}), community: communityFallback};

        updateMyStatsUI(merged||{});
      }catch(e){
        // ممكن تخليها صامتة أو تضيف لوج:
        console.debug('loadMyStats error', e);
      }
    }


    // ===== الحجز =====
    function prepareBookingUI(){
      if (currentUser && String(currentUser.userType).trim() === 'سائق') {
        showToast('الحجز متاح للركاب فقط', 'warn');
        document.querySelector('.tab[data-tab="home"]')?.click();
        return;
      }

      const sel = document.getElementById('selectedDriver');
      if(sel){
        const cur = sel.value;
        // ✅ اعرض فقط غير المقفولين
        const optionsHtml = (drivers||[])
          .filter(d => !isDriverLockedNow(String(d.traineeId || d.id)))
          .map(d=>{
            const id   = sanitizeStr(d.traineeId || d.id || '');
            const nm   = sanitizeStr(d.name || id || 'سائق');
            const hood = sanitizeStr(d.neighborhood || '-');
            return `<option value="${id}">${nm} — ${hood}</option>`;
          }).join('');

        sel.innerHTML = `<option value="">اختر السائق</option>` + optionsHtml;

        if(lastQuickDriverId) sel.value = lastQuickDriverId;
        if(cur && !sel.value) sel.value = cur;
      }

      fillDaysCheckboxes();
    }



async function submitBooking(ev){
  ev?.preventDefault?.();
  if (!currentUser) { showToast('سجّل الدخول أولاً','warn'); return; }

  // 🔒 المنع الحازم: لا حجز إلا للراكب
  if (String(currentUser.userType).trim() !== 'متدرب') {
    showToast('الحجز متاح للركاب فقط', 'warn');
    return;
  }

  const driverId = $('#selectedDriver').value;
  const driver   = (drivers||[]).find(d => (d.traineeId || d.id) == driverId) || null;
  let   days     = Array.from(document.querySelectorAll('#daysGroup input:checked')).map(i => i.value);
  let   duration = Number($('#duration').value || 0);
  const notes    = $('#tripNotes').value.trim();

  // تحققات مدخلات
  if (!driverId || !driver) { showToast('اختر السائق','warn'); return; }
  days = Array.from(new Set(days));
  const allowedDays = (window.DAYS || ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس']);
  if (!days.length || !days.every(d => allowedDays.includes(d))) {
    showToast('اختر أيام صحيحة','warn'); return;
  }
  duration = Math.max(0, Math.floor(duration));
  if (!duration) { showToast('اختر المدة','warn'); return; }

  // منع النقر المزدوج
  const btn = $('#bookingBtn');
  if (btn?.dataset?.busy === '1') return;
  if (btn) { btn.disabled = true; btn.dataset.busy = '1'; btn.setAttribute('aria-busy','true'); }

  try{
    const payload = {
      passengerTraineeId:   currentUser.traineeId,
      passengerName:        currentUser.name || '',
      passengerPhone:       currentUser.phone || '',
      passengerNeighborhood:currentUser.neighborhood || '',

      driverTraineeId: driverId,
      driverName:      driver.name || '',
      driverPhone:     driver.phone || '',

      selectedDays: days,
      duration,
      notes,
      requestDate: new Date().toISOString()
    };

    // ✅ منع التكرار لنفس السائق
    // اجلب طلبات الراكب وتأكد ما فيه طلب "معلق" أو "مقبول" لنفس السائق
    try{
      const r = await fetchWithCache('getPassengerRequests', {
        passengerTraineeId: currentUser.traineeId
      }, { ttl: 0, staleOK: false }); // جلب فوري من الشبكة

      const myReqs = Array.isArray(r?.data) ? r.data : [];
      const dup = myReqs.find(x => String(x.driverTraineeId) === String(driverId)
        && ['معلق','مقبول'].includes(String(x.status||'').trim()));

      if (dup){
        showToast('عندك طلب قائم لنفس السائق — انتظر القبول/الرفض أولاً', 'warn');
        // (اختياري) عرض انتقال سريع لقائمة الطلبات
        document.querySelector('.tab[data-tab="requests"]')?.click();
        // فك الزر قبل الخروج
        if (btn){ btn.disabled=false; btn.dataset.busy='0'; btn.removeAttribute('aria-busy'); }
        return;
      }
    }catch(e){
      // لو فشل الجلب نكمل بحذر أو نمنع؛ الأفضل المنع
      showToast('تعذر التحقق من الطلبات الحالية — حاول مجدداً', 'error');
      if (btn){ btn.disabled=false; btn.dataset.busy='0'; btn.removeAttribute('aria-busy'); }
      return;
    }

    const resp = await sendToGoogleSheets('submitBooking', payload);

    if (resp && resp.success === true) {
      const newId = resp.data?.id;
      showToast(newId ? `تم إرسال الطلب #${newId} بنجاح` : 'تم إرسال الطلب بنجاح','success');

      // فتح واتساب (اختياري إن وُجد رقم)
      const wa = getWaPhoneFromRecord(driver);
      if (wa) {
        const msg = `مرحباً ${driver?.name || ''}، معك ${currentUser.name}. أرغب بتنسيق توصيل في الأيام: ${days.join('، ')} لمدة ${duration} ${duration === 1 ? 'أسبوع' : 'أسابيع'} عبر «ساند» بالكلية التقنية بحقل. هل يناسبك الموعد؟`;
        window.open(buildWaUrl(wa, msg), '_blank', 'noopener');
      }


      await loadRequests();
      document.querySelector('.tab[data-tab="requests"]')?.click();
      } else {
        const err = String(resp?.error || '');
        if (err === 'DRIVER_BUSY') {
          showToast('السائق لديه طلب قائم حالياً — نأمل المحاولة لاحقاً أو اختيار سائق آخر','warn');
          // (اختياري) ارجع المستخدم لتبويب السائقين:
          // document.querySelector('.tab[data-tab="drivers"]')?.click();
        } else if (err === 'DUPLICATE_REQUEST') {
          showToast('لديك بالفعل طلب مع هذا السائق','warn');
        } else {
          showToast(err || 'تعذر حفظ الطلب','error');
        }
      }
  } catch (e) {
    console.error(e);
    showToast('خطأ في الاتصال','error');
  } finally {
    if (btn) { btn.disabled = false; btn.dataset.busy = '0'; btn.removeAttribute('aria-busy'); }
  }
}

// داخل if (resp && resp.success === true) { ... }
try{
  const key = buildCacheKey('getPassengerRequests', { passengerTraineeId: currentUser.traineeId });
  memCache.delete(key);
  localStorage.removeItem('sand_cache_' + key);
}catch{}


    // ===== التقييم =====
async function prepareRatingUI(){
  const sel   = document.getElementById('ratedDriver');
  const title = document.getElementById('rateTitle');
  const label = document.getElementById('rateSelectLabel');
  if(!sel) return;

  const isDriver = !!currentUser && String(currentUser.userType).trim() === 'سائق';

  // تفريغ + عنوان/وسم مناسبين للدور
  sel.innerHTML = `<option value="">اختر</option>`;
  if(isDriver){
    title.textContent = 'تقييم الراكب';
    label.textContent = 'الراكب';

    // اجلب ركاب هذا السائق من الطلبات (مقبول/مكتمل)
    let reqsData = null;
    try{
      const {data} = await fetchWithCache('getDriverRequests', {
        driverTraineeId: currentUser.traineeId
      }, { ttl: CACHE_TTL.getDriverRequests });
      reqsData = Array.isArray(data) ? data : (Array.isArray(data?.requests) ? data.requests : []);
    }catch{}

    const seen = new Set();
    const passengers = [];
    (reqsData||[])
      .filter(r => ['مقبول','مكتمل'].includes(String(r.status||'').trim()))
      .forEach(r=>{
        const id = String(r.passengerTraineeId||'').trim();
        if(id && !seen.has(id)){
          seen.add(id);
          passengers.push({ id, name: sanitizeStr(r.passengerName||id) });
        }
      });

    if(!passengers.length){
      sel.innerHTML = `<option value="">لا يوجد ركاب قابلين للتقييم حالياً</option>`;
      return;
    }

    passengers.forEach(p=>{
      sel.insertAdjacentHTML('beforeend',
        `<option value="${p.id}">${p.name} — ${p.id}</option>`);
    });

    // نخزّن مؤقتًا لالتقاط الاسم في submitRating
    sel.dataset.role = 'rate_passenger';
    sel.dataset.lookup = JSON.stringify(passengers);

  }else{
    title.textContent = 'تقييم السائق';
    label.textContent = 'السائق';

    // تأكد أن drivers مُحمَّلة
    if(!Array.isArray(drivers) || !drivers.length){
      try{ await loadDrivers(); }catch{}
    }

    (drivers||[]).forEach(d=>{
      const id = sanitizeStr(d.traineeId || d.id || '');
      const nm = sanitizeStr(d.name || id || 'سائق');
      sel.insertAdjacentHTML('beforeend', `<option value="${id}">${nm}</option>`);
    });

    sel.dataset.role = 'rate_driver';
    sel.dataset.lookup = JSON.stringify(
      (drivers||[]).map(d=>({id:String(d.traineeId||d.id||''), name:String(d.name||'')}))
    );
  }
}


async function submitRating(ev){
  ev?.preventDefault?.();
  if (!currentUser) { showToast('سجّل الدخول أولاً','warn'); return; }

  const sel      = document.getElementById('ratedDriver');
  const chosenId = $('#ratedDriver').value;
  const stars    = Number($('#ratingStars').value || 0);
  const notes    = $('#ratingNotes').value.trim();

  if (!chosenId || !stars) { showToast('اختر الهدف والتقييم','warn'); return; }

  const selRole = sel?.dataset?.role || 'rate_driver';
  let targetType = (selRole === 'rate_passenger') ? 'راكب' : 'سائق';
  let targetId   = chosenId;
  let targetName = '';

  // استخرج الاسم من lookup المخزّن
  try{
    const lookup = JSON.parse(sel?.dataset?.lookup || '[]');
    const match  = lookup.find(x => String(x.id) === String(chosenId));
    targetName   = match?.name || chosenId;
  }catch{
    targetName = chosenId;
  }

  try{
    $('#ratingBtn').disabled = true;

    const payload = {
      targetType,                 // 'راكب' لو السائق هو المُقيِّم، وإلا 'سائق'
      targetName,                 // اسم الهدف
      targetTraineeId: targetId,  // رقم الهدف
      raterName: currentUser.name || '',
      raterTraineeId: currentUser.traineeId,
      stars,
      notes
    };

    const resp = await sendToGoogleSheets('submitRating', payload);

    if (resp && resp.success === true) {
      showToast('شكراً لتقييمك','success');
      $('#ratingForm').reset();
      await loadMyStats();
      if (typeof loadDrivers === 'function') { loadDrivers(); } // لتحديث المتوسطات
    } else {
      showToast(resp?.error || 'تعذر إرسال التقييم','error');
    }

  } catch (e) {
    console.error(e);
    showToast('خطأ في الاتصال','error');
  } finally {
    $('#ratingBtn').disabled = false;
  }
}


    // ===== التسجيل =====

    // ===== التسجيل =====
    async function submitRegistration(ev){
      ev?.preventDefault?.();

      const name  = $('#name').value.trim();
      const idRaw = $('#traineeId').value.trim();
      const id    = normalizeDigits(idRaw);
      const phone = normalizePhoneKSA($('#phone').value);
      const hood  = $('#neighborhood').value;
      const type  = $('#userType').value;
      const btn   = $('#registerBtn');

      // ✅ تحققات مسبقة قوية
      if (!name || name.length < 2){
        showToast('أدخل الاسم الكامل بشكل صحيح','warn'); 
        return;
      }
      if (!/^\d{6,}$/.test(id)){
        showToast('رقم المتدرب غير صحيح (أرقام فقط، 6 خانات فأكثر)','warn');
        return;
      }
      if (!isValidPhoneKSA(phone)){
        showToast('صيغة الجوال غير صحيحة (مثال: 9665XXXXXXXX)','warn');
        return;
      }
      if (!hood){
        showToast('اختر الحي','warn');
        return;
      }
      if (!isValidUserType?.(type)){
        showToast('اختر نوع المستخدم (سائق/متدرب)','warn');
        return;
      }

      // ⛔️ منع النقر المزدوج
      if (btn?.dataset?.busy === '1') return;
      if (btn){
        btn.disabled = true;
        btn.dataset.busy = '1';
        btn.setAttribute('aria-busy','true');
      }

      try{
        const payload = { name, traineeId:id, phone, neighborhood:hood, userType:type };
        const resp = await sendToGoogleSheets('registerUser', payload);

        // ✅ نجاح تام
        if (resp && resp.success === true){
          showToast('تم التسجيل بنجاح، يمكنك الدخول الآن','success');
          setAppMode('login');
          $('#loginTraineeId').value = id;
          return;
        }

        // ❌ تفكيك الأخطاء الشائعة القادمة من السكربت الخلفي
        const err = resp?.error;
        if (err === 'NOT_IN_ROSTER'){
          showToast('رقمك غير موجود بقائمة المتدربين','error');
        } else if (err === 'TRAINEE_NOT_AUTHORIZED'){
          showToast('رقمك غير مُفعّل بالمؤسسة','error');
        } else if (err === 'INVALID_PHONE_FORMAT'){
          showToast('صيغة الجوال غير صحيحة (مثال: 9665XXXXXXXX)','error');
        } else if (err === 'INVALID_TRAINEE_ID'){
          showToast('رقم المتدرب غير صالح','error');
        } else if (err === 'DUPLICATE_USER' || err === 'DUPLICATE_TRAINEE_ID'){
          showToast('هذا الرقم مسجّل مسبقاً','warn');
        } else {
          showToast(err || 'تعذّر إتمام التسجيل','error');
        }

      } catch (e) {
        console.error('[register] network/error:', e);
        const msg = e?.name === 'AbortError' ? 'انتهت المهلة — حاول مجدداً' : 'خطأ في الاتصال';
        showToast(msg, 'error');

      } finally {
        // 🔓 استعادة حالة الزر بشكل مضمون
        if (btn) {
          btn.disabled = false;
          btn.dataset.busy = '0';
          btn.removeAttribute('aria-busy');
        }
      }
    }



    // ===== تسجيل الدخول =====
    async function doLogin(){
      const raw = $('#loginTraineeId').value.trim();
      const id  = normalizeDigits(raw);
      if(!/^\d{6,}$/.test(id)){ showToast('رقم المتدرب غير صحيح','warn'); return; }

      try{
        $('#loginBtn').disabled = true;
        const resp = await sendToGoogleSheets('verifyUser', { traineeId: id });
        // 🔒 لو موجود في Roster = Active لكن "مو مسجل" في Users
        if (resp && resp.success === false && resp.error === 'NOT_REGISTERED_IN_USERS') {
          setAppMode('register_only');           // افتح شاشة التسجيل فقط
          $('#traineeId').value = id;            // عبّي رقم المتدرب تلقائياً
          if (resp.data?.rosterName) {
            $('#name').value = resp.data.rosterName; // (اختياري) تعبئة الاسم من Roster
          }
          showToast('أكمل التسجيل أولاً','warn');
          return; // امنع أي دخول للتطبيق قبل التسجيل
        }


        const valid =
          resp && resp.success === true &&
          resp.data && typeof resp.data === 'object' &&
          typeof resp.data.traineeId === 'string' &&
          resp.data.traineeId.replace(/\s/g,'') === id &&
          isValidUserType(resp.data.userType) &&
          typeof resp.data.name === 'string' && resp.data.name.trim().length > 0;

        if (valid) {
          currentUser = resp.data;
          setUserHeaderUI(currentUser);
          setAppMode('app');
          document.documentElement.classList.add('app-ready');
          showToast('مرحباً بك في ساند','success');
          heartbeat(); loadDrivers(); loadRequests(); loadMyStats();
        } else {
          if (allowSelfRegister) {
            showToast('لم يتم العثور على رقمك — أكمل التسجيل','warn');
            setAppMode('register_only');
            $('#traineeId').value = id;
          } else {
            showToast('رقمك غير موجود — تواصل مع المنشأة','error');
          }
        }

      }catch{
        showToast('تعذر التحقق من الرقم','error');
      }finally{
        $('#loginBtn').disabled = false;
      }
    }

    // ===== الثيم =====
    function toggleTheme(){
      const root = document.documentElement;
      const btn  = document.getElementById('themeToggleBtn');
      const dark = root.classList.toggle('dark');
      if(btn) btn.textContent = dark ? 'الوضع الفاتح' : 'الوضع الداكن';
      try{ localStorage.setItem('sand_theme', dark?'dark':'light'); }catch{}
    }
    function restoreTheme(){
      try{
        const v = localStorage.getItem('sand_theme');
        if(v==='dark'){ document.documentElement.classList.add('dark'); $('#themeToggleBtn').textContent='الوضع الفاتح'; }
      }catch{}
    }

    // ===== دعم عائم =====
    function setupSupportFab(){
      const fab = document.getElementById('supportFab');
      const welcomeTip = document.getElementById('welcomeSupportTip');
      if(!fab) return;
      
      const main = fab.querySelector('button.main');
      const menu = fab.querySelector('.support-menu');
      
      // إظهار التلميح الترحيبي تلقائيًا
      const hasSeenTip = localStorage.getItem('sand_support_tip_seen');
      if(!hasSeenTip && welcomeTip){
        setTimeout(()=>{
          welcomeTip.classList.add('show');
          
          // إخفاء بعد 6 ثوانٍ
          setTimeout(()=>{
            welcomeTip.classList.remove('show');
            localStorage.setItem('sand_support_tip_seen', 'true');
          }, 6000);
        }, 1500); // تأخير ثانية ونص بعد الدخول
      }
      
      // إغلاق التلميح عند الضغط على ×
      if(welcomeTip){
        welcomeTip.addEventListener('click', (e)=>{
          if(e.target === welcomeTip || e.offsetX > welcomeTip.offsetWidth - 30){
            welcomeTip.classList.remove('show');
            localStorage.setItem('sand_support_tip_seen', 'true');
          }
        });
      }
      
      // فتح/إغلاق قائمة الدعم
      main?.addEventListener('click', ()=>{
        fab.classList.toggle('open');
        if(welcomeTip) welcomeTip.classList.remove('show');
      });
      
      // إغلاق عند الضغط خارج القائمة
      document.addEventListener('click', (e)=>{
        if(!fab.contains(e.target)){
          fab.classList.remove('open');
        }
      });
    }
    // ===== إحداثيات الواجهة =====
    function setupUIEvents(){
      // تبويبات
      $$('.tab').forEach(b=>{
        b.addEventListener('click', ()=> switchTab(b.dataset.tab));
      });

      $('#openHousingBtn')?.addEventListener('click', ()=>{
        // افتح صفحة عامة مستقلة لساند للسكن
        window.location.href = 'housing.html';
      });


      // أزرار
      $('#refreshDriversBtn')?.addEventListener('click', loadDrivers);
      $('#refreshRequestsBtn')?.addEventListener('click', loadRequests);
      $('#bookingForm')?.addEventListener('submit', submitBooking);
      $('#ratingForm')?.addEventListener('submit', submitRating);
      $('#registrationForm')?.addEventListener('submit', submitRegistration);
      $('#loginBtn')?.addEventListener('click', doLogin);
      $('#logoutBtn')?.addEventListener('click', ()=>{
        currentUser = null;
        showToast('تم تسجيل الخروج','info');
        setAppMode('login');
      });
      $('#themeToggleBtn')?.addEventListener('click', toggleTheme);

      // بحث/فلترة السائقين
      $('#searchDriver')?.addEventListener('input', ()=> loadDrivers());
      $('#filterNeighborhood')?.addEventListener('change', ()=> loadDrivers());

      // زر الرجوع من التسجيل
      $('#backToLoginBtn')?.addEventListener('click', ()=> setAppMode('login'));

      // زر تحديث الإحصائيات
      $('#refreshHomeStats')?.addEventListener('click', async () => {
        const btn = $('#refreshHomeStats');
        btn.disabled = true;
        btn.textContent = '⏳ جاري التحديث...';
        await loadMyStats();
        await heartbeat();
        btn.textContent = '🔄 تحديث الإحصائيات';
        btn.disabled = false;
        showToast('تم تحديث الإحصائيات', 'success');
      });
      setupTraineeIdHints();
      setupSupportFab();
    }
          // ====== ساند للسكن (rent) ======
      function telHref(raw=''){
        const s = normalizePhoneKSA(raw);      // دالة موجودة عندك
        return s ? `tel:+${s}` : '#';
      }

      // شكل البطاقة لكل مالك
      function housingCard(row){
        const seq  = sanitizeStr(row.seq ?? row['التسلسل'] ?? '');
        const name = sanitizeStr(row.owner ?? row['اسم المالك'] ?? '');
        const ph   = sanitizeStr(row.phone ?? row['رقم الجوال'] ?? '');
        const gov  = sanitizeStr(row.governorate ?? row['المحافظة'] ?? '');
        const hood = sanitizeStr(row.neighborhood ?? row['الحي'] ?? '');

        return `
          <div class="driver-card" style="margin-bottom:10px">
            <div class="driver-info">
              <div class="driver-details">
                <h3>${name || '—'}</h3>
                <p>التسلسل: <strong>${seq || '-'}</strong></p>
                <p>المحافظة: ${gov || '-'}</p>
                <p>الحي: ${hood || '-'}</p>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                ${ph ? `<a class="btn btn-contact" href="${telHref(ph)}">📞 اتصال</a>` : '<span class="status-pending">لا يوجد رقم</span>'}
              </div>
            </div>
          </div>
        `;
      }

      function renderHousingTabs(data){
        const tabsWrap = document.getElementById('housingTabs');
        const panels   = document.getElementById('housingPanels');
        if(!tabsWrap || !panels) return;

        // تجميع حسب المحافظة
        const byGov = new Map();
        (Array.isArray(data) ? data : []).forEach(r=>{
          const gov = sanitizeStr(r.governorate ?? r['المحافظة'] ?? 'أخرى') || 'أخرى';
          if(!byGov.has(gov)) byGov.set(gov, []);
          byGov.get(gov).push(r);
        });

        tabsWrap.innerHTML = '';
        panels.innerHTML = '';

        const govs = Array.from(byGov.keys()).sort((a,b)=> a.localeCompare(b, 'ar'));

        govs.forEach((gov, idx)=>{
          const tid = `hgov_${idx}`;

          // زر تبويب للمحافظة
          const btn = document.createElement('button');
          btn.className = 'tab' + (idx===0 ? ' active' : '');
          btn.type = 'button';
          btn.dataset.tab = tid;
          btn.textContent = gov;
          tabsWrap.appendChild(btn);

          // المحتوى الخاص بهذه المحافظة
          const panel = document.createElement('div');
          panel.className = 'content' + (idx===0 ? ' active' : '');
          panel.id = tid;
          panel.innerHTML = byGov.get(gov).map(housingCard).join('') || `
            <div class="alert alert-info">لا توجد عروض في هذه المحافظة حالياً</div>`;
          panels.appendChild(panel);
        });

        // تبديل تبويبات السكن
        tabsWrap.querySelectorAll('.tab').forEach(b=>{
          b.addEventListener('click', ()=>{
            tabsWrap.querySelectorAll('.tab').forEach(x=> x.classList.toggle('active', x===b));
            panels.querySelectorAll('.content').forEach(sec=>{
              const active = (sec.id === b.dataset.tab);
              sec.classList.toggle('active', active);
              sec.setAttribute('aria-hidden', active ? 'false' : 'true');
            });
          });
        });
      }

      async function loadHousing(){
        try{
          const {data} = await fetchWithCache('getRent', {}, {ttl: 60000});
          renderHousingTabs(Array.isArray(data) ? data : []);
        }catch(e){
          const panels = document.getElementById('housingPanels');
          if(panels){
            panels.innerHTML = `<div class="alert alert-error">تعذر تحميل بيانات السكن</div>`;
          }
        }
      }


    // ===== شاشة المقدمة =====
    async function startApp(){
      const startBtn = document.getElementById('startBtn');
      const loader   = document.getElementById('introLoader');
      startBtn?.addEventListener('click', async ()=>{
        try{
          startBtn.disabled = true;
          loader?.classList.add('show');
          await loadConfig();
          restoreTheme();
          try{
            await heartbeat();
            setConnStatus('online');
          }catch{
            setConnStatus('offline');
          }
          // جاهزية الواجهة
          document.documentElement.classList.add('app-ready');
          setAppMode('login');
          setupUIEvents();
          // تحديث دوري للإحصائيات
          if(requestsAutoTimer) clearInterval(requestsAutoTimer);
          requestsAutoTimer = setInterval(heartbeat, 60000);
        }catch{
          showToast('تعذر بدء التطبيق — تحقق من الإعدادات','error');
        }finally{
          loader?.classList.remove('show');
          startBtn.disabled = false;
        }
      });
    }

    // تشغيل
    document.addEventListener('DOMContentLoaded', ()=>{
      try{
        // ✅ حذف التلميح من التخزين عند كل تحميل للصفحة
        localStorage.removeItem('sand_support_tip_seen');
        // لو كان المستخدم قد دخل سابقاً (مستقبلاً يمكن استخدام تخزين آمن)
        // حالياً نبدأ من شاشة المقدمة
        startApp();
      }catch(e){
        console.error(e);
      }
    });
  </script>
</body>
</html>
